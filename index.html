<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bulijiojio Blog">
<meta property="og:url" content="https://example.com/index.html">
<meta property="og:site_name" content="Bulijiojio Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="YXY">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Bulijiojio Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bulijiojio Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">日常摸鱼划水的虾皮--如果公式不能正常显示请使用Chrome浏览器并安装Tex All the Things插件</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/09/06/xWRnote/mmWave_Tutorial6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/06/xWRnote/mmWave_Tutorial6/" class="post-title-link" itemprop="url">mmWave_Tutorial6-mmWave原始数据获取</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-06 00:27:40" itemprop="dateCreated datePublished" datetime="2021-09-06T00:27:40+08:00">2021-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-24 13:12:51" itemprop="dateModified" datetime="2021-09-24T13:12:51+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TI-project/" itemprop="url" rel="index"><span itemprop="name">TI project</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在之前的5篇博客中我们介绍了, TI out of box demo, Ti 3D people counting demo 以及使用他们的数据进行的目标跟踪与航迹管理, 还有TI out of box demo的源码程序, 那按照理论上来说, 我们其实就可以在CCS中对mmWave SoC 进行编程从而实现我们自己所设计的信号处理流程, 通过直接去写C语言来对 ARM 和 DSP 编程的方式需要比较长的时间, 而在进行算法验证的初期我们更多是使用 Matlab, Python 等一些高级语言进行算法验证, 在性能达到我们预期的情况下, 我们才会考虑将这样的算法移植到SOC的平台中, 这样能够为我们的开发节省出很多的时间. </p>
<p>Ti 官方已经提供了 mmWaveStudio 这样的工具, 在搭配 iwr设备, mmWave ICBoost承载板卡, DCA1000数据采集办卡后, 我们可以通过LVDS获得雷达各个接收通道的中频信号(也可以叫差拍信号). 使用 mmWaveStudio 工具进行原始数据获取TI官方给了非常详尽的文档, 如果还没有使用过 mmWaveStudio 的读者, 请先使用官方方式进行数据采集然后再来参考本篇博客 </p>
<blockquote>
<p>/ti/mmwave_studio_02_01_01_00/docs/mmwave_studio_user_guide.pdf</p>
</blockquote>
<p>在这篇博客当中, 我将介绍如何使用 python 脚本对 mmWave radar 的原始数据进行获取.</p>
<h1 id="DCA1000EVM-Overview"><a href="#DCA1000EVM-Overview" class="headerlink" title="DCA1000EVM Overview"></a>DCA1000EVM Overview</h1><h1 id="硬件连接"><a href="#硬件连接" class="headerlink" title="硬件连接"></a>硬件连接</h1><p><img src="/2021/09/06/xWRnote/mmWave_Tutorial6/hardware_setup.jpg" alt></p>
<h1 id="相关代码-python"><a href="#相关代码-python" class="headerlink" title="相关代码(python)"></a>相关代码(python)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Copyright 2019 The OpenRadar Authors. All Rights Reserved.</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> serial</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># import pyqtgraph as pg</span></span><br><span class="line"><span class="comment"># from mpl_toolkits.mplot3d import Axes3D</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="comment"># from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas</span></span><br><span class="line"><span class="comment"># from matplotlib.figure import Figure</span></span><br><span class="line"><span class="comment"># from matplotlib.lines import Line2D</span></span><br><span class="line"><span class="comment"># import matplotlib.cbook as cbook</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">configFileName = <span class="string">&quot;IWR6843_cfg.cfg&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CMD</span>(<span class="params">Enum</span>):</span></span><br><span class="line">    RESET_FPGA_CMD_CODE = <span class="string">&#x27;0100&#x27;</span></span><br><span class="line">    RESET_AR_DEV_CMD_CODE = <span class="string">&#x27;0200&#x27;</span></span><br><span class="line">    CONFIG_FPGA_GEN_CMD_CODE = <span class="string">&#x27;0300&#x27;</span></span><br><span class="line">    CONFIG_EEPROM_CMD_CODE = <span class="string">&#x27;0400&#x27;</span></span><br><span class="line">    RECORD_START_CMD_CODE = <span class="string">&#x27;0500&#x27;</span></span><br><span class="line">    RECORD_STOP_CMD_CODE = <span class="string">&#x27;0600&#x27;</span></span><br><span class="line">    PLAYBACK_START_CMD_CODE = <span class="string">&#x27;0700&#x27;</span></span><br><span class="line">    PLAYBACK_STOP_CMD_CODE = <span class="string">&#x27;0800&#x27;</span></span><br><span class="line">    SYSTEM_CONNECT_CMD_CODE = <span class="string">&#x27;0900&#x27;</span></span><br><span class="line">    SYSTEM_ERROR_CMD_CODE = <span class="string">&#x27;0a00&#x27;</span></span><br><span class="line">    CONFIG_PACKET_DATA_CMD_CODE = <span class="string">&#x27;0b00&#x27;</span></span><br><span class="line">    CONFIG_DATA_MODE_AR_DEV_CMD_CODE = <span class="string">&#x27;0c00&#x27;</span></span><br><span class="line">    INIT_FPGA_PLAYBACK_CMD_CODE = <span class="string">&#x27;0d00&#x27;</span></span><br><span class="line">    READ_FPGA_VERSION_CMD_CODE = <span class="string">&#x27;0e00&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MESSAGE = codecs.decode(b&#x27;5aa509000000aaee&#x27;, &#x27;hex&#x27;)</span></span><br><span class="line">CONFIG_HEADER = <span class="string">&#x27;5aa5&#x27;</span></span><br><span class="line">CONFIG_STATUS = <span class="string">&#x27;0000&#x27;</span></span><br><span class="line">CONFIG_FOOTER = <span class="string">&#x27;aaee&#x27;</span></span><br><span class="line">ADC_PARAMS = &#123;</span><br><span class="line">    <span class="string">&#x27;chirps&#x27;</span>: <span class="number">96</span>,</span><br><span class="line">    <span class="string">&#x27;rx&#x27;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">&#x27;tx&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&#x27;samples&#x27;</span>: <span class="number">96</span>,</span><br><span class="line">    <span class="string">&#x27;IQ&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&#x27;bytes&#x27;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># STATIC</span></span><br><span class="line">MAX_PACKET_SIZE = <span class="number">2097152</span></span><br><span class="line"><span class="comment"># 默认数据包长度</span></span><br><span class="line">BYTES_IN_PACKET = <span class="number">1456</span></span><br><span class="line"><span class="comment"># DYNAMIC</span></span><br><span class="line">BYTES_IN_FRAME = (ADC_PARAMS[<span class="string">&#x27;chirps&#x27;</span>] * ADC_PARAMS[<span class="string">&#x27;rx&#x27;</span>] * ADC_PARAMS[<span class="string">&#x27;tx&#x27;</span>] *</span><br><span class="line">                  ADC_PARAMS[<span class="string">&#x27;IQ&#x27;</span>] * ADC_PARAMS[<span class="string">&#x27;samples&#x27;</span>] *</span><br><span class="line">                  ADC_PARAMS[<span class="string">&#x27;bytes&#x27;</span>])</span><br><span class="line">BYTES_IN_FRAME_CLIPPED = (BYTES_IN_FRAME // BYTES_IN_PACKET) * BYTES_IN_PACKET</span><br><span class="line">PACKETS_IN_FRAME = BYTES_IN_FRAME / BYTES_IN_PACKET</span><br><span class="line">PACKETS_IN_FRAME_CLIPPED = BYTES_IN_FRAME // BYTES_IN_PACKET</span><br><span class="line">UINT16_IN_PACKET = BYTES_IN_PACKET // <span class="number">2</span></span><br><span class="line">UINT16_IN_FRAME = BYTES_IN_FRAME // <span class="number">2</span></span><br><span class="line"><span class="comment"># a = []</span></span><br><span class="line"><span class="comment"># b = []</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DCA1000</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Software interface to the DCA1000 EVM board via ethernet.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Attributes:</span></span><br><span class="line"><span class="string">        static_ip (str): IP to receive data from the FPGA</span></span><br><span class="line"><span class="string">        adc_ip (str): IP to send configuration commands to the FPGA</span></span><br><span class="line"><span class="string">        data_port (int): Port that the FPGA is using to send data</span></span><br><span class="line"><span class="string">        config_port (int): Port that the FPGA is using to read configuration commands from</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    General steps are as follows:</span></span><br><span class="line"><span class="string">        1. Power cycle DCA1000 and XWR1xxx sensor</span></span><br><span class="line"><span class="string">        2. Open mmWaveStudio and setup normally until tab SensorConfig or use lua script</span></span><br><span class="line"><span class="string">        3. Make sure to connect mmWaveStudio to the board via ethernet</span></span><br><span class="line"><span class="string">        4. Start streaming data</span></span><br><span class="line"><span class="string">        5. Read in frames using class</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Examples:</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; dca = DCA1000()</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; adc_data = dca.read(timeout=.1)</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; frame = dca.organize(adc_data, 128, 4, 256)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="function"><span class="params">                 configfilename,</span></span></span><br><span class="line"><span class="function"><span class="params">                 static_ip=<span class="string">&#x27;192.168.33.30&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 adc_ip=<span class="string">&#x27;192.168.33.180&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 data_port=<span class="number">4098</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 config_port=<span class="number">4096</span></span>):</span></span><br><span class="line">        <span class="comment"># Save network data</span></span><br><span class="line">        <span class="comment"># self.static_ip = static_ip</span></span><br><span class="line">        <span class="comment"># self.adc_ip = adc_ip</span></span><br><span class="line">        <span class="comment"># self.data_port = data_port</span></span><br><span class="line">        <span class="comment"># self.config_port = config_port</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create configuration and data destinations</span></span><br><span class="line">        self.cfg_dest = (adc_ip, config_port)</span><br><span class="line">        self.cfg_recv = (static_ip, config_port)</span><br><span class="line">        self.data_recv = (static_ip, data_port)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create sockets</span></span><br><span class="line">        self.config_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM,</span><br><span class="line">                                           socket.IPPROTO_UDP)</span><br><span class="line">        self.data_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM,</span><br><span class="line">                                         socket.IPPROTO_UDP)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Bind data socket to fpga</span></span><br><span class="line">        self.data_socket.bind(self.data_recv)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Bind config socket to fpga</span></span><br><span class="line">        self.config_socket.bind(self.cfg_recv)</span><br><span class="line"></span><br><span class="line">        self.CLIport = serial.Serial(<span class="string">&#x27;COM7&#x27;</span>, <span class="number">115200</span>)</span><br><span class="line">        self.Dataport = serial.Serial(<span class="string">&#x27;COM8&#x27;</span>, <span class="number">921600</span>)</span><br><span class="line"></span><br><span class="line">        self.CfgFilename = configfilename</span><br><span class="line"></span><br><span class="line">        self.data = []</span><br><span class="line">        self.packet_count = []</span><br><span class="line">        self.byte_count = []</span><br><span class="line"></span><br><span class="line">        self.frame_buff = []</span><br><span class="line"></span><br><span class="line">        self.curr_buff = <span class="literal">None</span></span><br><span class="line">        self.last_frame = <span class="literal">None</span></span><br><span class="line">        self.lost_packets = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_serialConfig</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Raspberry pi</span></span><br><span class="line">        <span class="comment"># CLIport = serial.Serial(&#x27;/dev/ttyACM0&#x27;, 115200)</span></span><br><span class="line">        <span class="comment"># Dataport = serial.Serial(&#x27;/dev/ttyACM1&#x27;, 921600)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Windows</span></span><br><span class="line">        <span class="comment"># self.CLIport = serial.Serial(&#x27;COM11&#x27;, 115200)</span></span><br><span class="line">        <span class="comment"># self.Dataport = serial.Serial(&#x27;COM12&#x27;, 921600)</span></span><br><span class="line"></span><br><span class="line">        config = [line.rstrip(<span class="string">&#x27;\r\n&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(self.CfgFilename)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> config:</span><br><span class="line">            <span class="keyword">if</span> i == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> i[<span class="number">0</span>] == <span class="string">&quot;#&quot;</span> <span class="keyword">or</span> i[<span class="number">0</span>] == <span class="string">&quot;%&quot;</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            self.CLIport.write((i + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;sent-&gt;&#x27;</span> + i)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            reply = self.CLIport.read(self.CLIport.in_waiting).decode()</span><br><span class="line">            <span class="built_in">print</span>(reply)</span><br><span class="line">        <span class="keyword">return</span> self.CLIport, self.Dataport</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_sensor_start</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.CLIport.write(<span class="string">&quot;sensorStart\n&quot;</span>.encode())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;sent-&gt;&quot;</span> + <span class="string">&quot;sensorStart&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        reply = self.CLIport.read(self.CLIport.in_waiting).decode()</span><br><span class="line">        <span class="built_in">print</span>(reply)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_sensor_stop</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.CLIport.write(<span class="string">&quot;sensorStop\n&quot;</span>.encode())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;sent-&gt;&quot;</span> + <span class="string">&quot;sensorStop&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        reply = self.CLIport.read(self.CLIport.in_waiting).decode()</span><br><span class="line">        <span class="built_in">print</span>(reply)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># RECORD_START_CMD_CODE</span></span><br><span class="line">        <span class="comment"># 5a a5 05 00 00 00 aa ee</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&gt;网口发送记录开始指令：\n&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            self._send_command(CMD.RECORD_START_CMD_CODE)))</span><br><span class="line">        self._sensor_start()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;commands send -&gt; Start &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span>(<span class="params">self</span>):</span></span><br><span class="line">        self._sensor_stop()</span><br><span class="line">        <span class="comment"># RECORD_START_CMD_CODE</span></span><br><span class="line">        <span class="comment"># 5a a5 06 00 00 00 aa ee</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&gt;网口发送记录终止指令：\n&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            self._send_command(CMD.RECORD_STOP_CMD_CODE)))</span><br><span class="line">        self._close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_close</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># self.data_socket.close()</span></span><br><span class="line">        self.config_socket.close()</span><br><span class="line">        self.CLIport.close()</span><br><span class="line">        self.Dataport.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">configure</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># # SYSTEM_CONNECT_CMD_CODE</span></span><br><span class="line">        <span class="comment"># # 5a a5 09 00 00 00 aa ee</span></span><br><span class="line">        <span class="comment"># print(&quot;-&gt;连接确认:&quot;)</span></span><br><span class="line">        <span class="comment"># print(&quot;&#123;&#125;&quot;.format(self.send_command(CMD.SYSTEM_CONNECT_CMD_CODE)))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># CONFIG_FPGA_GEN_CMD_CODE</span></span><br><span class="line">        <span class="comment"># 5a a5 01 00 00 00 aa ee</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&gt;重置FPGA：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self._send_command(CMD.RESET_FPGA_CMD_CODE)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># CONFIG_FPGA_GEN_CMD_CODE</span></span><br><span class="line">        <span class="comment"># 5a a5 02 00 00 00 aa ee</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&gt;重置AR：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self._send_command(CMD.RESET_AR_DEV_CMD_CODE)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># CONFIG_FPGA_GEN_CMD_CODE</span></span><br><span class="line">        <span class="comment"># 5a a5 03 00 06 00 01 02 01 02 03 1e aa ee</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&gt;配置FPGA：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            self._send_command(CMD.CONFIG_FPGA_GEN_CMD_CODE, <span class="string">&#x27;0600&#x27;</span>,</span><br><span class="line">                               <span class="string">&#x27;01020102031e&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># CONFIG_PACKET_DATA_CMD_CODE</span></span><br><span class="line">        <span class="comment"># 5a a5 0b 00 06 00 be 05 35 0c 00 00 aa ee</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&gt;配置PACKET：&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            self._send_command(CMD.CONFIG_PACKET_DATA_CMD_CODE, <span class="string">&#x27;0600&#x27;</span>,</span><br><span class="line">                               <span class="string">&#x27;c005350c0000&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # READ_FPGA_VERSION_CMD_CODE</span></span><br><span class="line">        <span class="comment"># # 5a a5 0e 00 00 00 aa ee</span></span><br><span class="line">        <span class="comment"># print(&quot;-&gt;读取FPGA版本：&quot;)</span></span><br><span class="line">        <span class="comment"># print(&quot;&#123;&#125;&quot;.format(self.send_command_web(CMD.READ_FPGA_VERSION_CMD_CODE)))</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Closes the sockets that are used for receiving and sending data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.data_socket.close()</span><br><span class="line">        self.config_socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">self, timeout=<span class="number">1</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot; Read in a single packet via UDP</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            timeout (float): Time to wait for packet before moving on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Full frame as array if successful, else None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Configure</span></span><br><span class="line"></span><br><span class="line">        self.data_socket.settimeout(timeout)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Frame buffer</span></span><br><span class="line">        ret_frame = np.zeros(UINT16_IN_FRAME, dtype=np.int16)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Wait for start of next frame</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            packet_num, byte_count, packet_data = self._read_data_packet()</span><br><span class="line">            <span class="comment"># a.append(packet_num) # 获取包数组</span></span><br><span class="line">            <span class="comment"># print(packet_num,byte_count)</span></span><br><span class="line">            <span class="keyword">if</span> (packet_num - <span class="number">1</span>) % PACKETS_IN_FRAME_CLIPPED == <span class="number">0</span>:</span><br><span class="line">                packets_read = <span class="number">1</span></span><br><span class="line">                ret_frame[<span class="number">0</span>:UINT16_IN_PACKET] = packet_data</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read in the rest of the frame</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            packet_num, byte_count, packet_data = self._read_data_packet()</span><br><span class="line">            <span class="comment"># print(packet_num,byte_count)</span></span><br><span class="line">            <span class="comment"># b.append(packet_num) # 获取包数组</span></span><br><span class="line">            packets_read += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> (packet_num - <span class="number">1</span>) % PACKETS_IN_FRAME_CLIPPED == <span class="number">0</span>:</span><br><span class="line">                self.lost_packets = PACKETS_IN_FRAME_CLIPPED - packets_read</span><br><span class="line">                <span class="comment"># 返回-1 基本不丢包</span></span><br><span class="line">                <span class="comment"># print(&quot;lost_packets:%d&quot; %self.lost_packets)</span></span><br><span class="line">                <span class="keyword">return</span> ret_frame</span><br><span class="line"></span><br><span class="line">            curr_idx = ((packet_num - <span class="number">1</span>) % PACKETS_IN_FRAME_CLIPPED)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ret_frame[curr_idx * UINT16_IN_PACKET:(curr_idx + <span class="number">1</span>) *</span><br><span class="line">                          UINT16_IN_PACKET] = packet_data</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> packets_read &gt; PACKETS_IN_FRAME_CLIPPED:</span><br><span class="line">                packets_read = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_send_command</span>(<span class="params">self, cmd, length=<span class="string">&#x27;0000&#x27;</span>, body=<span class="string">&#x27;&#x27;</span>, timeout=<span class="number">1</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Helper function to send a single commmand to the FPGA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            cmd (CMD): Command code to send to the FPGA</span></span><br><span class="line"><span class="string">            length (str): Length of the body of the command (if any)</span></span><br><span class="line"><span class="string">            body (str): Body information of the command</span></span><br><span class="line"><span class="string">            timeout (int): Time in seconds to wait for socket data until timeout</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            str: Response message</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Create timeout exception</span></span><br><span class="line">        self.config_socket.settimeout(timeout)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create and send message</span></span><br><span class="line">        resp = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        msg = codecs.decode(</span><br><span class="line">            <span class="string">&#x27;&#x27;</span>.join((CONFIG_HEADER, <span class="built_in">str</span>(cmd), length, body, CONFIG_FOOTER)),</span><br><span class="line">            <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.config_socket.sendto(msg, self.cfg_dest)</span><br><span class="line">            resp, addr = self.config_socket.recvfrom(MAX_PACKET_SIZE)</span><br><span class="line">        <span class="keyword">except</span> socket.timeout <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_read_data_packet</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Helper function to read in a single ADC packet via UDP</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">           int: Current packet number, byte count of data that has already been read, raw ADC data in current packet</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        data, addr = self.data_socket.recvfrom(MAX_PACKET_SIZE)</span><br><span class="line">        packet_num = struct.unpack(<span class="string">&#x27;&lt;1l&#x27;</span>, data[:<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        byte_count = struct.unpack(<span class="string">&#x27;&gt;Q&#x27;</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> + data[<span class="number">4</span>:<span class="number">10</span>][::-<span class="number">1</span>])[<span class="number">0</span>]</span><br><span class="line">        packet_data = np.frombuffer(data[<span class="number">10</span>:], dtype=np.int16)</span><br><span class="line">        <span class="keyword">return</span> packet_num, byte_count, packet_data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_listen_for_error</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Helper function to try and read in for an error message from the FPGA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.config_socket.settimeout(<span class="literal">None</span>)</span><br><span class="line">        msg = self.config_socket.recvfrom(MAX_PACKET_SIZE)</span><br><span class="line">        <span class="keyword">if</span> msg == <span class="string">b&#x27;5aa50a000300aaee&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;stopped:&#x27;</span>, msg)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_stop_stream</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Helper function to send the stop command to the FPGA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            str: Response Message</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self._send_command(CMD.RECORD_STOP_CMD_CODE)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">organize</span>(<span class="params">raw_frame, num_chirps, num_rx, num_samples</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Reorganizes raw ADC data into a full frame</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            raw_frame (ndarray): Data to format</span></span><br><span class="line"><span class="string">            num_chirps: Number of chirps included in the frame</span></span><br><span class="line"><span class="string">            num_rx: Number of receivers used in the frame</span></span><br><span class="line"><span class="string">            num_samples: Number of ADC samples included in each chirp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            ndarray: Reformatted frame of raw data of shape (num_chirps, num_rx, num_samples)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ret = np.zeros(len(raw_frame) // 2, dtype=complex)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># # Separate IQ data</span></span><br><span class="line">        <span class="comment"># ret[0::2] = raw_frame[0::4] + 1j * raw_frame[2::4]</span></span><br><span class="line">        <span class="comment"># ret[1::2] = raw_frame[1::4] + 1j * raw_frame[3::4]</span></span><br><span class="line">        <span class="comment"># return ret.reshape((num_chirps, num_rx, num_samples))</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        sampleI = np.zeros(<span class="built_in">len</span>(raw_frame) // <span class="number">2</span>, dtype=<span class="built_in">complex</span>)</span><br><span class="line">        sampleQ = np.zeros(<span class="built_in">len</span>(raw_frame) // <span class="number">2</span>, dtype=<span class="built_in">complex</span>)</span><br><span class="line">        </span><br><span class="line">        sampleI[<span class="number">0</span>::<span class="number">2</span>] = raw_frame[<span class="number">0</span>::<span class="number">4</span>]</span><br><span class="line">        sampleI[<span class="number">1</span>::<span class="number">2</span>] = raw_frame[<span class="number">1</span>::<span class="number">4</span>]</span><br><span class="line">        sampleQ[<span class="number">0</span>::<span class="number">2</span>] = raw_frame[<span class="number">2</span>::<span class="number">4</span>]</span><br><span class="line">        sampleQ[<span class="number">1</span>::<span class="number">2</span>] = raw_frame[<span class="number">3</span>::<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">        sample = sampleQ  + <span class="number">1j</span> * sampleI </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sample.reshape((num_chirps, num_rx, num_samples))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mmwave.dsp <span class="keyword">as</span> dsp</span><br><span class="line"><span class="keyword">import</span> mmwave.clustering <span class="keyword">as</span> clu</span><br><span class="line"><span class="keyword">from</span> demo.visualizer <span class="keyword">import</span> ellipse_visualize</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    DCA = DCA1000(configFileName)</span><br><span class="line">    DCA.configure()</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    DCA._serialConfig()</span><br><span class="line">    DCA.start()</span><br><span class="line">    fig = plt.figure()</span><br><span class="line"></span><br><span class="line">    numADCSamples = <span class="number">96</span></span><br><span class="line">    numTxAntennas = <span class="number">3</span></span><br><span class="line">    numRxAntennas = <span class="number">4</span></span><br><span class="line">    numLoopsPerFrame = <span class="number">96</span></span><br><span class="line">    numChirpsPerFrame = numTxAntennas * numLoopsPerFrame</span><br><span class="line"></span><br><span class="line">    numRangeBins = numADCSamples</span><br><span class="line">    numDopplerBins = numLoopsPerFrame</span><br><span class="line">    numAngleBins = <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    range_resolution, bandwidth = dsp.range_resolution(numADCSamples)</span><br><span class="line">    doppler_resolution = dsp.doppler_resolution(bandwidth)</span><br><span class="line"></span><br><span class="line">    plotRangeDopp = <span class="literal">False</span>  </span><br><span class="line">    plot2DscatterXY = <span class="literal">True</span>  </span><br><span class="line">    plot2DscatterXZ = <span class="literal">False</span>  </span><br><span class="line">    plot3Dscatter = <span class="literal">False</span>  </span><br><span class="line">    plotCustomPlt = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    visTrigger = plot2DscatterXY + plot2DscatterXZ + plot3Dscatter + plotRangeDopp + plotCustomPlt</span><br><span class="line">    <span class="keyword">assert</span> visTrigger &lt; <span class="number">2</span>, <span class="string">&quot;Can only choose to plot one type of plot at once&quot;</span></span><br><span class="line"></span><br><span class="line">    singFrameView = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># (1.5) Required Plot Declarations</span></span><br><span class="line">    <span class="comment"># if plot2DscatterXY or plot2DscatterXZ:</span></span><br><span class="line">    <span class="comment">#     fig, axes = plt.subplots(1, 2)</span></span><br><span class="line">    <span class="comment"># elif plot3Dscatter:</span></span><br><span class="line">    <span class="comment">#     fig = plt.figure()</span></span><br><span class="line">    <span class="comment"># elif plotRangeDopp:</span></span><br><span class="line">    <span class="comment">#     fig = plt.figure()</span></span><br><span class="line">    <span class="comment"># elif plotCustomPlt:</span></span><br><span class="line">    <span class="comment">#     print(&quot;Using Custom Plotting&quot;)</span></span><br><span class="line"></span><br><span class="line">    rx_index = [<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">11</span>,<span class="number">9</span>,<span class="number">7</span>,<span class="number">5</span>,<span class="number">10</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">4</span>];</span><br><span class="line">    sensor_number=<span class="number">12</span>;</span><br><span class="line">    sensor_array = np.array([[<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>],[<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>],[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    frame = np.zeros((<span class="number">100</span>,<span class="number">96</span>,<span class="number">12</span>,<span class="number">96</span>),dtype=<span class="built_in">complex</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># (1) Reading in adc data</span></span><br><span class="line">            <span class="comment"># start0 = time.time()</span></span><br><span class="line">            adc_data = DCA.read(timeout=<span class="number">.5</span>)</span><br><span class="line">            <span class="comment"># DCA.organize基本不占用时间</span></span><br><span class="line">            frame[index] = DCA.organize(adc_data, ADC_PARAMS[<span class="string">&#x27;chirps&#x27;</span>],ADC_PARAMS[<span class="string">&#x27;rx&#x27;</span>] * ADC_PARAMS[<span class="string">&#x27;tx&#x27;</span>],ADC_PARAMS[<span class="string">&#x27;samples&#x27;</span>])</span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">99</span>:</span><br><span class="line">                <span class="keyword">import</span> scipy.io <span class="keyword">as</span> io</span><br><span class="line">                mat_path = <span class="string">&#x27;rx.mat&#x27;</span></span><br><span class="line">                io.savemat(mat_path, &#123;<span class="string">&#x27;rx&#x27;</span>: frame&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                index = index + <span class="number">1</span></span><br><span class="line">            <span class="comment"># end0 = time.time()</span></span><br><span class="line">            <span class="comment"># print(&#x27;capture data is :%s seconds&#x27;%(end0 - start0))</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;结束！&quot;</span>)</span><br><span class="line">            DCA.stop()</span><br><span class="line">            plt.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    plt.show()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/09/05/xWRnote/mmWave_Tutorial5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/05/xWRnote/mmWave_Tutorial5/" class="post-title-link" itemprop="url">mmWave_Tutorial5-源码走读mmWave Out of box demo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-05 00:27:40" itemprop="dateCreated datePublished" datetime="2021-09-05T00:27:40+08:00">2021-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-24 12:43:14" itemprop="dateModified" datetime="2021-09-24T12:43:14+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TI-project/" itemprop="url" rel="index"><span itemprop="name">TI project</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写在最前面, 如果博客内容与实际TI文档有任何出入,请以TI官方文档为准.</p>
<p>在上一篇博客中我们宏观的介绍了整个系统的硬件架构以及展示出了一副大的程序执行框图, 在这篇博客中我们将沿着系统软件执行流程, 走马观花式的介绍整个 mmWave Out of box demo 源码, 源码的代码极其的庞大, 同时这样一份系统性的代码阅读下来他的附加价值是很高的. 因为这篇博客介绍软件源码是走马观花式的, 所以强烈建议读者抽出时间仔细的研读源码, 对整个源码进行系统性的梳理以及细节的挖掘, 建议用时在<strong>15天</strong>左右. 这篇博客中我所给出的一些软件执行的框图也是在阅读源码的过程中进行整理的. </p>
<h1 id="阅读思路"><a href="#阅读思路" class="headerlink" title="阅读思路"></a>阅读思路</h1><p>由于demo的源码非常的庞大, 我们需要对它进行宏观把握的前提下进行阅读, 在我进行源码结构梳理的时候我喜欢用一些显著的时间节点来进行分割, 比如 当我在CLI port进行配置时 demo的程序进行了如何的调用, 我在CLI port 发送 sensor start 的时候 demo程序中发生了什么, ARM端发送了什么样的信息告知DSP进行信号处理, DSP 如何将已经处理好的点云数据传送至ARM端等等. 同时在进行源码结构梳理的时候通过对源码进行功能划分, 是最直观且高效的结构梳理方法, Demo中的 功能区划主要有如下的几个:</p>
<ol>
<li>CLI: 负责与用户的信息交互 如配置, sensor的控制等</li>
<li>MMWave: 与 DFE 进行控制信息交换等. </li>
<li>DPC(DSP): Data process control 用于控制DSP端的信号处理和控制组件</li>
<li>DPC(HWA): 用于控制arm端 hardware  accelerator 的信号处理和控制组件 </li>
<li>DPM: data path manager, 顾名思义 就是在 MSS 和 DSS 中负责数据传输的管理组件</li>
<li>Demo Misc:  负责 demo 中各各种为了使程序能够正常运行的中间组件比如协调控制, 信息交互等等. </li>
</ol>
<p>在进行源码梳理的时候我们将围绕着 MSS 和 DSS 这两个相对独立的子系统上运行的程序展开, 同时在本篇博客中给出的软件执行框图中每一部软件执行的步骤都将使用在源码中的函数名进行表示.</p>
<p>下图展示了一个完整的代码结构整理, 他以上一章最后提到的系统执行流程为中心, 以 MSS和 DSS 两条线索分别展开.<br><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/big_picture.png" alt></p>
<h1 id="源码走读"><a href="#源码走读" class="headerlink" title="源码走读"></a>源码走读</h1><p>在代码执行初期 MSS 和 DSS 分别执行他们的初始化任务. </p>
<h2 id="MSS初始化"><a href="#MSS初始化" class="headerlink" title="MSS初始化"></a>MSS初始化</h2><p><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/mss.png" alt></p>
<h2 id="DSS初始化"><a href="#DSS初始化" class="headerlink" title="DSS初始化"></a>DSS初始化</h2><p><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/dss.png" alt></p>
<h2 id="当MSS在串口收到Cfar配置信息或者Profile配置信息时"><a href="#当MSS在串口收到Cfar配置信息或者Profile配置信息时" class="headerlink" title="当MSS在串口收到Cfar配置信息或者Profile配置信息时"></a>当MSS在串口收到Cfar配置信息或者Profile配置信息时</h2><p><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/cfarCfgCLIcommond.png" alt><br><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/profileCfgCLIcommond.png" alt></p>
<h2 id="当MSS在串口收到sensor-start指令时"><a href="#当MSS在串口收到sensor-start指令时" class="headerlink" title="当MSS在串口收到sensor start指令时"></a>当MSS在串口收到sensor start指令时</h2><p><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/sensorStartCfgCLIcommond.png" alt><br><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/MmwDemo_configSensor.png" alt><br><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/mmw_config.png" alt><br><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/MmwDemo_startSensor.png" alt></p>
<h2 id="当DSS从MSS那里得到DPM-start的消息后"><a href="#当DSS从MSS那里得到DPM-start的消息后" class="headerlink" title="当DSS从MSS那里得到DPM start的消息后"></a>当DSS从MSS那里得到DPM start的消息后</h2><p>同时会向MSS端报告DPC_STARTED, MSS在得到DSS端DPC_STARTED的消息后会在CLI port打印 Done 的消息<br><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/DSSgetDPMstart.png" alt><br>之后DSS的HWA和DSS就会等待DFE的数据</p>
<h2 id="当Frame-Event的硬件中断到来-表明当前的Frame已经开始了"><a href="#当Frame-Event的硬件中断到来-表明当前的Frame已经开始了" class="headerlink" title="当Frame Event的硬件中断到来, 表明当前的Frame已经开始了"></a>当Frame Event的硬件中断到来, 表明当前的Frame已经开始了</h2><p><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/event.png" alt></p>
<h2 id="在Frame结束后的后处理-如数据传输等"><a href="#在Frame结束后的后处理-如数据传输等" class="headerlink" title="在Frame结束后的后处理,如数据传输等"></a>在Frame结束后的后处理,如数据传输等</h2><p><img src="/2021/09/05/xWRnote/mmWave_Tutorial5/postframeEvent.png" alt></p>
<h1 id="相关代码-plantuml"><a href="#相关代码-plantuml" class="headerlink" title="相关代码(plantuml)"></a>相关代码(plantuml)</h1><p>为了方便 大家在自行整理源码结构, 以上软件流程框图的 plantuml 源码已经上传至github读者可以自行下载</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Mr-Bulijiojio/NotesTIproject">https://github.com/Mr-Bulijiojio/NotesTIproject</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/09/04/xWRnote/mmWave_Tutorial4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/04/xWRnote/mmWave_Tutorial4/" class="post-title-link" itemprop="url">mmWave_Tutorial4-初尝mmWave Out of box demo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-04 00:27:40" itemprop="dateCreated datePublished" datetime="2021-09-04T00:27:40+08:00">2021-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-24 09:41:06" itemprop="dateModified" datetime="2021-09-24T09:41:06+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TI-project/" itemprop="url" rel="index"><span itemprop="name">TI project</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写在最前面, 如果博客内容与实际TI文档有任何出入,请以TI官方文档为准.</p>
<p>在前几个mmWave_Tutorial的博客中我们讲的关于TI out box demo, Ti 3D people counting demo 以及使用他们的数据进行的目标跟踪与航迹管理, 那读者们就很容易好奇在mmWave SoC 里面真正进行了怎样的处理,它的程序又是怎样编写的呢? 从本篇博客开始我们将一步一步的去了解 ti out of box demo 中的一些细节,我们将首先从整个软件的架构开始讲起同时也会结合相应的硬件结构进行讲述, 这个部分中如果读者有兴趣, 我强烈建议读者去自行阅读如下所示ti官方的文档  </p>
<blockquote>
<p>ti/mmwave_sdk_03_04_00_03/packages/ti/demo/xwr68xx/mmw/docs/doxygen/html/index.html</p>
</blockquote>
<h1 id="Hardware-System-Overview"><a href="#Hardware-System-Overview" class="headerlink" title="Hardware System Overview"></a>Hardware System Overview</h1><p>TI out box demo运行在mmWave SoC上, 要去理解一个软件架构是如何工作的首先就需要去了解支持这个软件运行的硬件架构是怎样, 如下图<br><img src="/2021/09/04/xWRnote/mmWave_Tutorial4/hardware_architecture.gif" alt><br>我们可以看到, 整个mmWave SoC系统由4个子系统构成</p>
<ol>
<li>RF/Analogy sub-system: 主要负责发射射频链路的信号合成, 移相以及功率放大, 接收射频链路的低噪声放大, 相干接收(混频,滤波)等等, 是TI MMIC的核心技术 </li>
<li>Radio processor sub-system: 主要负责后端的数字下变频(DDC), 相位矫正等等功能, 与射频前端的组合成一个由TI预programmed的blackbox, 也只对外部系统提供API</li>
<li>Main sub-system: 由一个arm cortex R4F内核以及相应的数字系统构成(如总线, 硬件加速器(硬核), 数字外设等等), 主要负责系统的控制, 部分信号处理和与外部的交互等等</li>
<li>DSP sub-system: 由一个C674x DSP大核和周边数字系统构成, 承担了系统大部分的信号处理工作, 同时也控制了由DFE来的数据通过LVDS向外传输的过程(DFE的数据会直接送入DSP的L3 Cache中).</li>
</ol>
<p>mmWave雷达的控制和信号处理任务是分散在一个芯片上的各个不同子系统上的, 而我们在进行软件设计时往往需要设计一个统一的执行框架, 使得不同子系统的信息能够高效的交互, 那么ti的工程师在设计相关的软件时也始终贯彻这个理念. 对于我们这样的用户来说我们真正需要关心的是在ti进行芯片设计时预留出了哪些用户可以编程的部分, 答案当然是ARM和DSP, TI也提供了一套完整的系统执行框架-实时嵌入式操作系统SYSBIOS, 熟悉嵌入式操作系统的读者应该对于这个不会感到陌生, 而且ti官方也提供给我们了丰富的外设驱动程序, 只要在进行程序设计时, 能够正确的处理不同线程间的信号量, mmWave SoC系统开发人员就能够实现大部分的功能. 有了多个异构运算核心的统一的执行框架, 那么ARM和DSP之间信息如何交互呢, 在上图中我们可以看到Bus Matrix 和 Mailbox, 他们就是信息交互的硬件基础. </p>
<h1 id="Software-System-Overview"><a href="#Software-System-Overview" class="headerlink" title="Software System Overview"></a>Software System Overview</h1><p>下图显示了系统执行流程, 这幅图又大又长, 笔者在看到这幅图也是懵逼的但是我将在接下来的一篇博客中带着大家一起简单的过一遍这幅图. 在这里需要从这幅图中先粗略的get到一些上文中提到的概念的映射, 比如BSS代表RF/Analogy sub-system和Radio processor sub-system, MSS代表Main sub-system, BSS 代表 DSP sub-system. ARM和DSP即MSS 和 DSS 的线程间通信 IPC在图中的表示等等<br><img src="/2021/09/04/xWRnote/mmWave_Tutorial4/system_flow.png" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/09/03/xWRnote/mmWave_Tutorial3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/03/xWRnote/mmWave_Tutorial3/" class="post-title-link" itemprop="url">mmWave_Tutorial3-快速上手Target tracking and management</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-03 00:27:40" itemprop="dateCreated datePublished" datetime="2021-09-03T00:27:40+08:00">2021-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-23 23:17:19" itemprop="dateModified" datetime="2021-09-23T23:17:19+08:00">2021-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TI-project/" itemprop="url" rel="index"><span itemprop="name">TI project</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在前两个 tutorial 中我们通过编写脚本程序的方法得到了毫米波雷达输出的点云数据, 并进行了相关的数据可视化工作, 在这一篇博客当中我们将通过之前得到的毫米波雷达输出的点云, 进行人员的检测跟踪以及航迹的管理, 到这里读者可能会问了既然在ti官方的demo中已经给出了 gtrack相应的多目标跟踪算法的实现, 我们为什么又要重新写一遍呢? 这不是重复造轮子吗? 但其实对于处在学习阶段的我们来说, 这样重复造轮子的过程是必须的, 能够让我们快速的熟悉已有的一些成熟的算法, 并且在算法实现的过程中得到更深入的理解以便于我们后面进行更加深入的研究.</p>
<p>在本篇博客当中我们将基于已有的一个小的测试数据进行相关的目标跟踪及航迹管理的算法实现,  这篇博客将给出 matlab和Python 的两个实例. 目标跟踪及航迹管理的原理在这里我们就不进行介绍了, 可以参考目标跟踪有关博客的内容, 下图是在本篇博客中实现的目标跟踪及航迹管理算法的框图.<br><img src="/2021/09/03/xWRnote/mmWave_Tutorial3/overview.png" alt></p>
<h1 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h1><p>测试数据的文件我将会尽快的放在个人博客上 </p>
<h2 id="测试数据参数"><a href="#测试数据参数" class="headerlink" title="测试数据参数"></a>测试数据参数</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">参数名</th>
<th style="text-align:center">值</th>
<th style="text-align:center">单位</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">数据每帧的扫描间隔T</td>
<td style="text-align:center">1</td>
<td style="text-align:center">s</td>
</tr>
<tr>
<td style="text-align:center">距离单元格数</td>
<td style="text-align:center">400</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">方位单元格数</td>
<td style="text-align:center">200</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">距离分辨率</td>
<td style="text-align:center">10</td>
<td style="text-align:center">m</td>
</tr>
<tr>
<td style="text-align:center">角度分辨率</td>
<td style="text-align:center">0.5°</td>
<td style="text-align:center">°</td>
</tr>
<tr>
<td style="text-align:center">过程噪声强度</td>
<td style="text-align:center">0.01</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">信噪比SNR</td>
<td style="text-align:center">18</td>
<td style="text-align:center">dB</td>
</tr>
<tr>
<td style="text-align:center">虚警概率</td>
<td style="text-align:center">1e-5</td>
</tr>
</tbody>
</table>
</div>
<p>第五帧测试数据如下图<br><img src="/2021/09/03/xWRnote/mmWave_Tutorial3/Data.jpg" alt><br>这张图中我们可以看到在每一个距离单元与角度单元中都有数值, 那么我们需要进行CFAR处理进而得到检测点 </p>
<h2 id="CA-CFAR结果"><a href="#CA-CFAR结果" class="headerlink" title="CA-CFAR结果"></a>CA-CFAR结果</h2><p>我们将CFAR检测每一帧的结果叠加起来可以得到下图<br><img src="/2021/09/03/xWRnote/mmWave_Tutorial3/CA_CFAR.jpg" alt><br>通过CFAR检测后的点云数据就是我们进行目标跟踪及航迹管理的input </p>
<h1 id="相关代码-Matlab"><a href="#相关代码-Matlab" class="headerlink" title="相关代码(Matlab)"></a>相关代码(Matlab)</h1><h2 id="CA-CFAR代码"><a href="#CA-CFAR代码" class="headerlink" title="CA-CFAR代码"></a>CA-CFAR代码</h2><h3 id="一维CA-CFAR"><a href="#一维CA-CFAR" class="headerlink" title="一维CA-CFAR"></a>一维CA-CFAR</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[Cfar]</span> = <span class="title">CA_CFAR</span><span class="params">(Signal,PF,Refer,Pro)</span></span></span><br><span class="line"><span class="comment">%CA_CFAR </span></span><br><span class="line"><span class="comment">%Signal input signal</span></span><br><span class="line"><span class="comment">%PF     False Probability</span></span><br><span class="line"><span class="comment">%Refer  Reference Unit</span></span><br><span class="line"><span class="comment">%Pro    Protected Unit</span></span><br><span class="line"></span><br><span class="line">	N_all = <span class="built_in">length</span>(Signal);</span><br><span class="line">	L_slipper = <span class="number">2</span>*(Pro+Refer)+<span class="number">1</span>; <span class="comment">%处理窗的大小</span></span><br><span class="line">	Alpha = L_slipper*(PF^(<span class="number">-1</span>/L_slipper)<span class="number">-1</span>);<span class="comment">%门限系数阿尔法</span></span><br><span class="line"></span><br><span class="line">	Cfar=<span class="built_in">zeros</span>(<span class="number">1</span>,N_all);</span><br><span class="line">	Signal = [<span class="built_in">zeros</span>(<span class="number">1</span>,Refer+Pro) Signal <span class="built_in">zeros</span>(<span class="number">1</span>,Refer+Pro)];</span><br><span class="line">	<span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:N_all</span><br><span class="line">	   Cfar(<span class="built_in">i</span>)=Alpha*<span class="built_in">mean</span>([Signal(<span class="built_in">i</span>:<span class="built_in">i</span>+Refer<span class="number">-1</span>),Signal(<span class="built_in">i</span>+Refer+<span class="number">2</span>*Pro+<span class="number">1</span>:<span class="built_in">i</span>+<span class="number">2</span>*Refer+<span class="number">2</span>*Pro)]);</span><br><span class="line">	<span class="keyword">end</span>`</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="二维CA-CFAR"><a href="#二维CA-CFAR" class="headerlink" title="二维CA-CFAR"></a>二维CA-CFAR</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[CFAR]</span> = <span class="title">CA_CFAR2D</span><span class="params">(Signal,PF,Refer,Pro)</span></span></span><br><span class="line"></span><br><span class="line">SIZE = <span class="built_in">size</span>(Signal);</span><br><span class="line">L_slipper = <span class="number">2</span>*(Pro+Refer)+<span class="number">1</span>; <span class="comment">%处理窗的大小</span></span><br><span class="line"></span><br><span class="line">temp=<span class="built_in">zeros</span>(SIZE+[<span class="number">2</span>*(Refer+Pro) <span class="number">2</span>*(Refer+Pro)]);</span><br><span class="line">temp(Refer+Pro+<span class="number">1</span>:Refer+Pro+SIZE(<span class="number">1</span>),Refer+Pro+<span class="number">1</span>:Refer+Pro+SIZE(<span class="number">2</span>)) = Signal;</span><br><span class="line"></span><br><span class="line">Window = <span class="built_in">ones</span>(L_slipper,L_slipper);</span><br><span class="line">Window(Refer+<span class="number">1</span>:Refer+<span class="number">2</span>*Pro+<span class="number">1</span>,Refer+<span class="number">1</span>:Refer+<span class="number">2</span>*Pro+<span class="number">1</span>) = <span class="built_in">zeros</span>(<span class="number">2</span>*Pro+<span class="number">1</span>);</span><br><span class="line">Av_Coff = L_slipper*L_slipper-(Pro*<span class="number">2</span>+<span class="number">1</span>)^<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">Alpha = Av_Coff*(PF^(<span class="number">-1</span>/L_slipper^<span class="number">2</span>)<span class="number">-1</span>);<span class="comment">%门限系数阿尔法</span></span><br><span class="line"></span><br><span class="line">CFAR = <span class="built_in">zeros</span>(SIZE);</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:SIZE(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span>:SIZE(<span class="number">2</span>)</span><br><span class="line">        CFAR(<span class="built_in">i</span>,<span class="built_in">j</span>) = Alpha*sum(sum((temp(<span class="built_in">i</span>:<span class="built_in">i</span>+L_slipper<span class="number">-1</span>,<span class="built_in">j</span>:<span class="built_in">j</span>+L_slipper<span class="number">-1</span>).*Window).^<span class="number">2</span>))/Av_Coff;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="CA-CFAR使用示例"><a href="#CA-CFAR使用示例" class="headerlink" title="CA-CFAR使用示例"></a>CA-CFAR使用示例</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">clear all</span><br><span class="line">close all</span><br><span class="line">clc</span><br><span class="line"></span><br><span class="line">load(<span class="string">&#x27;Data_For_Test.mat&#x27;</span>);</span><br><span class="line"></span><br><span class="line">result = cell(<span class="number">1</span>,<span class="built_in">size</span>(Data_For_Test.Raw_Data,<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">Range_Cell_Num = str2num(Data_For_Test.Range_Cell_Num);</span><br><span class="line">Azimuth_Cell_Num = str2num(Data_For_Test.Azimuth_Cell_Num);</span><br><span class="line">P_False_Alarm = str2num(Data_For_Test.P_False_Alarm);</span><br><span class="line">Range_Resolution = <span class="number">10</span>;</span><br><span class="line">Azimuth_Resolution = <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">size</span>(Data_For_Test.Raw_Data,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">frame = Data_For_Test.Raw_Data&#123;<span class="built_in">i</span>&#125;;</span><br><span class="line"></span><br><span class="line">PF = P_False_Alarm;</span><br><span class="line">Refer = <span class="number">8</span>;</span><br><span class="line">Pro = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 1D cfar</span></span><br><span class="line"><span class="comment">% CFAR_thre = zeros(Range_Cell_Num,Azimuth_Cell_Num);</span></span><br><span class="line"><span class="comment">% for j = 1:Range_Cell_Num</span></span><br><span class="line"><span class="comment">%     CFAR_thre(j,:) = CA_CFAR(frame(j,:),PF,Refer,Pro);</span></span><br><span class="line"><span class="comment">% end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">%% 2D cfar</span></span><br><span class="line">[CFAR_thre] = <span class="built_in">sqrt</span>(CA_CFAR2D(frame,PF,Refer,Pro));</span><br><span class="line"></span><br><span class="line">cfar_detect = (CFAR_thre&lt;frame);</span><br><span class="line">seq = [];</span><br><span class="line">index = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> k = <span class="number">1</span>:Range_Cell_Num</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span>:Azimuth_Cell_Num</span><br><span class="line">        <span class="keyword">if</span> cfar_detect(k,<span class="built_in">j</span>)</span><br><span class="line">            seq(index,:) = [k <span class="built_in">j</span>];</span><br><span class="line">            index = index + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">seq = [ (seq(:,<span class="number">1</span>)*Range_Resolution).*<span class="built_in">cos</span>((seq(:,<span class="number">2</span>)<span class="number">-100</span>)*Azimuth_Resolution*<span class="built_in">pi</span>/<span class="number">180</span>) seq(:,<span class="number">1</span>)*Range_Resolution.*<span class="built_in">sin</span>((seq(:,<span class="number">2</span>)<span class="number">-100</span>)*Azimuth_Resolution*<span class="built_in">pi</span>/<span class="number">180</span>) ];</span><br><span class="line"></span><br><span class="line">result&#123;<span class="built_in">i</span>&#125; = seq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span></span><br><span class="line"><span class="built_in">hold</span> on</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="number">30</span></span><br><span class="line"><span class="built_in">scatter</span>(result&#123;<span class="built_in">i</span>&#125;(:,<span class="number">1</span>),result&#123;<span class="built_in">i</span>&#125;(:,<span class="number">2</span>));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span></span><br><span class="line"><span class="built_in">hold</span> on</span><br><span class="line">mesh(CFAR_thre)</span><br><span class="line">mesh(frame)</span><br></pre></td></tr></table></figure>
<h2 id="卡尔曼滤波"><a href="#卡尔曼滤波" class="headerlink" title="卡尔曼滤波"></a>卡尔曼滤波</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[x_est,P_k_k]</span> = <span class="title">KalmanFilter</span><span class="params">(z_k,x_est_k_minus1,F,H,P_k,Q,R)</span></span></span><br><span class="line">   x_pre = F*x_est_k_minus1;</span><br><span class="line">   P = F*P_k*F&#x27; + Q;</span><br><span class="line">   </span><br><span class="line">   z_pre = H*x_pre;</span><br><span class="line">   S = H*P*H&#x27; + R;</span><br><span class="line">   K = P*H&#x27;/(S);</span><br><span class="line">   </span><br><span class="line">   x_est = x_pre + K*(z_k - z_pre);</span><br><span class="line">   P_k_k = (<span class="built_in">eye</span>(<span class="built_in">size</span>(K*H,<span class="number">1</span>))-K*H)*P;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="实验航迹和确认航迹类"><a href="#实验航迹和确认航迹类" class="headerlink" title="实验航迹和确认航迹类"></a>实验航迹和确认航迹类</h2><h3 id="实验航迹类-MN逻辑起始法"><a href="#实验航迹类-MN逻辑起始法" class="headerlink" title="实验航迹类(MN逻辑起始法)"></a>实验航迹类(MN逻辑起始法)</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">classdef</span> MNstarter_KFCV</span><br><span class="line">    <span class="keyword">properties</span></span><br><span class="line">        seq = [];</span><br><span class="line">        M = <span class="number">0</span>;</span><br><span class="line">        N = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Kalman Coefficient</span></span><br><span class="line">        T = <span class="number">1</span>;</span><br><span class="line">        F;</span><br><span class="line">        H = [<span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">             <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>];</span><br><span class="line">        Gamma;</span><br><span class="line">        Q;</span><br><span class="line">        R;</span><br><span class="line">        </span><br><span class="line">        x_pre = <span class="built_in">zeros</span>(<span class="number">4</span>,<span class="number">1</span>);</span><br><span class="line">        P_k = <span class="built_in">eye</span>(<span class="number">4</span>);</span><br><span class="line">        z_pre = <span class="built_in">zeros</span>(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">        P = <span class="built_in">eye</span>(<span class="number">4</span>);</span><br><span class="line">        S = <span class="built_in">eye</span>(<span class="number">2</span>);</span><br><span class="line">        K = <span class="built_in">zeros</span>(<span class="number">4</span>,<span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        x_est = <span class="built_in">zeros</span>(<span class="number">4</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">methods</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">MNstarter_KFCV</span><span class="params">(Z,T)</span></span></span><br><span class="line">            obj.seq = Z;</span><br><span class="line">            obj.T = T;</span><br><span class="line">            obj.F = [<span class="number">1</span> <span class="number">0</span> T <span class="number">0</span>;</span><br><span class="line">                     <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> T;</span><br><span class="line">                     <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span>;</span><br><span class="line">                     <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>];</span><br><span class="line">            obj.Gamma=[T*T/<span class="number">2</span> <span class="number">0</span>;<span class="number">0</span> T*T/<span class="number">2</span>;T <span class="number">0</span>;<span class="number">0</span> T];</span><br><span class="line">            obj.Q = obj.Gamma*obj.Gamma&#x27;*<span class="number">1</span>;</span><br><span class="line">            obj.R = <span class="number">1</span>*obj.H*obj.H&#x27;;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">predict</span><span class="params">(obj)</span></span></span><br><span class="line">            obj.x_pre = obj.F*obj.seq(<span class="keyword">end</span>,:)&#x27;;</span><br><span class="line">            obj.P = obj.F*obj.P_k*obj.F&#x27; + obj.Q;</span><br><span class="line"></span><br><span class="line">            obj.z_pre = obj.H*obj.x_pre;</span><br><span class="line">            obj.S = obj.H*obj.P*obj.H&#x27; + obj.R;</span><br><span class="line">            obj.K = obj.P*obj.H&#x27;/(obj.S);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">addseq</span><span class="params">(obj,Z)</span></span></span><br><span class="line">            obj.x_est = obj.x_pre + obj.K*(Z&#x27; - obj.z_pre);</span><br><span class="line">            obj.P_k = (<span class="built_in">eye</span>(<span class="built_in">size</span>(obj.K*obj.H,<span class="number">1</span>))-obj.K*obj.H)*obj.P;</span><br><span class="line">            obj.seq   = [obj.seq;obj.x_est&#x27;];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="确认航迹类"><a href="#确认航迹类" class="headerlink" title="确认航迹类"></a>确认航迹类</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">classdef</span> ConfirmTrajectory_KFCV</span><br><span class="line">    <span class="keyword">properties</span></span><br><span class="line">        seq = [];</span><br><span class="line">        scoreboard = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Kalman Coefficient</span></span><br><span class="line">        T = <span class="number">1</span>;</span><br><span class="line">        F;</span><br><span class="line">        H = [<span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">             <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>];</span><br><span class="line">        Gamma;</span><br><span class="line">        Q;</span><br><span class="line">        R;</span><br><span class="line">        </span><br><span class="line">        x_pre = <span class="built_in">zeros</span>(<span class="number">4</span>,<span class="number">1</span>);</span><br><span class="line">        P_k = <span class="built_in">eye</span>(<span class="number">4</span>);</span><br><span class="line">        z_pre = <span class="built_in">zeros</span>(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">        P = <span class="built_in">eye</span>(<span class="number">4</span>);</span><br><span class="line">        S = <span class="built_in">eye</span>(<span class="number">2</span>);</span><br><span class="line">        K = <span class="built_in">zeros</span>(<span class="number">4</span>,<span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        x_est = <span class="built_in">zeros</span>(<span class="number">4</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">methods</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">ConfirmTrajectory_KFCV</span><span class="params">(Z,T)</span></span></span><br><span class="line">            obj.seq = Z;</span><br><span class="line">            obj.T = T;</span><br><span class="line">            obj.F = [<span class="number">1</span> <span class="number">0</span> T <span class="number">0</span>;</span><br><span class="line">                     <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> T;</span><br><span class="line">                     <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span>;</span><br><span class="line">                     <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>];</span><br><span class="line">            obj.Gamma=[T*T/<span class="number">2</span> <span class="number">0</span>;<span class="number">0</span> T*T/<span class="number">2</span>;T <span class="number">0</span>;<span class="number">0</span> T];</span><br><span class="line">            obj.Q = obj.Gamma*obj.Gamma&#x27;*<span class="number">1</span>;</span><br><span class="line">            obj.R = <span class="number">1</span>*obj.H*obj.H&#x27;;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">predict</span><span class="params">(obj)</span></span></span><br><span class="line">            obj.x_pre = obj.F*obj.seq(<span class="keyword">end</span>,:)&#x27;;</span><br><span class="line">            obj.P = obj.F*obj.P_k*obj.F&#x27; + obj.Q;</span><br><span class="line"></span><br><span class="line">            obj.z_pre = obj.H*obj.x_pre;</span><br><span class="line">            obj.S = obj.H*obj.P*obj.H&#x27; + obj.R;</span><br><span class="line">            obj.K = obj.P*obj.H&#x27;/(obj.S);</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">obj</span> = <span class="title">addseq</span><span class="params">(obj,Z)</span></span></span><br><span class="line">            obj.x_est = obj.x_pre + obj.K*(Z&#x27; - obj.z_pre);</span><br><span class="line">            obj.P_k = (<span class="built_in">eye</span>(<span class="built_in">size</span>(obj.K*obj.H,<span class="number">1</span>))-obj.K*obj.H)*obj.P;</span><br><span class="line">            </span><br><span class="line">             <span class="comment">% Staging data of 20 points</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">size</span>(obj.seq,<span class="number">1</span>)&lt;<span class="number">20</span></span><br><span class="line">                obj.seq = [obj.seq;obj.x_est&#x27;];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                obj.seq = [obj.seq;obj.x_est&#x27;];</span><br><span class="line">                obj.seq(<span class="number">1</span>,:) = [];</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="目标跟踪与航迹管理步进函数"><a href="#目标跟踪与航迹管理步进函数" class="headerlink" title="目标跟踪与航迹管理步进函数"></a>目标跟踪与航迹管理步进函数</h2><h3 id="matlab代码"><a href="#matlab代码" class="headerlink" title="matlab代码"></a>matlab代码</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[Confirmed_trajectory]</span> = <span class="title">Track_step_PNN</span><span class="params">(Measure)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">persistent</span> test_trajectory;</span><br><span class="line">    <span class="keyword">persistent</span> confirmed_trajectory;</span><br><span class="line">    <span class="keyword">persistent</span> Prev_Measure;</span><br><span class="line">    <span class="keyword">persistent</span> initial_Flag;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(test_trajectory) &amp;&amp; <span class="built_in">isempty</span>(initial_Flag)</span><br><span class="line">        test_trajectory = &#123;&#125;;</span><br><span class="line">        confirmed_trajectory = &#123;&#125;;</span><br><span class="line">        Prev_Measure = [];</span><br><span class="line">        initial_Flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">% tracking parameter</span></span><br><span class="line">    DIS_THRE = chi2inv(<span class="number">0.99</span>,<span class="number">2</span>);</span><br><span class="line">    SCOREBOARD_THRE = <span class="number">40</span>;</span><br><span class="line">    N_PARAMETER = <span class="number">6</span>;</span><br><span class="line">    M_PARAMETER = <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    V_MAX = <span class="number">150</span>;</span><br><span class="line">    V_MIN = <span class="number">10</span>;</span><br><span class="line">    T = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    Measure_temp = Measure;</span><br><span class="line"></span><br><span class="line">    <span class="comment">% MN starter NN association</span></span><br><span class="line">    <span class="keyword">if</span> ~<span class="built_in">isempty</span>(Measure)</span><br><span class="line">        <span class="comment">% associate with ConfirmedTrajectory</span></span><br><span class="line">        <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(confirmed_trajectory,<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> ~<span class="built_in">isempty</span>(Measure)</span><br><span class="line">                confirmed_trajectory(kk) = confirmed_trajectory(kk).predict();</span><br><span class="line">                temp = confirmed_trajectory(kk).z_pre&#x27;-Measure(:,<span class="number">1</span>:<span class="number">2</span>);</span><br><span class="line">                dis = <span class="built_in">diag</span>(temp*inv(confirmed_trajectory(kk).S)*temp&#x27;);<span class="comment">%计算相邻两帧点迹距离</span></span><br><span class="line"></span><br><span class="line">                [val, pos] = <span class="built_in">min</span>(dis);<span class="comment">%选出距离最小的点</span></span><br><span class="line">                <span class="keyword">if</span> val&lt;DIS_THRE</span><br><span class="line">                    confirmed_trajectory(kk) = confirmed_trajectory(kk).addseq(Measure(pos,:));</span><br><span class="line">                    confirmed_trajectory(kk).scoreboard = <span class="number">0</span>;</span><br><span class="line">                    Measure(pos,:) = [];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    confirmed_trajectory(kk) = confirmed_trajectory(kk).addseq(confirmed_trajectory(kk).z_pre&#x27;);</span><br><span class="line">                    confirmed_trajectory(kk).scoreboard = confirmed_trajectory(kk).scoreboard + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">            <span class="comment">% terrible score delete ConfirmedTrajectory</span></span><br><span class="line">            delete_pos = [];</span><br><span class="line">            <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(confirmed_trajectory,<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">if</span> confirmed_trajectory(kk).scoreboard &gt; SCOREBOARD_THRE</span><br><span class="line">                    delete_pos = [delete_pos kk];</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            confirmed_trajectory(delete_pos) = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">% associate with MNstarter</span></span><br><span class="line">        <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(test_trajectory,<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> ~<span class="built_in">isempty</span>(Measure)</span><br><span class="line">                test_trajectory(kk) = test_trajectory(kk).predict();</span><br><span class="line">                temp = test_trajectory(kk).z_pre&#x27;-Measure(:,<span class="number">1</span>:<span class="number">2</span>);</span><br><span class="line">                dis = <span class="built_in">diag</span>(temp*inv(test_trajectory(kk).S)*temp&#x27;);<span class="comment">%计算相邻两帧点迹距离</span></span><br><span class="line"></span><br><span class="line">                [val, pos] = <span class="built_in">min</span>(dis);</span><br><span class="line">                <span class="keyword">if</span> val&lt;DIS_THRE</span><br><span class="line">                    test_trajectory(kk) = test_trajectory(kk).addseq(Measure(pos,:));</span><br><span class="line">                    test_trajectory(kk).N = test_trajectory(kk).N + <span class="number">1</span>;</span><br><span class="line">                    test_trajectory(kk).M = test_trajectory(kk).M + <span class="number">1</span>;</span><br><span class="line">                    Measure(pos,:) = [];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    test_trajectory(kk) = test_trajectory(kk).addseq(test_trajectory(kk).z_pre&#x27;);</span><br><span class="line">                    test_trajectory(kk).N = test_trajectory(kk).N + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">            <span class="comment">% check whether satisfy MN logic</span></span><br><span class="line">            delete_pos = [];</span><br><span class="line">            <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(test_trajectory,<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">if</span> test_trajectory(kk).N &gt;= N_PARAMETER</span><br><span class="line">                    <span class="keyword">if</span> test_trajectory(kk).M &gt;= M_PARAMETER</span><br><span class="line">                        <span class="comment">% transfer to ConfirmedTrajectory</span></span><br><span class="line">                        confirmed_trajectory = [confirmed_trajectory TestToConfirmed(test_trajectory(kk),T)];</span><br><span class="line">                        <span class="comment">% free MNstarter</span></span><br><span class="line">                        delete_pos = [delete_pos kk];</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">% delete MNstarter</span></span><br><span class="line">                        delete_pos = [delete_pos kk];</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            test_trajectory(delete_pos) = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">% directly start as a new MNstarter</span></span><br><span class="line">        test_trajectory = [test_trajectory directbegin(Measure,Prev_Measure,V_MIN,V_MIN,T)];</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(confirmed_trajectory,<span class="number">2</span>)</span><br><span class="line">            <span class="comment">% predict</span></span><br><span class="line">            confirmed_trajectory(kk) = confirmed_trajectory(kk).predict();</span><br><span class="line">            <span class="comment">% use prev point</span></span><br><span class="line">            confirmed_trajectory(kk) = confirmed_trajectory(kk).addseq(confirmed_trajectory(kk).z_pre&#x27;);</span><br><span class="line">            <span class="comment">% ConfirmedTrajectory scoreboard +1</span></span><br><span class="line">            confirmed_trajectory(kk).scoreboard = confirmed_trajectory(kk).scoreboard + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">            <span class="comment">% terrible score delete ConfirmedTrajectory</span></span><br><span class="line">            delete_pos = [];</span><br><span class="line">            <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(confirmed_trajectory,<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">if</span> confirmed_trajectory(kk).scoreboard &gt; SCOREBOARD_THRE</span><br><span class="line">                    delete_pos = [delete_pos kk];</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            confirmed_trajectory(delete_pos) = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(test_trajectory,<span class="number">2</span>)</span><br><span class="line">            <span class="comment">% predict</span></span><br><span class="line">            test_trajectory(kk) = test_trajectory(kk).predict();</span><br><span class="line">            <span class="comment">% use prev point</span></span><br><span class="line">            test_trajectory(kk) = test_trajectory(kk).addseq(test_trajectory(kk).z_pre&#x27;);</span><br><span class="line">            <span class="comment">% MNstarter N +1</span></span><br><span class="line">            test_trajectory(kk).N = test_trajectory(kk).N + <span class="number">1</span>;            </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">            <span class="comment">% check whether satisfy MN logic</span></span><br><span class="line">            delete_pos = [];</span><br><span class="line">            <span class="keyword">for</span> kk = <span class="number">1</span>:<span class="built_in">size</span>(test_trajectory,<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">if</span> test_trajectory(kk).N &gt;= N_PARAMETER</span><br><span class="line">                    <span class="keyword">if</span> test_trajectory(kk).M &gt;= M_PARAMETER</span><br><span class="line">                        <span class="comment">% transfer to ConfirmedTrajectory</span></span><br><span class="line">                        confirmed_trajectory = [confirmed_trajectory TestToConfirmed(test_trajectory(kk),T)];</span><br><span class="line">                        <span class="comment">% free MNstarter</span></span><br><span class="line">                        delete_pos = [delete_pos kk];</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">% delete MNstarter</span></span><br><span class="line">                        delete_pos = [delete_pos kk];</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            test_trajectory(delete_pos) = [];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    Prev_Measure = Measure_temp;</span><br><span class="line">    </span><br><span class="line">    Confirmed_trajectory = confirmed_trajectory;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[testroot]</span> = <span class="title">directbegin</span><span class="params">(Measure,Prev_Measure,vmin,vmax,T)</span></span></span><br><span class="line">    testroot = MNstarter_KFCV.empty;</span><br><span class="line">    </span><br><span class="line">    index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ~<span class="built_in">isempty</span>(Measure)</span><br><span class="line">        <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">size</span>(Prev_Measure,<span class="number">1</span>)</span><br><span class="line">            <span class="comment">% calculate distance between two frame </span></span><br><span class="line">            dis = [];</span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span>:<span class="built_in">size</span>(Measure,<span class="number">1</span>)</span><br><span class="line">                dis = [dis norm(Prev_Measure(<span class="built_in">i</span>,<span class="number">1</span>:<span class="number">2</span>)-Measure(<span class="built_in">j</span>,<span class="number">1</span>:<span class="number">2</span>))];</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            [val pos] = <span class="built_in">min</span>(dis);</span><br><span class="line">            <span class="keyword">if</span> vmin*T&lt;val&lt;vmax*T</span><br><span class="line">                v = (Measure(pos,:)-Prev_Measure(<span class="built_in">i</span>,:))/T;</span><br><span class="line">                testroot(index) = MNstarter_KFCV([[Prev_Measure(<span class="built_in">i</span>,:) <span class="number">0</span> <span class="number">0</span>];[Measure(pos,:) v]],T);</span><br><span class="line">                index = index +<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[confirmedroot]</span> = <span class="title">TestToConfirmed</span><span class="params">(testroot,T)</span></span></span><br><span class="line">    confirmedroot = ConfirmTrajectory_KFCV(testroot.seq,T);</span><br><span class="line">    confirmedroot.x_pre = testroot.x_pre;</span><br><span class="line">    confirmedroot.P_k = testroot.P_k;</span><br><span class="line">    confirmedroot.z_pre = testroot.z_pre;</span><br><span class="line">    confirmedroot.P = testroot.P;</span><br><span class="line">    confirmedroot.S = testroot.S;</span><br><span class="line">    confirmedroot.K = testroot.K;</span><br><span class="line">    confirmedroot.x_est = testroot.x_est;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="python代码"><a href="#python代码" class="headerlink" title="python代码"></a>python代码</h3><h4 id="二维跟踪"><a href="#二维跟踪" class="headerlink" title="二维跟踪"></a>二维跟踪</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># File:         实现逻辑法航迹起始，NN法数据关联，卡尔曼滤波以及传统航迹管理（2维）</span></span><br><span class="line"><span class="comment">#               主要实现了MOT迭代函数</span></span><br><span class="line"><span class="comment"># Author:       UESTC Yu Xuyao</span></span><br><span class="line"><span class="comment"># Email:        yxy19991102@163.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scipy.io <span class="keyword">as</span> scio</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> scipy.stats <span class="keyword">as</span> st</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> IWR.track <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2自由度卡方分布</span></span><br><span class="line">threshold = st.chi2.ppf(<span class="number">0.80</span>, <span class="number">2</span>)</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">F = numpy.mat([[<span class="number">1</span>, <span class="number">0</span>, T, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, T], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]])</span><br><span class="line">H = numpy.mat([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>]])</span><br><span class="line">Gamma = numpy.mat([[T * T / <span class="number">2</span>, <span class="number">0</span>], [<span class="number">0</span>, T * T / <span class="number">2</span>], [T, <span class="number">0</span>], [<span class="number">0</span>, T]])</span><br><span class="line">Q = Gamma * Gamma.T * <span class="number">0.5</span></span><br><span class="line">R = <span class="number">0.1</span> * H * H.T</span><br><span class="line"></span><br><span class="line">vmin = <span class="number">0.2</span></span><br><span class="line">vmax = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">max_velocity = <span class="number">1.5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">beginTrack</span>(<span class="params">points</span>):</span></span><br><span class="line">    <span class="keyword">global</span> threshold, T, F, H, Gamma, Q, R, vmin, vmax</span><br><span class="line"></span><br><span class="line">    outside = []</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    testroot = []</span><br><span class="line"></span><br><span class="line">    Z_k = (points[<span class="number">0</span>])</span><br><span class="line">    Z_k_plus1 = (points[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k.shape[<span class="number">1</span>]):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k_plus1.shape[<span class="number">1</span>]):</span><br><span class="line">            d = <span class="built_in">max</span>(<span class="number">0</span>, numpy.linalg.norm(Z_k_plus1[:, k] - Z_k[:, j]) - vmax * T) + <span class="built_in">max</span>(<span class="number">0</span>, -numpy.linalg.norm(</span><br><span class="line">                Z_k_plus1[:, k] - Z_k[:, j]) + vmin * T)</span><br><span class="line">            D = d / numpy.linalg.det(R + R) * d</span><br><span class="line">            <span class="keyword">if</span> D &lt;= threshold:</span><br><span class="line">                temp = TestTrack(Z_k[:, j])</span><br><span class="line">                temp.addseq(Z_k_plus1[:, k])</span><br><span class="line"></span><br><span class="line">                Px0 = <span class="number">5</span> * numpy.eye(<span class="number">4</span>)</span><br><span class="line">                P = F * Px0 * F.T + Q</span><br><span class="line">                S = H * P * H.T + R * <span class="number">0.2</span></span><br><span class="line">                K = P * H.T * numpy.linalg.inv(S)</span><br><span class="line">                Pkk = (numpy.eye(<span class="number">4</span>) - K * H) * P</span><br><span class="line"></span><br><span class="line">                x_init = numpy.concatenate((Z_k_plus1[:, k], (Z_k_plus1[:, k] - Z_k[:, j]) / T), axis=<span class="number">0</span>)</span><br><span class="line">                x_forest = F * x_init</span><br><span class="line"></span><br><span class="line">                temp.est = x_init</span><br><span class="line">                temp.pkk = Pkk</span><br><span class="line">                temp.x_predict = x_forest</span><br><span class="line">                temp.M = <span class="number">2</span></span><br><span class="line">                temp.N = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">                testroot.append(temp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> testroot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TestToConfirmed</span>(<span class="params">testroot</span>):</span></span><br><span class="line">    confirmedroot = ConfirmedTrack(testroot.start)</span><br><span class="line">    confirmedroot.seq = testroot.seq</span><br><span class="line">    confirmedroot.est = testroot.est</span><br><span class="line">    confirmedroot.pkk = testroot.pkk</span><br><span class="line">    confirmedroot.seq = testroot.seq</span><br><span class="line">    confirmedroot.x_predict = testroot.x_predict</span><br><span class="line">    <span class="keyword">return</span> confirmedroot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MOT</span>(<span class="params">Z_k, Z_k_prev, confirmedroot, testroot</span>):</span></span><br><span class="line">    <span class="keyword">global</span> threshold, T, F, H, Gamma, Q, R, vmin, vmax</span><br><span class="line"></span><br><span class="line">    Z_k_present = Z_k</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(confirmedroot) != <span class="number">0</span>:</span><br><span class="line">            pos = []</span><br><span class="line">            <span class="keyword">for</span> kk <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(confirmedroot)):</span><br><span class="line">                confirmedroot[kk].board += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> confirmedroot[kk].board &gt;= <span class="number">4</span>:</span><br><span class="line">                    pos.append(kk)</span><br><span class="line">            confirmedroot = numpy.delete(confirmedroot, pos)</span><br><span class="line">            confirmedroot = confirmedroot.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(confirmedroot) != <span class="number">0</span>:</span><br><span class="line">            pos = []</span><br><span class="line">            <span class="keyword">for</span> kk <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(confirmedroot)):</span><br><span class="line">                <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                P = F * confirmedroot[kk].pkk * F.T + Q</span><br><span class="line">                S = H * P * H.T + R</span><br><span class="line">                K = P * H.T * numpy.linalg.inv(S)</span><br><span class="line">                outside = H * confirmedroot[kk].x_predict</span><br><span class="line">                V = []</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k.shape[<span class="number">1</span>]):</span><br><span class="line">                    V.append((Z_k[:, i] - outside).T * numpy.linalg.inv(S) * (Z_k[:, i] - outside))</span><br><span class="line"></span><br><span class="line">                index = numpy.argmin(V)</span><br><span class="line">                val = numpy.amin(V)</span><br><span class="line">                <span class="keyword">if</span> val &lt;= threshold:</span><br><span class="line">                    confirmedroot[kk].addseq(Z_k[:, index])</span><br><span class="line">                    est = confirmedroot[kk].x_predict + K * (Z_k[:, index] - outside)</span><br><span class="line">                    confirmedroot[kk].addest(est)</span><br><span class="line">                    confirmedroot[kk].pkk = (numpy.eye(<span class="number">4</span>) - K * H) * P</span><br><span class="line">                    confirmedroot[kk].x_predict = F * est</span><br><span class="line">                    confirmedroot[kk].board = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                    Z_k = numpy.delete(Z_k, index, axis=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    confirmedroot[kk].addseq(outside)</span><br><span class="line">                    confirmedroot[kk].addest(confirmedroot[kk].x_predict)</span><br><span class="line">                    confirmedroot[kk].pkk = P</span><br><span class="line">                    confirmedroot[kk].x_predict = F * confirmedroot[kk].est[:, -<span class="number">1</span>]</span><br><span class="line">                    confirmedroot[kk].board += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> confirmedroot[kk].board &gt;= <span class="number">4</span> <span class="keyword">or</span> numpy.linalg.norm(confirmedroot[kk].est[<span class="number">2</span>:<span class="number">4</span>, -<span class="number">1</span>]) &gt; max_velocity:</span><br><span class="line">                    pos.append(kk)</span><br><span class="line"></span><br><span class="line">            confirmedroot = numpy.delete(confirmedroot, pos)</span><br><span class="line">            confirmedroot = confirmedroot.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(testroot) != <span class="number">0</span>:</span><br><span class="line">            pos = []</span><br><span class="line">            <span class="keyword">for</span> kk <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(testroot)):</span><br><span class="line">                <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                P = F * testroot[kk].pkk * F.T + Q</span><br><span class="line">                S = H * P * H.T + R</span><br><span class="line">                K = P * H.T * numpy.linalg.inv(S)</span><br><span class="line">                outside = H * testroot[kk].x_predict</span><br><span class="line">                V = []</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k.shape[<span class="number">1</span>]):</span><br><span class="line">                    V.append((Z_k[:, i] - outside).T * numpy.linalg.inv(S) * (Z_k[:, i] - outside))</span><br><span class="line"></span><br><span class="line">                index = numpy.argmin(V)</span><br><span class="line">                val = numpy.amin(V)</span><br><span class="line">                <span class="keyword">if</span> val &lt;= threshold:</span><br><span class="line">                    testroot[kk].addseq(Z_k[:, index])</span><br><span class="line">                    est = testroot[kk].x_predict + K * (Z_k[:, index] - outside)</span><br><span class="line">                    testroot[kk].addest(est)</span><br><span class="line">                    testroot[kk].pkk = (numpy.eye(<span class="number">4</span>) - K * H) * P</span><br><span class="line">                    testroot[kk].x_predict = F * est</span><br><span class="line">                    testroot[kk].M += <span class="number">1</span></span><br><span class="line">                    testroot[kk].N += <span class="number">1</span></span><br><span class="line">                    Z_k = numpy.delete(Z_k, index, axis=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    testroot[kk].addseq(outside)</span><br><span class="line">                    testroot[kk].addest(testroot[kk].x_predict)</span><br><span class="line">                    testroot[kk].pkk = P</span><br><span class="line">                    testroot[kk].x_predict = F * testroot[kk].est[:, -<span class="number">1</span>]</span><br><span class="line">                    testroot[kk].N += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> testroot[kk].N == <span class="number">6</span>:</span><br><span class="line">                    <span class="keyword">if</span> testroot[kk].M &gt;= <span class="number">4</span> <span class="keyword">and</span> numpy.linalg.norm(testroot[kk].est[<span class="number">2</span>:<span class="number">4</span>, -<span class="number">1</span>]) &lt; max_velocity:</span><br><span class="line">                        confirmedroot.append(TestToConfirmed(testroot[kk]))</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        pos.append(kk)</span><br><span class="line"></span><br><span class="line">            testroot = numpy.delete(testroot, pos)</span><br><span class="line">            testroot = testroot.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">        testroot.extend(beginTrack([Z_k_prev, Z_k_present]))</span><br><span class="line"></span><br><span class="line">    Z_k_prev = Z_k_present</span><br><span class="line">    <span class="keyword">return</span> confirmedroot, testroot, Z_k_present</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="三维跟踪"><a href="#三维跟踪" class="headerlink" title="三维跟踪"></a>三维跟踪</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># File:         实现逻辑法航迹起始，NN法数据关联，卡尔曼滤波以及传统航迹管理（3维）</span></span><br><span class="line"><span class="comment">#               主要实现了MOT迭代函数</span></span><br><span class="line"><span class="comment"># Author:       UESTC YuXuyao</span></span><br><span class="line"><span class="comment"># Email:        yxy19991102@163.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scipy.io <span class="keyword">as</span> scio</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> scipy.stats <span class="keyword">as</span> st</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> IWR.track <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">threshold = st.chi2.ppf(<span class="number">0.80</span>, <span class="number">3</span>)</span><br><span class="line">T = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">F = numpy.mat([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, T, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, T, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, T], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">               [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]])</span><br><span class="line">H = numpy.mat([[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])</span><br><span class="line">Gamma = numpy.mat([[T * T / <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, T * T / <span class="number">2</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, T * T / <span class="number">2</span>], [T, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, T, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, T]])</span><br><span class="line">Q = Gamma * Gamma.T * <span class="number">0.5</span></span><br><span class="line">R = <span class="number">0.1</span> * H * H.T</span><br><span class="line"></span><br><span class="line">vmin = <span class="number">0.2</span></span><br><span class="line">vmax = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">max_velocity = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">beginTrack</span>(<span class="params">points</span>):</span></span><br><span class="line">    <span class="keyword">global</span> threshold, T, F, H, Gamma, Q, R, vmin, vmax</span><br><span class="line"></span><br><span class="line">    outside = []</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    testroot = []</span><br><span class="line"></span><br><span class="line">    Z_k = (points[<span class="number">0</span>])</span><br><span class="line">    Z_k_plus1 = (points[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k.shape[<span class="number">1</span>]):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k_plus1.shape[<span class="number">1</span>]):</span><br><span class="line">            d = <span class="built_in">max</span>(<span class="number">0</span>, numpy.linalg.norm(Z_k_plus1[:, k] - Z_k[:, j]) - vmax * T) + <span class="built_in">max</span>(<span class="number">0</span>, -numpy.linalg.norm(</span><br><span class="line">                Z_k_plus1[:, k] - Z_k[:, j]) + vmin * T)</span><br><span class="line">            D = d / numpy.linalg.det(R + R) * d</span><br><span class="line">            <span class="keyword">if</span> D &lt;= threshold:</span><br><span class="line">                temp = TestTrack(Z_k[:, j])</span><br><span class="line">                temp.addseq(Z_k_plus1[:, k])</span><br><span class="line"></span><br><span class="line">                Px0 = <span class="number">5</span> * numpy.eye(<span class="number">6</span>)</span><br><span class="line">                P = F * Px0 * F.T + Q</span><br><span class="line">                S = H * P * H.T + R * <span class="number">0.2</span></span><br><span class="line">                K = P * H.T * numpy.linalg.inv(S)</span><br><span class="line">                Pkk = (numpy.eye(<span class="number">6</span>) - K * H) * P</span><br><span class="line"></span><br><span class="line">                x_init = numpy.concatenate((Z_k_plus1[:, k], (Z_k_plus1[:, k] - Z_k[:, j]) / T), axis=<span class="number">0</span>)</span><br><span class="line">                x_forest = F * x_init</span><br><span class="line"></span><br><span class="line">                temp.est = x_init</span><br><span class="line">                temp.pkk = Pkk</span><br><span class="line">                temp.x_predict = x_forest</span><br><span class="line">                temp.M = <span class="number">2</span></span><br><span class="line">                temp.N = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">                testroot.append(temp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> testroot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TestToConfirmed</span>(<span class="params">testroot</span>):</span></span><br><span class="line">    confirmedroot = ConfirmedTrack(testroot.start)</span><br><span class="line">    confirmedroot.seq = testroot.seq</span><br><span class="line">    confirmedroot.est = testroot.est</span><br><span class="line">    confirmedroot.pkk = testroot.pkk</span><br><span class="line">    confirmedroot.seq = testroot.seq</span><br><span class="line">    confirmedroot.x_predict = testroot.x_predict</span><br><span class="line">    <span class="keyword">return</span> confirmedroot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MOT</span>(<span class="params">Z_k, Z_k_prev, confirmedroot, testroot</span>):</span></span><br><span class="line">    <span class="keyword">global</span> threshold, T, F, H, Gamma, Q, R, vmin, vmax</span><br><span class="line"></span><br><span class="line">    Z_k_present = Z_k</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(confirmedroot) != <span class="number">0</span>:</span><br><span class="line">            pos = []</span><br><span class="line">            <span class="keyword">for</span> kk <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(confirmedroot)):</span><br><span class="line">                confirmedroot[kk].board += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> confirmedroot[kk].board &gt;= <span class="number">4</span>:</span><br><span class="line">                    pos.append(kk)</span><br><span class="line">            confirmedroot = numpy.delete(confirmedroot, pos)</span><br><span class="line">            confirmedroot = confirmedroot.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(confirmedroot) != <span class="number">0</span>:</span><br><span class="line">            pos = []</span><br><span class="line">            <span class="keyword">for</span> kk <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(confirmedroot)):</span><br><span class="line">                <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                P = F * confirmedroot[kk].pkk * F.T + Q</span><br><span class="line">                S = H * P * H.T + R</span><br><span class="line">                K = P * H.T * numpy.linalg.inv(S)</span><br><span class="line">                outside = H * confirmedroot[kk].x_predict</span><br><span class="line">                V = []</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k.shape[<span class="number">1</span>]):</span><br><span class="line">                    V.append((Z_k[:, i] - outside).T * numpy.linalg.inv(S) * (Z_k[:, i] - outside))</span><br><span class="line"></span><br><span class="line">                index = numpy.argmin(V)</span><br><span class="line">                val = numpy.amin(V)</span><br><span class="line">                <span class="keyword">if</span> val &lt;= threshold:</span><br><span class="line">                    confirmedroot[kk].addseq(Z_k[:, index])</span><br><span class="line">                    est = confirmedroot[kk].x_predict + K * (Z_k[:, index] - outside)</span><br><span class="line">                    confirmedroot[kk].addest(est)</span><br><span class="line">                    confirmedroot[kk].pkk = (numpy.eye(<span class="number">6</span>) - K * H) * P</span><br><span class="line">                    confirmedroot[kk].x_predict = F * est</span><br><span class="line">                    confirmedroot[kk].board = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                    Z_k = numpy.delete(Z_k, index, axis=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    confirmedroot[kk].addseq(outside)</span><br><span class="line">                    confirmedroot[kk].addest(confirmedroot[kk].x_predict)</span><br><span class="line">                    confirmedroot[kk].pkk = P</span><br><span class="line">                    confirmedroot[kk].x_predict = F * confirmedroot[kk].est[:, -<span class="number">1</span>]</span><br><span class="line">                    confirmedroot[kk].board += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> confirmedroot[kk].board &gt;= <span class="number">4</span> <span class="keyword">or</span> numpy.linalg.norm(confirmedroot[kk].est[<span class="number">3</span>:<span class="number">6</span>, -<span class="number">1</span>]) &gt; max_velocity:</span><br><span class="line">                    pos.append(kk)</span><br><span class="line"></span><br><span class="line">            confirmedroot = numpy.delete(confirmedroot, pos)</span><br><span class="line">            confirmedroot = confirmedroot.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(testroot) != <span class="number">0</span>:</span><br><span class="line">            pos = []</span><br><span class="line">            <span class="keyword">for</span> kk <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(testroot)):</span><br><span class="line">                <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                P = F * testroot[kk].pkk * F.T + Q</span><br><span class="line">                S = H * P * H.T + R</span><br><span class="line">                K = P * H.T * numpy.linalg.inv(S)</span><br><span class="line">                outside = H * testroot[kk].x_predict</span><br><span class="line">                V = []</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, Z_k.shape[<span class="number">1</span>]):</span><br><span class="line">                    V.append((Z_k[:, i] - outside).T * numpy.linalg.inv(S) * (Z_k[:, i] - outside))</span><br><span class="line"></span><br><span class="line">                index = numpy.argmin(V)</span><br><span class="line">                val = numpy.amin(V)</span><br><span class="line">                <span class="keyword">if</span> val &lt;= threshold:</span><br><span class="line">                    testroot[kk].addseq(Z_k[:, index])</span><br><span class="line">                    est = testroot[kk].x_predict + K * (Z_k[:, index] - outside)</span><br><span class="line">                    testroot[kk].addest(est)</span><br><span class="line">                    testroot[kk].pkk = (numpy.eye(<span class="number">6</span>) - K * H) * P</span><br><span class="line">                    testroot[kk].x_predict = F * est</span><br><span class="line">                    testroot[kk].M += <span class="number">1</span></span><br><span class="line">                    testroot[kk].N += <span class="number">1</span></span><br><span class="line">                    Z_k = numpy.delete(Z_k, index, axis=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    testroot[kk].addseq(outside)</span><br><span class="line">                    testroot[kk].addest(testroot[kk].x_predict)</span><br><span class="line">                    testroot[kk].pkk = P</span><br><span class="line">                    testroot[kk].x_predict = F * testroot[kk].est[:, -<span class="number">1</span>]</span><br><span class="line">                    testroot[kk].N += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> testroot[kk].N == <span class="number">6</span>:</span><br><span class="line">                    <span class="keyword">if</span> testroot[kk].M &gt;= <span class="number">4</span> <span class="keyword">and</span> numpy.linalg.norm(testroot[kk].est[<span class="number">3</span>:<span class="number">6</span>, -<span class="number">1</span>]) &lt; max_velocity:</span><br><span class="line">                        confirmedroot.append(TestToConfirmed(testroot[kk]))</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        pos.append(kk)</span><br><span class="line"></span><br><span class="line">            testroot = numpy.delete(testroot, pos)</span><br><span class="line">            testroot = testroot.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Z_k.shape[<span class="number">1</span>] != <span class="number">0</span>:</span><br><span class="line">        testroot.extend(beginTrack([Z_k_prev, Z_k_present]))</span><br><span class="line"></span><br><span class="line">    Z_k_prev = Z_k_present</span><br><span class="line">    <span class="keyword">return</span> confirmedroot, testroot, Z_k_present</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="目标跟踪与航迹管理实例脚本"><a href="#目标跟踪与航迹管理实例脚本" class="headerlink" title="目标跟踪与航迹管理实例脚本"></a>目标跟踪与航迹管理实例脚本</h2><h3 id="matlab示例"><a href="#matlab示例" class="headerlink" title="matlab示例"></a>matlab示例</h3><p>其中 measure.mat 是由CFAR检测得到的每一帧检测点的集合<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">clear all</span><br><span class="line">close all</span><br><span class="line">clc</span><br><span class="line"></span><br><span class="line">load(<span class="string">&#x27;measure.mat&#x27;</span>);</span><br><span class="line"><span class="built_in">figure</span></span><br><span class="line"><span class="built_in">hold</span> on </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:<span class="built_in">size</span>(measure,<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">hold</span> off</span><br><span class="line">    <span class="built_in">plot</span>(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">    axis([<span class="number">0</span> <span class="number">4000</span> <span class="number">-4000</span> <span class="number">4000</span>]);</span><br><span class="line">    <span class="built_in">hold</span> on</span><br><span class="line">    [Confirmed_trajectory] = Track_step_PNN(measure&#123;<span class="built_in">i</span>&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span>:<span class="built_in">size</span>(Confirmed_trajectory,<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">plot</span>(Confirmed_trajectory(<span class="built_in">j</span>).seq(:,<span class="number">1</span>),Confirmed_trajectory(<span class="built_in">j</span>).seq(:,<span class="number">2</span>),<span class="string">&#x27;-o&#x27;</span>,<span class="string">&#x27;linewidth&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">        axis([<span class="number">0</span> <span class="number">4000</span> <span class="number">-4000</span> <span class="number">4000</span>]);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    pause(<span class="number">0.1</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h3 id="python示例"><a href="#python示例" class="headerlink" title="python示例"></a>python示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># File:         读取IWR6843处理得到的点云数据（3维）进行目标跟踪，同时调用openGL对第一个航迹进行显示（多个显示未完成）</span></span><br><span class="line"><span class="comment"># Author:       UESTC Yu Xuyao</span></span><br><span class="line"><span class="comment"># Email:        yxy19991102@163.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> serial</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pyqtgraph <span class="keyword">as</span> pg</span><br><span class="line"><span class="keyword">from</span> pyqtgraph.Qt <span class="keyword">import</span> QtGui</span><br><span class="line"><span class="keyword">import</span> pyqtgraph.opengl <span class="keyword">as</span> gl</span><br><span class="line"><span class="keyword">from</span> IWR.MOT3D <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> dbscan</span><br><span class="line"><span class="keyword">import</span> pandas</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the configuration file name</span></span><br><span class="line">configFileName = <span class="string">&#x27;profile_iwr6843_ods_3d.cfg&#x27;</span></span><br><span class="line"></span><br><span class="line">CLIport = &#123;&#125;</span><br><span class="line">Dataport = &#123;&#125;</span><br><span class="line">byteBuffer = np.zeros(<span class="number">2</span> ** <span class="number">15</span>, dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">byteBufferLength = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">testroot = []</span><br><span class="line">confirmedroot = []</span><br><span class="line">Z_k_prev = numpy.mat([])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Function to configure the serial ports and send the data from</span></span><br><span class="line"><span class="comment"># the configuration file to the radar</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialConfig</span>(<span class="params">configFileName</span>):</span></span><br><span class="line">    <span class="keyword">global</span> CLIport</span><br><span class="line">    <span class="keyword">global</span> Dataport</span><br><span class="line">    <span class="comment"># Open the serial ports for the configuration and the data ports</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Linux</span></span><br><span class="line">    <span class="comment"># CLIport = serial.Serial(&#x27;/dev/ttyACM0&#x27;, 115200)</span></span><br><span class="line">    <span class="comment"># Dataport = serial.Serial(&#x27;/dev/ttyACM1&#x27;, 921600)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Windows</span></span><br><span class="line">    CLIport = serial.Serial(<span class="string">&#x27;COM7&#x27;</span>, <span class="number">115200</span>)</span><br><span class="line">    Dataport = serial.Serial(<span class="string">&#x27;COM8&#x27;</span>, <span class="number">921600</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read the configuration file and send it to the board</span></span><br><span class="line">    config = [line.rstrip(<span class="string">&#x27;\r\n&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(configFileName)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> config:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        CLIport.write((i + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">        <span class="comment"># wait for reply</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        reply = CLIport.read(CLIport.in_waiting).decode()</span><br><span class="line">        <span class="built_in">print</span>(reply)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CLIport, Dataport</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Funtion to read and parse the incoming data</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readAndParseData</span>(<span class="params">Dataport</span>):</span></span><br><span class="line">    <span class="keyword">global</span> byteBuffer, byteBufferLength</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Constants</span></span><br><span class="line">    OBJ_STRUCT_SIZE_BYTES = <span class="number">12</span></span><br><span class="line">    BYTE_VEC_ACC_MAX_SIZE = <span class="number">2</span> ** <span class="number">15</span></span><br><span class="line">    MMWDEMO_UART_MSG_DETECTED_POINTS = <span class="number">1</span></span><br><span class="line">    MMWDEMO_UART_MSG_RANGE_PROFILE = <span class="number">2</span></span><br><span class="line">    maxBufferSize = <span class="number">2</span> ** <span class="number">15</span></span><br><span class="line">    tlvHeaderLengthInBytes = <span class="number">8</span></span><br><span class="line">    pointLengthInBytes = <span class="number">16</span></span><br><span class="line">    magicWord = [<span class="number">2</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize variables</span></span><br><span class="line">    magicOK = <span class="number">0</span>  <span class="comment"># Checks if magic number has been read</span></span><br><span class="line">    dataOK = <span class="number">0</span>  <span class="comment"># Checks if the data has been read correctly</span></span><br><span class="line">    frameNumber = <span class="number">0</span></span><br><span class="line">    detObj = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    readBuffer = Dataport.read(Dataport.in_waiting)</span><br><span class="line">    byteVec = np.frombuffer(readBuffer, dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">    byteCount = <span class="built_in">len</span>(byteVec)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that the buffer is not full, and then add the data to the buffer</span></span><br><span class="line">    <span class="keyword">if</span> (byteBufferLength + byteCount) &lt; maxBufferSize:</span><br><span class="line">        byteBuffer[byteBufferLength:(byteBufferLength + byteCount)] = byteVec[<span class="number">0</span>:byteCount]</span><br><span class="line">        byteBufferLength = byteBufferLength + byteCount</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that the buffer has some data</span></span><br><span class="line">    <span class="keyword">if</span> byteBufferLength &gt; <span class="number">16</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check for all possible locations of the magic word</span></span><br><span class="line">        possibleLocs = np.where(byteBuffer == magicWord[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Confirm that is the beginning of the magic word and store the index in startIdx</span></span><br><span class="line">        startIdx = []</span><br><span class="line">        <span class="keyword">for</span> loc <span class="keyword">in</span> possibleLocs:</span><br><span class="line">            check = byteBuffer[loc:loc + <span class="number">8</span>]</span><br><span class="line">            <span class="keyword">if</span> np.<span class="built_in">all</span>(check == magicWord):</span><br><span class="line">                startIdx.append(loc)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check that startIdx is not empty</span></span><br><span class="line">        <span class="keyword">if</span> startIdx:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Remove the data before the first start index</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt; startIdx[<span class="number">0</span>] &lt; byteBufferLength:</span><br><span class="line">                byteBuffer[:byteBufferLength - startIdx[<span class="number">0</span>]] = byteBuffer[startIdx[<span class="number">0</span>]:byteBufferLength]</span><br><span class="line">                byteBuffer[byteBufferLength - startIdx[<span class="number">0</span>]:] = np.zeros(<span class="built_in">len</span>(byteBuffer[byteBufferLength - startIdx[<span class="number">0</span>]:]),</span><br><span class="line">                                                                       dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">                byteBufferLength = byteBufferLength - startIdx[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check that there have no errors with the byte buffer length</span></span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span>:</span><br><span class="line">                byteBufferLength = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Read the total packet length</span></span><br><span class="line">            totalPacketLen = <span class="built_in">int</span>.from_bytes(byteBuffer[<span class="number">12</span>:<span class="number">12</span> + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check that all the packet has been read</span></span><br><span class="line">            <span class="keyword">if</span> (byteBufferLength &gt;= totalPacketLen) <span class="keyword">and</span> (byteBufferLength != <span class="number">0</span>):</span><br><span class="line">                magicOK = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If magicOK is equal to 1 then process the message</span></span><br><span class="line">    <span class="keyword">if</span> magicOK:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize the pointer index</span></span><br><span class="line">        idX = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read the header</span></span><br><span class="line">        magicNumber = byteBuffer[idX:idX + <span class="number">8</span>]</span><br><span class="line">        idX += <span class="number">8</span></span><br><span class="line">        version = <span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        totalPacketLen = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        platform = <span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        frameNumber = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        timeCpuCycles = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        numDetectedObj = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        numTLVs = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        subFrameNumber = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read the TLV messages</span></span><br><span class="line">        <span class="keyword">for</span> tlvIdx <span class="keyword">in</span> <span class="built_in">range</span>(numTLVs):</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check the header of the TLV message</span></span><br><span class="line">            tlv_type = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            idX += <span class="number">4</span></span><br><span class="line">            tlv_length = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            idX += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Read the data depending on the TLV message</span></span><br><span class="line">            <span class="keyword">if</span> tlv_type == MMWDEMO_UART_MSG_DETECTED_POINTS:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Initialize the arrays</span></span><br><span class="line">                x = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line">                y = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line">                z = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line">                velocity = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> objectNum <span class="keyword">in</span> <span class="built_in">range</span>(numDetectedObj):</span><br><span class="line">                    <span class="comment"># Read the data for each object</span></span><br><span class="line">                    x[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line">                    y[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line">                    z[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line">                    velocity[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Store the data in the detObj dictionary</span></span><br><span class="line">                detObj = &#123;<span class="string">&quot;numObj&quot;</span>: numDetectedObj, <span class="string">&quot;x&quot;</span>: x, <span class="string">&quot;y&quot;</span>: y, <span class="string">&quot;z&quot;</span>: z, <span class="string">&quot;velocity&quot;</span>: velocity&#125;</span><br><span class="line">                dataOK = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove already processed data</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; idX &lt; byteBufferLength:</span><br><span class="line">            shiftSize = totalPacketLen</span><br><span class="line"></span><br><span class="line">            byteBuffer[:byteBufferLength - shiftSize] = byteBuffer[shiftSize:byteBufferLength]</span><br><span class="line">            byteBuffer[byteBufferLength - shiftSize:] = np.zeros(<span class="built_in">len</span>(byteBuffer[byteBufferLength - shiftSize:]),</span><br><span class="line">                                                                 dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">            byteBufferLength = byteBufferLength - shiftSize</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check that there are no errors with the buffer length</span></span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span>:</span><br><span class="line">                byteBufferLength = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataOK, frameNumber, detObj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Funtion to update the data and display in the plot</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>():</span></span><br><span class="line">    dataOk = <span class="number">0</span></span><br><span class="line">    <span class="keyword">global</span> detObj, confirmedroot, testroot, Z_k_prev, LinePlot</span><br><span class="line">    x = []</span><br><span class="line">    y = []</span><br><span class="line">    z = []</span><br><span class="line">    <span class="comment"># Read and parse the received data</span></span><br><span class="line">    dataOk, frameNumber, detObj = readAndParseData(Dataport)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> dataOk:</span><br><span class="line">        x = detObj[<span class="string">&quot;x&quot;</span>]</span><br><span class="line">        y = detObj[<span class="string">&quot;y&quot;</span>]</span><br><span class="line">        z = detObj[<span class="string">&quot;z&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(x) != <span class="number">0</span>:</span><br><span class="line">            core_samples, cluster_ids = dbscan(np.vstack((x, y, z)).T, eps=<span class="number">0.3</span>, min_samples=<span class="number">3</span>)</span><br><span class="line">            df = pandas.DataFrame(np.c_[np.vstack((x, y, z)).T, cluster_ids],</span><br><span class="line">                                  columns=[<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;cluster_id&#x27;</span>])</span><br><span class="line">            df = df[df.cluster_id != -<span class="number">1</span>]</span><br><span class="line">            count = df[<span class="string">&#x27;cluster_id&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">            x = []</span><br><span class="line">            y = []</span><br><span class="line">            z = []</span><br><span class="line">            <span class="keyword">if</span> count.shape[<span class="number">0</span>] &gt;= <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, count.shape[<span class="number">0</span>]):</span><br><span class="line">                    df1 = df[df.cluster_id == i]</span><br><span class="line">                    mean = np.mean([df1[<span class="string">&#x27;x&#x27;</span>], df1[<span class="string">&#x27;y&#x27;</span>], df1[<span class="string">&#x27;z&#x27;</span>]], <span class="number">1</span>)</span><br><span class="line">                    x.append(mean[<span class="number">0</span>])</span><br><span class="line">                    y.append(mean[<span class="number">1</span>])</span><br><span class="line">                    z.append(mean[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        Z_k = numpy.mat([x, y, z])</span><br><span class="line"></span><br><span class="line">        confirmedroot, testroot, Z_k_prev = MOT(Z_k, Z_k_prev, confirmedroot, testroot)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(confirmedroot) &gt; <span class="number">0</span>:</span><br><span class="line">            tmppos = confirmedroot[<span class="number">0</span>].est[<span class="number">0</span>:<span class="number">3</span>, :].T.A</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(confirmedroot)):</span><br><span class="line">                tmppos = numpy.vstack((tmppos,confirmedroot[i].est[<span class="number">0</span>:<span class="number">3</span>, :].T.A))</span><br><span class="line">            LinePlot.setData(pos=tmppos)</span><br><span class="line">            QtGui.QApplication.processEvents()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            LinePlot.setData(pos=np.array([<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>]))</span><br><span class="line">            QtGui.QApplication.processEvents()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataOk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------    MAIN   -----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configurate the serial port</span></span><br><span class="line">CLIport, Dataport = serialConfig(configFileName)</span><br><span class="line"></span><br><span class="line"><span class="comment"># START QtAPPfor the plot</span></span><br><span class="line">app = QtGui.QApplication([])</span><br><span class="line"></span><br><span class="line">app = pg.mkQApp()</span><br><span class="line"></span><br><span class="line">view = gl.GLViewWidget()</span><br><span class="line">view.setBackgroundColor(<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">view.show()</span><br><span class="line"></span><br><span class="line">axis = gl.GLAxisItem()</span><br><span class="line">axis.scale(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">view.addItem(axis)</span><br><span class="line"></span><br><span class="line">LinePlot = gl.GLScatterPlotItem()</span><br><span class="line">view.addItem(LinePlot)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Main loop</span></span><br><span class="line">detObj = &#123;&#125;</span><br><span class="line">frameData = &#123;&#125;</span><br><span class="line">currentIndex = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Update the data and check if the data is okay</span></span><br><span class="line">        dataOk = update()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> dataOk:</span><br><span class="line">            <span class="comment"># Store the current frame into frameData</span></span><br><span class="line">            frameData[currentIndex] = detObj</span><br><span class="line">            currentIndex += <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">0.01</span>)  <span class="comment"># Sampling frequency of 20 Hz</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Stop the program and close everything if Ctrl + c is pressed</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        CLIport.write((<span class="string">&#x27;sensorStop\n&#x27;</span>).encode())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;sensorStop\n&#x27;</span>)</span><br><span class="line">        CLIport.close()</span><br><span class="line">        Dataport.close()</span><br><span class="line">        win.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/09/02/xWRnote/mmWave_Tutorial2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/02/xWRnote/mmWave_Tutorial2/" class="post-title-link" itemprop="url">mmWave_Tutorial2-快速上手mmWave 3D people counting demo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-02 00:27:40" itemprop="dateCreated datePublished" datetime="2021-09-02T00:27:40+08:00">2021-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-23 23:17:01" itemprop="dateModified" datetime="2021-09-23T23:17:01+08:00">2021-09-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TI-project/" itemprop="url" rel="index"><span itemprop="name">TI project</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在上一篇博客中<a href="mmWave_Tutorial1.md">mmWave_Tutorial1</a>我们讲述了关于Ti官方demo数据读取以及数据使用并给出了一段实例程序, 细心的读者在使用完历程后会发现ti官方demo所输出的点云数据非常的稀疏, 这一部分是由于mmwave设备天线的稀疏, 一部分是由于在ti官方demo中, 角度估计使用的是传统波束形成的方法其在天线维进行fft来进行角度估计, 而这样稀疏的点云数据不利于我们进行后续更高阶的应用, 而在TI IndustrialToolbox 的 3D people counting demo 中使用了 Capon自适应波束形成算法, 能够生成相对密集的点云, 为我们后续进行聚类, 目标跟踪行为识别等算法的实现提供了基础. 程序的源码, 预编译二进制文件以及相应的说明文档可以在如下的目录中找到.</p>
<blockquote>
<p>\ti\mmwave_industrial_toolbox_4_5_1\labs\people_counting\68xx_3D_people_counting</p>
</blockquote>
<p>需要注意的是在这篇博客当中所使用到的硬件设备为IWR6843ISK,IWR8843ISK-AOP或者IWR6843ISK-ODS. 同样IWR1843Boost也可以使用 </p>
<p>在这篇博客中我们利用之前的方法来对TI IndustrialToolbox 中的 3D people counting demo 进行上位机程序的编写, 来实现数据的解析与读取.</p>
<h1 id="3D-people-counting-demo概述"><a href="#3D-people-counting-demo概述" class="headerlink" title="3D people counting demo概述"></a>3D people counting demo概述</h1><p>与ti out of box demo相比 3D people counting demo实现了如下两个新的功能:</p>
<ol>
<li>雷达前端信号处理链( 包含Capon自适应波数形成算法)</li>
<li>gtrack多目标跟踪算法</li>
</ol>
<p>3D people counting demo的框图如下图所示<br><img src="/2021/09/02/xWRnote/mmWave_Tutorial2/pplcount_overview_block2.png" alt><br>需要注意的是gtrack多目标跟踪算法是实现在ARM上的</p>
<p>同时由于xWRxx43的雷达SoC采用了3发4收的天线通道,  与iwr1642相比, 收获了在俯仰角(elevation)上的分辨能力而不单单仅限于方位角(azimuth)上的分辨能力, 而不同的天线布局会影响到后级的信号处理, 在本篇博客中我不会去详细的介绍信号处理我将会将重点放在如何读取从雷达返回的已经处理好的点云数据.</p>
<h1 id="数据传输以及格式"><a href="#数据传输以及格式" class="headerlink" title="数据传输以及格式"></a>数据传输以及格式</h1><h2 id="CLI-port-数据传输及格式"><a href="#CLI-port-数据传输及格式" class="headerlink" title="CLI port 数据传输及格式"></a>CLI port 数据传输及格式</h2><p>在之前讲述ti out of box demo 我们提到了 CLI port 是用来发送对demo程序的配置信息, 而在 3D people counting demo中, 不同于 ti out of box demo的任务, 3D people counting demo需要进行天线阵列排布, 房间边界, 状态参数等等的配置, 所以它的 CLI port数据传输的格式与相应的意义与ti out of box demo 就有所不同 </p>
<p>具体的数据传输格式以及相应的含义可以在如下文档中的Modifying Configuration File的章节中找到</p>
<blockquote>
<p>/ti/mmwave_industrial_toolbox_4_5_1/labs/people_counting/68xx_3D_people_counting/docs/3d_pplcount_user_guide.pdf</p>
</blockquote>
<h2 id="Data-port-数据传输及格式"><a href="#Data-port-数据传输及格式" class="headerlink" title="Data port 数据传输及格式"></a>Data port 数据传输及格式</h2><p>与在ti out of box demo相似, 3D people counting 在数据传输时使用了 类似的 TLV 格式, 如下图所示<br><img src="/2021/09/02/xWRnote/mmWave_Tutorial2/pplcounting_tlv.png" alt></p>
<p>与ti out of box demo 不同的是,TLV的定义与数据传输的格式, 具体的数据传输格式可以在如下文档中的 Data Formats 的章节中找到</p>
<blockquote>
<p>/ti/mmwave_industrial_toolbox_4_5_1/labs/people_counting/68xx_3D_people_counting/docs/3d_pplcount_user_guide.pdf</p>
</blockquote>
<p>3D people counting user Guide中我们可以看到 3D people counting 的 TLV 有如下三种,分别是 </p>
<ol>
<li>Point Cloud TLV</li>
<li>Target Object TLV</li>
<li>Target Index TLV </li>
</ol>
<p>Point Cloud TLV用于传输雷达信号处理得到的点云数据, Target Object TLV用于输出gtrack算法输出的 target 的状态 比如位置, 速度, 加速度等, Target Index TLV 用于输出每个target 的独立的编号.<br>它的数据定义也是通过结构体来实现的, 我们可以参考ti out of box demo 从有关的定义来进行驱动程序的编写 </p>
<h1 id="相关代码-Matlab"><a href="#相关代码-Matlab" class="headerlink" title="相关代码(Matlab)"></a>相关代码(Matlab)</h1><blockquote>
<p><font color="red"><strong>注意</strong></font>: 为了方便读者的使用, 我已经将3D people counting demo 中进行了修改, 删除了其中目标跟踪的部分并编译成了二进制文件, 需要请联系我</p>
</blockquote>
<p>这部分的代码与 ti out of box demo 类似, 但是为了方便读者们复制粘贴使用 使用, 在这里依然给出相应的各个功能部分的代码, Data port 数据传输及格式的不同带来的变化主要反映在函数 <strong>function [dataOk, frameNumber, detObj] = readAndParseData(DATA_sphandle)</strong> 中 </p>
<h2 id="打开传输串口"><a href="#打开传输串口" class="headerlink" title="打开传输串口"></a>打开传输串口</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% Description: </span></span><br><span class="line"><span class="comment">% Author: Yu Xuyao</span></span><br><span class="line"><span class="comment">% Email: yxy19991102@163.com</span></span><br><span class="line"><span class="comment">% Date: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditTime: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditors: Yu Xuyao</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[CLI_sphandle,DATA_sphandle]</span> = <span class="title">setupUART</span><span class="params">(CLIcomPortString,DATAcomPortString)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> strcmp(CLIcomPortString(<span class="number">1</span>:<span class="number">3</span>),<span class="string">&#x27;COM&#x27;</span>) || strcmp(DATAcomPortString(<span class="number">1</span>:<span class="number">3</span>),<span class="string">&#x27;COM&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        CLI_sphandle = serial(CLIcomPortString,<span class="string">&#x27;BaudRate&#x27;</span>,<span class="number">115200</span>);</span><br><span class="line">        set(CLI_sphandle,<span class="string">&#x27;Parity&#x27;</span>,<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">        set(CLI_sphandle,<span class="string">&#x27;Terminator&#x27;</span>,<span class="string">&#x27;LF&#x27;</span>)</span><br><span class="line">        fopen(CLI_sphandle);</span><br><span class="line"></span><br><span class="line">        DATA_sphandle = serial(DATAcomPortString,<span class="string">&#x27;BaudRate&#x27;</span>,<span class="number">921600</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;Terminator&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;InputBufferSize&#x27;</span>, <span class="number">65536</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;Timeout&#x27;</span>,<span class="number">10</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;ErrorFcn&#x27;</span>,@dispError);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;BytesAvailableFcnMode&#x27;</span>,<span class="string">&#x27;byte&#x27;</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;BytesAvailableFcnCount&#x27;</span>, <span class="number">2</span>^<span class="number">16</span>+<span class="number">1</span>);<span class="comment">%BYTES_AVAILABLE_FCN_CNT);</span></span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;BytesAvailableFcn&#x27;</span>,@readUartCallbackFcn);</span><br><span class="line">        fopen(DATA_sphandle);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fprintf(<span class="string">&#x27;COM port string format wrong\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="CLI-port配置数据"><a href="#CLI-port配置数据" class="headerlink" title="CLI port配置数据"></a>CLI port配置数据</h2><p>这个 CLI port 的配置数据是用来配置IWR8843ISK-AOP, 其他的型号的mmWave雷达开发板的有关配置可以在如下的文件中找到 </p>
<blockquote>
<p>\ti\mmwave_industrial_toolbox_4_5_1\labs\people_counting\68xx_3D_people_counting\chirp_configs</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sensorStop</span><br><span class="line">flushCfg</span><br><span class="line">dfeDataOutputMode 1</span><br><span class="line">channelCfg 15 7 0</span><br><span class="line">adcCfg 2 1</span><br><span class="line">adcbufCfg -1 0 1 1 1</span><br><span class="line">lowPower 0 0</span><br><span class="line">profileCfg 0 60.75 7 7 41.10 0 0 54.71 1 96 2950.00 0 0 36 </span><br><span class="line">chirpCfg 0 0 0 0 0 0 0 1</span><br><span class="line">chirpCfg 1 1 0 0 0 0 0 2</span><br><span class="line">chirpCfg 2 2 0 0 0 0 0 4</span><br><span class="line">frameCfg 0 2  96  0 50 1 0</span><br><span class="line">dynamicRACfarCfg -1 4 4 2 4 8 16 4 4 4.00 4.50 0.50 1 1</span><br><span class="line">staticRACfarCfg -1 4 4 2 4 8 16 4 6 12.00 13.00 0.30 0 0</span><br><span class="line">dynamicRangeAngleCfg -1 0.75 0.0010 1 0</span><br><span class="line">dynamic2DAngleCfg -1 1.5 0.0300 1 0 1 0.50 0.85 8.00</span><br><span class="line">staticRangeAngleCfg -1 1 8 4</span><br><span class="line">antGeometry0 -1 -1 0 0 -3 -3 -2 -2 -1 -1 0 0</span><br><span class="line">antGeometry1 -1 0 -1 0 -3 -2 -3 -2 -3 -2 -3 -2</span><br><span class="line">antPhaseRot 1 -1 1 -1 1 -1 1 -1 1 -1 1 -1</span><br><span class="line">fovCfg -1 70.0 20.0</span><br><span class="line">compRangeBiasAndRxChanPhase 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 </span><br><span class="line">staticBoundaryBox -2 2 2 8.5 -2 2</span><br><span class="line">boundaryBox -2.5 2.5 0.5 9 -2.5 2.5</span><br><span class="line">sensorPosition 2 0 0</span><br><span class="line">gatingParam 3 2 2 2 0</span><br><span class="line">stateParam 3 3 10 40 5 600</span><br><span class="line">allocationParam 00 800 0.1 15 0.1 20</span><br><span class="line">trackingCfg 1 2 1000 20 67 105 50</span><br><span class="line">sensorStart</span><br></pre></td></tr></table></figure>
<h2 id="读取CLI-port配置数据"><a href="#读取CLI-port配置数据" class="headerlink" title="读取CLI port配置数据"></a>读取CLI port配置数据</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% Description: </span></span><br><span class="line"><span class="comment">% Author: Yu Xuyao</span></span><br><span class="line"><span class="comment">% Email: yxy19991102@163.com</span></span><br><span class="line"><span class="comment">% Date: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditTime: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditors: Yu Xuyao</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[configcmd]</span> = <span class="title">readCfgFile</span><span class="params">(configFile)</span></span></span><br><span class="line"></span><br><span class="line">configcmd = cell(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">fid = fopen(configFile, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> fid == <span class="number">-1</span></span><br><span class="line">    fprintf(<span class="string">&#x27;File %s not found!\n&#x27;</span>, configFile);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    fprintf(<span class="string">&#x27;Opening configuration file %s ...\n&#x27;</span>, configFile);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">tline = fgetl(fid);</span><br><span class="line">k=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ischar(tline)</span><br><span class="line">    <span class="keyword">if</span> ~<span class="built_in">isempty</span>(tline)</span><br><span class="line">        configcmd&#123;k&#125; = tline;</span><br><span class="line">        k = k + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line">    tline = fgetl(fid);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">configcmd = configcmd(<span class="number">1</span>:k<span class="number">-1</span>);</span><br><span class="line">fclose(fid);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="发送CLI-port的配置数据"><a href="#发送CLI-port的配置数据" class="headerlink" title="发送CLI port的配置数据"></a>发送CLI port的配置数据</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% Description: </span></span><br><span class="line"><span class="comment">% Author: Yu Xuyao</span></span><br><span class="line"><span class="comment">% Email: yxy19991102@163.com</span></span><br><span class="line"><span class="comment">% Date: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditTime: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditors: Yu Xuyao</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendCfg</span><span class="params">(UART_sphandle,configcmd)</span></span></span><br><span class="line">mmwDemoCliPrompt = char(<span class="string">&#x27;mmwDemo:/&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">%Send CLI configuration to IWR</span></span><br><span class="line">fprintf(<span class="string">&#x27;Sending configuration to IWR radar\n&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span> k=<span class="number">1</span>:<span class="built_in">length</span>(configcmd)</span><br><span class="line">    command = configcmd&#123;k&#125;;</span><br><span class="line">    fprintf(UART_sphandle, command);</span><br><span class="line">    fprintf(<span class="string">&#x27;%s\n&#x27;</span>, command);</span><br><span class="line">    echo = fgetl(UART_sphandle); <span class="comment">% Get an echo of a command</span></span><br><span class="line">    done = fgetl(UART_sphandle); <span class="comment">% Get &quot;Done&quot;</span></span><br><span class="line">    fprintf(<span class="string">&#x27;%s\n&#x27;</span>, done);</span><br><span class="line">    prompt = fread(UART_sphandle, <span class="built_in">size</span>(mmwDemoCliPrompt,<span class="number">2</span>)); <span class="comment">% Get the prompt back</span></span><br><span class="line">    fprintf(<span class="string">&#x27;%s\n&#x27;</span>, prompt);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="读取Data-port数据"><a href="#读取Data-port数据" class="headerlink" title="读取Data port数据"></a>读取Data port数据</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% Description: </span></span><br><span class="line"><span class="comment">% Author: Yu Xuyao</span></span><br><span class="line"><span class="comment">% Email: yxy19991102@163.com</span></span><br><span class="line"><span class="comment">% Date: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditTime: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditors: Yu Xuyao</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[dataOk, frameNumber, pointStruct,targetStruct2D]</span> = <span class="title">readAndParseData</span><span class="params">(DATA_sphandle)</span></span></span><br><span class="line">    pointStruct_SIZE_BYTES = <span class="number">8</span>;</span><br><span class="line">    targetStruct2D_SIZE_BYTES = <span class="number">40</span>;</span><br><span class="line">    BYTE_VEC_ACC_MAX_SIZE = <span class="number">2</span>^<span class="number">16</span>;</span><br><span class="line">    POINT_CLOUD_2D = <span class="number">6</span>;</span><br><span class="line">    TARGET_LIST_3D   = <span class="number">7</span>;</span><br><span class="line">     TARGET_INDEX  = <span class="number">8</span>;</span><br><span class="line">    maxBufferSize = BYTE_VEC_ACC_MAX_SIZE;</span><br><span class="line">    </span><br><span class="line">    pointStruct =[];</span><br><span class="line">    targetStruct2D = [];</span><br><span class="line">    frameNumber = <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">persistent</span> byteBuffer</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(byteBuffer)</span><br><span class="line">        byteBuffer = <span class="built_in">zeros</span>(maxBufferSize,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">persistent</span> byteBufferLength</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(byteBufferLength)</span><br><span class="line">        byteBufferLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">persistent</span> magiNotOkCounter</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(magiNotOkCounter)</span><br><span class="line">        magiNotOkCounter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    magicOk = <span class="number">0</span>;</span><br><span class="line">    dataOk = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    bytesToRead = get(DATA_sphandle,<span class="string">&#x27;BytesAvailable&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (bytesToRead ~= <span class="number">0</span>)</span><br><span class="line">        <span class="comment">% Read the Data Serial Port</span></span><br><span class="line">        [bytevec, byteCount] = fread(DATA_sphandle, bytesToRead, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">         <span class="comment">% Check if the buffer is not full, and then add the data to the buffer:</span></span><br><span class="line">        <span class="keyword">if</span>(byteBufferLength + byteCount &lt; maxBufferSize)</span><br><span class="line">            byteBuffer(byteBufferLength+<span class="number">1</span>:byteBufferLength + byteCount) = bytevec(<span class="number">1</span>:byteCount);</span><br><span class="line">            byteBufferLength = byteBufferLength + byteCount;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">% Check that the buffer is not empty:</span></span><br><span class="line">    <span class="keyword">if</span> byteBufferLength &gt; <span class="number">16</span></span><br><span class="line">        byteBufferStr = char(byteBuffer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Search for the magic number inside the buffer and check that at least one magic number has been found:</span></span><br><span class="line">        startIdx = strfind(byteBufferStr&#x27;, char([<span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">6</span> <span class="number">5</span> <span class="number">8</span> <span class="number">7</span>]));</span><br><span class="line">        <span class="keyword">if</span> ~<span class="built_in">isempty</span>(startIdx)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">% Check the position of the first magic number and put it at</span></span><br><span class="line">            <span class="comment">% the beginning of the buffer</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">length</span>(startIdx) &gt;= <span class="number">2</span></span><br><span class="line">                <span class="keyword">if</span> startIdx(<span class="keyword">end</span><span class="number">-1</span>) &gt; <span class="number">1</span></span><br><span class="line">                    byteBuffer(<span class="number">1</span>:byteBufferLength-(startIdx(<span class="number">1</span>)<span class="number">-1</span>)) = byteBuffer(startIdx(<span class="number">1</span>):byteBufferLength);</span><br><span class="line">                    byteBufferLength = byteBufferLength - (startIdx(<span class="number">1</span>)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> startIdx(<span class="number">1</span>) &gt; <span class="number">1</span></span><br><span class="line">                    byteBuffer(<span class="number">1</span>:byteBufferLength-(startIdx(<span class="number">1</span>)<span class="number">-1</span>)) = byteBuffer(startIdx(<span class="number">1</span>):byteBufferLength);</span><br><span class="line">                    byteBufferLength = byteBufferLength - (startIdx(<span class="number">1</span>)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span></span><br><span class="line">                byteBufferLength = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            totalPacketLen = sum(byteBuffer(<span class="number">8</span>+<span class="number">4</span>+[<span class="number">1</span>:<span class="number">4</span>]) .* [<span class="number">1</span> <span class="number">256</span> <span class="number">65536</span> <span class="number">16777216</span>]&#x27;);</span><br><span class="line">            <span class="keyword">if</span> ((byteBufferLength &gt;= totalPacketLen) &amp;&amp; (byteBufferLength ~= <span class="number">0</span>)) </span><br><span class="line">                magicOk = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                magicOk = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (magicOk == <span class="number">1</span>)</span><br><span class="line">        <span class="comment">%%%%% HEADER</span></span><br><span class="line">        word = [<span class="number">1</span> <span class="number">256</span> <span class="number">65536</span> <span class="number">16777216</span>]&#x27;;</span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        magicNumber = byteBuffer(idx + <span class="number">1</span>:<span class="number">8</span>);</span><br><span class="line">        idx = idx + <span class="number">8</span>;</span><br><span class="line">        Header.version = dec2hex(sum(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>]) .* word));</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.totalPacketLen = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.platform = dec2hex(sum(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>]) .* word));</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.frameNumber = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        frameNumber = Header.frameNumber;</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.subFrameNumber = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.chirpProcessingMargin = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.frameProcessingMargin = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.trackProcessTime = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.uartSentTime = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.numTLVs = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">2</span>))),<span class="string">&#x27;uint16&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">2</span>;</span><br><span class="line">        Header.checksum = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">2</span>))),<span class="string">&#x27;uint16&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">%%%%% TLV</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Analyze each of TLV messages:</span></span><br><span class="line">        <span class="keyword">for</span> tlvIdx = <span class="number">1</span>:Header.numTLVs</span><br><span class="line">            <span class="comment">% First, analyze the TLV header (TLV type and length):</span></span><br><span class="line">            tlv.<span class="built_in">type</span> = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">            idx = idx + <span class="number">4</span>;</span><br><span class="line">            tlv.<span class="built_in">length</span> = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">            idx = idx + <span class="number">4</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">% Check that the TLV message is of the right type (Detected objects):</span></span><br><span class="line">            <span class="keyword">switch</span> tlv.<span class="built_in">type</span></span><br><span class="line">                <span class="keyword">case</span> POINT_CLOUD_2D</span><br><span class="line">                    numberOfPoints = (tlv.<span class="built_in">length</span> - <span class="number">28</span>)/pointStruct_SIZE_BYTES;</span><br><span class="line">                    </span><br><span class="line">                    pointUnit.elevationUnit = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>);</span><br><span class="line">                    idx = idx + <span class="number">4</span>;</span><br><span class="line">                    pointUnit.azimuthUnit = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>);</span><br><span class="line">                    idx = idx + <span class="number">4</span>;</span><br><span class="line">                    pointUnit.dopplerUnit = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>);</span><br><span class="line">                    idx = idx + <span class="number">4</span>;</span><br><span class="line">                    pointUnit.rangeUnit = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>);</span><br><span class="line">                    idx = idx + <span class="number">4</span>;</span><br><span class="line">                    pointUnit.snrUnit = typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>);</span><br><span class="line">                    idx = idx + <span class="number">4</span>;</span><br><span class="line">                    pointStruct.elevation =[];</span><br><span class="line">                    pointStruct.azimuth =[];</span><br><span class="line">                    pointStruct.doppler =[];</span><br><span class="line">                    pointStruct.range =[];</span><br><span class="line">                    pointStruct.snr =[];</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> numberOfPoints &gt; <span class="number">0</span>  </span><br><span class="line">                        <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:numberOfPoints</span><br><span class="line">                            pointStruct.elevation = [pointStruct.elevation  single(typecast(uint8(byteBuffer(idx+<span class="number">1</span>)),<span class="string">&#x27;int8&#x27;</span>))*pointUnit.elevationUnit];</span><br><span class="line">                            idx = idx + <span class="number">1</span>;</span><br><span class="line">                            pointStruct.azimuth = [pointStruct.azimuth  single(typecast(uint8(byteBuffer(idx+<span class="number">1</span>)),<span class="string">&#x27;int8&#x27;</span>))*pointUnit.azimuthUnit];</span><br><span class="line">                            idx = idx + <span class="number">1</span>;</span><br><span class="line">                            pointStruct.doppler = [pointStruct.doppler  single(typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">2</span>))),<span class="string">&#x27;int16&#x27;</span>))*pointUnit.dopplerUnit];</span><br><span class="line">                            idx = idx + <span class="number">2</span>;</span><br><span class="line">                            pointStruct.range = [pointStruct.range  single(typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">2</span>))),<span class="string">&#x27;uint16&#x27;</span>))*pointUnit.rangeUnit];</span><br><span class="line">                            idx = idx + <span class="number">2</span>;</span><br><span class="line">                            pointStruct.snr = [pointStruct.snr  single(typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">2</span>))),<span class="string">&#x27;uint16&#x27;</span>))*pointUnit.snrUnit];</span><br><span class="line">                            idx = idx + <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        dataOk = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">case</span> TARGET_LIST_3D</span><br><span class="line">                    numberOfTargets = (tlv.<span class="built_in">length</span> - <span class="number">28</span>)/targetStruct2D_SIZE_BYTES;</span><br><span class="line">                    <span class="keyword">if</span> tlv.<span class="built_in">length</span> &gt; <span class="number">0</span>   </span><br><span class="line">                        targetStruct2D.tid = [];</span><br><span class="line">                        targetStruct2D.posX = [];</span><br><span class="line">                        targetStruct2D.posY = [];</span><br><span class="line">                        targetStruct2D.velX = [];</span><br><span class="line">                        targetStruct2D.velY = [];</span><br><span class="line">                        targetStruct2D.accX = [];</span><br><span class="line">                        targetStruct2D.accY = [];</span><br><span class="line">                        targetStruct2D.posZ = [];</span><br><span class="line">                        targetStruct2D.velZ = [];</span><br><span class="line">                        targetStruct2D.accZ = [];</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> numberOfPoints &gt; <span class="number">0</span>  </span><br><span class="line">                            <span class="keyword">for</span> <span class="built_in">i</span> = <span class="number">1</span>:numberOfPoints</span><br><span class="line">                                targetStruct2D.tid = [targetStruct2D.tid typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;uint32&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.posX = [targetStruct2D.posX typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.posY = [targetStruct2D.posY typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.velX = [targetStruct2D.velX typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.velY = [targetStruct2D.velY typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.accX = [targetStruct2D.accX typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.accY = [targetStruct2D.accY typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.posZ = [targetStruct2D.posZ typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.velZ = [targetStruct2D.velZ typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                                targetStruct2D.accZ = [targetStruct2D.accZ typecast(uint8(byteBuffer(idx+(<span class="number">1</span>:<span class="number">4</span>))),<span class="string">&#x27;single&#x27;</span>)];</span><br><span class="line">                                idx = idx + <span class="number">4</span>;</span><br><span class="line">                            <span class="keyword">end</span></span><br><span class="line">                        <span class="keyword">end</span></span><br><span class="line">                        </span><br><span class="line">                        dataOk = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">case</span> TARGET_INDEX</span><br><span class="line"><span class="comment">%                     rp = byteBuffer(idx+(1:tlv.length));</span></span><br><span class="line"><span class="comment">%                     idx = idx + tlv.length;</span></span><br><span class="line"><span class="comment">%                     rp=rp(1:2:end)+rp(2:2:end)*256;</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">%Remove processed data</span></span><br><span class="line">        <span class="keyword">if</span> idx &gt; <span class="number">0</span></span><br><span class="line">            shiftSize = Header.totalPacketLen;</span><br><span class="line">            byteBuffer(<span class="number">1</span>: byteBufferLength-shiftSize) = byteBuffer(shiftSize+<span class="number">1</span>:byteBufferLength);</span><br><span class="line">            byteBufferLength = byteBufferLength - shiftSize;</span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span></span><br><span class="line">                <span class="comment">%             fprintf(&#x27;Error: bytevec_cp_len &lt; bytevecAccLen, %d %d \n&#x27;, bytevec_cp_len, bytevecAccLen)</span></span><br><span class="line">                byteBufferLength = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="comment">%         if byteBufferLength &gt; (byteBufferLength * 7/8)</span></span><br><span class="line"><span class="comment">%             byteBufferLength = 0;</span></span><br><span class="line"><span class="comment">%         end</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        magiNotOkCounter = magiNotOkCounter + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">                        </span><br><span class="line">                    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="示例程序"><a href="#示例程序" class="headerlink" title="示例程序"></a>示例程序</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% Description: </span></span><br><span class="line"><span class="comment">% Author: Yu Xuyao</span></span><br><span class="line"><span class="comment">% Email: yxy19991102@163.com</span></span><br><span class="line"><span class="comment">% Date: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditTime: 2020-12-25 00:26:00</span></span><br><span class="line"><span class="comment">% LastEditors: Yu Xuyao</span></span><br><span class="line"></span><br><span class="line">clear all</span><br><span class="line">close all</span><br><span class="line">clc</span><br><span class="line"></span><br><span class="line">VisualReview = <span class="number">1</span>;</span><br><span class="line">FallDetection = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">delete(instrfind);</span><br><span class="line"></span><br><span class="line">configFile = <span class="string">&quot;AOPconfig.cfg&quot;</span>;</span><br><span class="line">configcmd = readCfgFile(configFile);</span><br><span class="line">[CLI_sphandle,DATA_sphandle] = setupUART(<span class="string">&#x27;COM3&#x27;</span>,<span class="string">&#x27;COM5&#x27;</span>);</span><br><span class="line">sendCfg(CLI_sphandle,configcmd);</span><br><span class="line"></span><br><span class="line">limit = <span class="number">4</span>;</span><br><span class="line">N= <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">figure</span></span><br><span class="line"></span><br><span class="line">H1 = uicontrol(<span class="string">&#x27;Style&#x27;</span>, <span class="string">&#x27;PushButton&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;String&#x27;</span>, <span class="string">&#x27;Shutdown&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;Callback&#x27;</span>, <span class="string">&#x27;shutVal = 1&#x27;</span>,<span class="string">&#x27;InnerPosition&#x27;</span>,[<span class="number">7</span>,<span class="number">30</span>,<span class="number">60</span>,<span class="number">20</span>]);</span><br><span class="line">H2 = uicontrol(<span class="string">&#x27;Style&#x27;</span>, <span class="string">&#x27;PushButton&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;String&#x27;</span>, <span class="string">&#x27;Stop&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;Callback&#x27;</span>, <span class="string">&#x27;stopVal = 1&#x27;</span>,<span class="string">&#x27;InnerPosition&#x27;</span>,[<span class="number">7</span>,<span class="number">60</span>,<span class="number">60</span>,<span class="number">20</span>]);</span><br><span class="line">H3 = uicontrol(<span class="string">&#x27;Style&#x27;</span>, <span class="string">&#x27;PushButton&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;String&#x27;</span>, <span class="string">&#x27;Start&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;Callback&#x27;</span>, <span class="string">&#x27;startVal = 1&#x27;</span>,<span class="string">&#x27;InnerPosition&#x27;</span>,[<span class="number">7</span>,<span class="number">90</span>,<span class="number">60</span>,<span class="number">20</span>]);  </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">h0 = <span class="built_in">scatter3</span>([],[],[],<span class="string">&#x27;filled&#x27;</span>);</span><br><span class="line">axis([-limit,limit,<span class="number">0</span>,<span class="number">7</span>,<span class="number">-1.5</span>,<span class="number">1.5</span>]);</span><br><span class="line">xlabel(<span class="string">&#x27;X (m)&#x27;</span>); ylabel(<span class="string">&#x27;Y (m)&#x27;</span>);zlabel(<span class="string">&#x27;Z (m)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">myInd = <span class="number">1</span>;</span><br><span class="line">dataOk = <span class="number">0</span>;</span><br><span class="line">stopVal = <span class="number">0</span>;</span><br><span class="line">startVal = <span class="number">0</span>;</span><br><span class="line">shutVal = <span class="number">0</span>;</span><br><span class="line">mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">frame = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (myInd &lt;= N)</span><br><span class="line">    dataOk = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mask ==<span class="number">1</span></span><br><span class="line">        pause(<span class="number">0.1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        [dataOk, frameNumber, pointStruct,targetStruct2D] = readAndParseData(DATA_sphandle);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> stopVal == <span class="number">1</span></span><br><span class="line">        stopVal = <span class="number">0</span>;</span><br><span class="line">        mask = <span class="number">1</span>;</span><br><span class="line">        fprintf(CLI_sphandle, <span class="string">&#x27;sensorStop\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> startVal == <span class="number">1</span></span><br><span class="line">        startVal = <span class="number">0</span>;</span><br><span class="line">        mask = <span class="number">0</span>;</span><br><span class="line">        fprintf(CLI_sphandle, <span class="string">&#x27;sensorStart 0\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> shutVal == <span class="number">1</span></span><br><span class="line">        shutVal = <span class="number">0</span>;</span><br><span class="line">        fprintf(CLI_sphandle, <span class="string">&#x27;sensorStop\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> dataOk == <span class="number">1</span></span><br><span class="line">        XData = [];</span><br><span class="line">        YData = [];</span><br><span class="line">        ZData = [];</span><br><span class="line"></span><br><span class="line">        graphXData = [];</span><br><span class="line">        graphYData = [];</span><br><span class="line">        graphZData = [];   </span><br><span class="line">        <span class="comment">% remove static points</span></span><br><span class="line">        processingSignal = [pointStruct.elevation ;pointStruct.azimuth;pointStruct.doppler;pointStruct.range;pointStruct.snr];</span><br><span class="line"></span><br><span class="line">        frame&#123;myInd&#125; = processingSignal&#x27;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> VisualReview</span><br><span class="line">            <span class="keyword">if</span> myInd&gt;<span class="number">3</span></span><br><span class="line">                showData = [frame&#123;myInd&#125;; frame&#123;myInd<span class="number">-1</span>&#125;; frame&#123;myInd<span class="number">-2</span>&#125;];</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                showData = frame&#123;myInd&#125;;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">			temp = showData(:,<span class="number">4</span>) .* <span class="built_in">cos</span>(showData(:,<span class="number">1</span>));</span><br><span class="line">			pos.XData = temp.*<span class="built_in">sin</span>(showData(:,<span class="number">2</span>));</span><br><span class="line">			pos.YData = temp.*<span class="built_in">cos</span>(showData(:,<span class="number">2</span>));</span><br><span class="line">			pos.ZData = showData(:,<span class="number">4</span>) .* <span class="built_in">sin</span>(showData(:,<span class="number">1</span>));</span><br><span class="line">			pos.Doppler = showData(:,<span class="number">3</span>);</span><br><span class="line">			pos.SNR = showData(:,<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">% Plotprocessed points</span></span><br><span class="line">            h0.XData = pos.XData;</span><br><span class="line">            h0.YData = pos.YData;</span><br><span class="line">            h0.ZData = pos.ZData;</span><br><span class="line">            h0.SizeData = <span class="number">3</span>*<span class="built_in">ones</span>(<span class="number">1</span>,<span class="built_in">length</span>(pos.ZData));</span><br><span class="line">            h0.CData = <span class="built_in">abs</span>(pos.Doppler);</span><br><span class="line"></span><br><span class="line">            title([<span class="string">&#x27;Frame No.&#x27;</span> num2str(myInd)]);</span><br><span class="line">            drawnow limitrate;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        pause(<span class="number">0.04</span>);</span><br><span class="line"></span><br><span class="line">        myInd = myInd + <span class="number">1</span>; </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">delete(instrfind);</span><br><span class="line">close all</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/09/01/xWRnote/mmWave_Tutorial1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/01/xWRnote/mmWave_Tutorial1/" class="post-title-link" itemprop="url">mmWave_Tutorial1-快速上手mmWave Out of box demo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-01 14:01:29" itemprop="dateCreated datePublished" datetime="2021-09-01T14:01:29+08:00">2021-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-24 13:39:26" itemprop="dateModified" datetime="2021-09-24T13:39:26+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TI-project/" itemprop="url" rel="index"><span itemprop="name">TI project</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>常规的Out Box of Demo的食用方法TI官方给的已经很多了总结下来就是:</p>
<ol>
<li>电脑装emupack(设备和电脑通过USB通信的驱动程序)</li>
<li>Uniflash给设备烧录demo的预编译文件</li>
<li>使用demo_visualizer与设备通过UART通信并读取数据, 可视化数据</li>
</ol>
<p>但是这样使用官方软件的方法并不适合我们做更进一步的处理, 比如目标识别, 跟踪等等信息处理. 所以我们要做的就是写一个脚本来替代demo_visualizer. 那为了完成这样一件事儿我们需要知道demo_visualizer的工作机制, 具体通信的方式, 数据格式等等细节.</p>
<p>在这篇博客中会有许多概念我们默认为读者已经提前了解了, 比如通用异步收发传输器(Universal Asynchronous Receiver/Transmitter, <strong>UART</strong>), 基本的LFMCW雷达原理等. 如果有不清楚的概念搜索引擎搜索就可以得到需要的信息.</p>
<p>在这篇博客中我们将讲首先介绍out of box demo的数据传输方式以及格式, 之后会分别使用matlab和python给出一个例程, 这个例程可以读取雷达的数据还可以对数据进行可视化.</p>
<h1 id="数据传输方式以及格式"><a href="#数据传输方式以及格式" class="headerlink" title="数据传输方式以及格式"></a>数据传输方式以及格式</h1><h2 id="数据传输方式"><a href="#数据传输方式" class="headerlink" title="数据传输方式"></a>数据传输方式</h2><p>xWR设备使用UART与上位机通信,熟悉嵌入式的读者应该清楚从xWR SoC上的UART电平信号想通过USB传输一定需要一个转换电路将其转换为USB的差分信号, 同时还要能告诉USB host传输信号的源数据类型为UART. 那么这件工作是由谁来完成的呢, 对于xWR1642boost和xWR1843boost 是通过评估板上的一块XDS芯片完成的, 而对于xWR6843AoP, xWR6843ISK-ODS和xWR6843ISK 则是通过一块名为CP2015的UART bridge芯片完成的. 当你安装emupack这个驱动程序时, 其实你就安装了XDS的芯片驱动程序. 那CP2015的驱动程序呢? 由于CP2015是一块”烂大街”的芯片(使用极其广泛), 大多数Windows发行版在安装时就已经包含了这个驱动程序, 如果你的电脑不幸miss了CP2015的驱动程序, 通过网络你也可以很轻易的得到.</p>
<p>当你通过micro-USB的数据线将xWR评估板连接到你的电脑上时, 你会在设备管理器中看到检测到新插入的两个串行接口, 后面还会显示相应的COM标号:</p>
<ul>
<li>xWR1642boost和xWR1843boost会显示为 </li>
<li>xWR6843AoP, xWR6843ISK-ODS和xWR6843ISK会显示为<br><img src="/2021/09/01/xWRnote/mmWave_Tutorial1/ISK_WinDevice.png" alt></li>
</ul>
<p>他们分别时CLI port和 Data port, CLI port传输你对demo程序的配置, 比如LFMCW雷达波形基础配置, 检测算法阈值的配置等等, 同时demo程序也会积极的与你交互, 告知你的配置格式数据是否合规. Data port传输经过雷达数据处理得到的检测点云数据, 芯片工作负载信息等等. 正是由于这两个串口不同的工作任务, 他们对信息传输的速度要求不同, CLI port工作在115200的波特率而Data port工作在926000的波特率. 当然这两个串口也是工作在全双工模式下的.</p>
<h2 id="CLI-port数据格式"><a href="#CLI-port数据格式" class="headerlink" title="CLI port数据格式"></a>CLI port数据格式</h2><p>CLI port是传输你对Demo程序的配置的端口, 配置信息的格式及相应的含义可以在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;ti&#x2F;mmwave_sdk_&lt;ver&gt;&#x2F;docs&#x2F;mmwave_sdk_user_guide.pdf </span><br></pre></td></tr></table></figure><br>中的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3.4 Configuration (.cfg) File Format </span><br></pre></td></tr></table></figure><br>中找到</p>
<h2 id="Data-port数据格式"><a href="#Data-port数据格式" class="headerlink" title="Data port数据格式"></a>Data port数据格式</h2><p>Data port的数据格式可以在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; \ti\mmwave_sdk_&lt;ver&gt;\packages\ti\demo\xwr68xx\mmw\docs</span><br></pre></td></tr></table></figure><br>中找到,如下图所示<br><img src="/2021/09/01/xWRnote/mmWave_Tutorial1/output_packet_uart.png" alt><br>Data port数据输出格式是一个<strong>TLV格式</strong>的协议, 即就是每一个大的数据块(TLV)由 Tag, Length 和 Value 三个部分组成. 并且在 Data port 一次输出数据的过程中, 可能输出多个TLV, 这样在总的数据块头部, 需要一个总的Header数据段以告知该数据包TLV的数目以及这个Packet的长度(in bytes). 那么每个TLV传输的是什么数据呢? 比如检测的点云数据, 距离多普勒数据, 距离幅度的一维数据等等. 熟悉C语言的读者可以发现, 这样的多段线性的存储结构可以使用结构体来实现, 这也是TI 的官方Demo程序的做法. Packet 的<strong>header</strong>结构体叫 <strong>MmwDemo_output_message_header_t</strong> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MmwDemo_output_message_header_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint16_t</span>    magicWord[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">uint32_t</span>     version;</span><br><span class="line">	<span class="keyword">uint32_t</span>    totalPacketLen;</span><br><span class="line">	<span class="keyword">uint32_t</span>    platform;</span><br><span class="line">	<span class="keyword">uint32_t</span>    frameNumber;</span><br><span class="line">	<span class="keyword">uint32_t</span>    timeCpuCycles;</span><br><span class="line">	<span class="keyword">uint32_t</span>    numDetectedObj;</span><br><span class="line">	<span class="keyword">uint32_t</span>    numTLVs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SOC_XWR16XX</span></span><br><span class="line">	<span class="keyword">uint32_t</span>    subFrameNumber;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; MmwDemo_output_message_header;</span><br></pre></td></tr></table></figure>
<p>每个结构体成员变量的含义可以在以下html文档中查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;ti&#x2F;mmwave_sdk_02_01_00_04&#x2F;packages&#x2F;ti&#x2F;demo&#x2F;xwr16xx&#x2F;mmw&#x2F;docs&#x2F;doxygen&#x2F;html&#x2F;struct_mmw_demo__output__message__header__t.html</span><br></pre></td></tr></table></figure><br>仅仅通过变量的名称我们可以发现, Packet的<strong>header</strong>包含了SDK的版本, Packet的长度, mmWave Device的名称, Packet的编号, 检测点的个数以及TLV的个数. 那么之后就是要确定每个TLV的格式了, Demo 中给出了几种功能的TLV</p>
<ol>
<li>List of detected objects</li>
<li>Range profile</li>
<li>Noise floor profile</li>
<li>Azimuth static heatmap</li>
<li>Range/Doppler heatmap</li>
<li>Stats information</li>
</ol>
<p>每种TLV的功能可以参见如下文档的 Output information sent to host 部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;ti&#x2F;mmwave_sdk_02_01_00_04&#x2F;packages&#x2F;ti&#x2F;demo&#x2F;xwr16xx&#x2F;mmw&#x2F;docs&#x2F;doxygen&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure><br>在这里着重要说明的是检测点云(List of detected objects)的输出格式, 也是我们需要重点需要从 Demo 中获得的数据</p>
<p><strong>List of detected objects TLV</strong> 的数据结构如图<br><img src="/2021/09/01/xWRnote/mmWave_Tutorial1/detected_objects_tlv.png" alt></p>
<p>Tag和Length的结构体定义如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MmwDemo_output_message_tl_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>    type;</span><br><span class="line">	<span class="keyword">uint32_t</span>    length;</span><br><span class="line">&#125; MmwDemo_output_message_tl;</span><br></pre></td></tr></table></figure><br>而<strong>List of detected objects TLV</strong>的第二个结构体包含了检测到的点的个数与坐标存储的格式(Q-format, 即定点数)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MmwDemo_output_message_dataObjDescr_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint16_t</span>     numDetetedObj;</span><br><span class="line">	<span class="keyword">uint16_t</span>     xyzQFormat;</span><br><span class="line">&#125; MmwDemo_output_message_dataObjDescr;</span><br></pre></td></tr></table></figure><br>在MmwDemo_output_message_dataObjDescr之后紧跟着numDetetedObj个检测的点云数据<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">MmwDemo_detectedObj_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">uint16_t</span>  rangeIdx;     </span><br><span class="line">	<span class="keyword">int16_t</span>   dopplerIdx;   </span><br><span class="line">	<span class="keyword">uint16_t</span>  peakVal;      </span><br><span class="line">	<span class="keyword">int16_t</span>   x;             </span><br><span class="line">	<span class="keyword">int16_t</span>   y;             </span><br><span class="line">	<span class="keyword">int16_t</span>   z;             </span><br><span class="line">&#125; MmwDemo_detectedObj;</span><br></pre></td></tr></table></figure></p>
<h1 id="相关代码-matlab"><a href="#相关代码-matlab" class="headerlink" title="相关代码(matlab)"></a>相关代码(matlab)</h1><h2 id="打开传输串口"><a href="#打开传输串口" class="headerlink" title="打开传输串口"></a>打开传输串口</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[CLI_sphandle,DATA_sphandle]</span> = <span class="title">setupUART</span><span class="params">(CLIcomPortString,DATAcomPortString)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> strcmp(CLIcomPortString(<span class="number">1</span>:<span class="number">3</span>),<span class="string">&#x27;COM&#x27;</span>) || strcmp(DATAcomPortString(<span class="number">1</span>:<span class="number">3</span>),<span class="string">&#x27;COM&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        CLI_sphandle = serial(CLIcomPortString,<span class="string">&#x27;BaudRate&#x27;</span>,<span class="number">115200</span>);</span><br><span class="line">        set(CLI_sphandle,<span class="string">&#x27;Parity&#x27;</span>,<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">        set(CLI_sphandle,<span class="string">&#x27;Terminator&#x27;</span>,<span class="string">&#x27;LF&#x27;</span>)</span><br><span class="line">        fopen(CLI_sphandle);</span><br><span class="line"></span><br><span class="line">        DATA_sphandle = serial(DATAcomPortString,<span class="string">&#x27;BaudRate&#x27;</span>,<span class="number">921600</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;Terminator&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;InputBufferSize&#x27;</span>, <span class="number">65536</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;Timeout&#x27;</span>,<span class="number">10</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;ErrorFcn&#x27;</span>,@dispError);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;BytesAvailableFcnMode&#x27;</span>,<span class="string">&#x27;byte&#x27;</span>);</span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;BytesAvailableFcnCount&#x27;</span>, <span class="number">2</span>^<span class="number">16</span>+<span class="number">1</span>);<span class="comment">%BYTES_AVAILABLE_FCN_CNT);</span></span><br><span class="line">        set(DATA_sphandle,<span class="string">&#x27;BytesAvailableFcn&#x27;</span>,@readUartCallbackFcn);</span><br><span class="line">        fopen(DATA_sphandle);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fprintf(<span class="string">&#x27;COM port string format wrong\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="CLI-port配置数据"><a href="#CLI-port配置数据" class="headerlink" title="CLI port配置数据"></a>CLI port配置数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">% Carrier frequency     GHz                          60.25</span><br><span class="line">% Ramp Slope    MHz&#x2F;us                               156</span><br><span class="line">% Num ADC Samples                                    256</span><br><span class="line">% ADC Sampling Rate Msps                             12.5</span><br><span class="line">% ADC Collection Time   us                           20.48</span><br><span class="line">% Extra ramp time required (start time) us           3</span><br><span class="line">% Chirp time (end time - start time)    us           21</span><br><span class="line">% Chirp duration (end time) us                       24</span><br><span class="line">% Sweep BW (useful) MHz                              3194.88</span><br><span class="line">% Total BW  MHz                                      3744</span><br><span class="line">% Max beat freq (80% of ADC sampling rate)  MHz      10</span><br><span class="line">% Max distance (80%)    m                            9.62</span><br><span class="line">% Range resolution  m                                0.047</span><br><span class="line">% Range resolution (meter per 1D-FFT bin)   m&#x2F;bin    0.047</span><br><span class="line">%                                                    </span><br><span class="line">% Inter-chirp duration  us                           7</span><br><span class="line">% Number of chirp intervals in frame    -            96</span><br><span class="line">% Number of TX (TDM MIMO)                            3</span><br><span class="line">% Number of Tx elevation antennas                    0</span><br><span class="line">% Number of RX channels -                            4</span><br><span class="line">% Max umambiguous relative velocity kmph             48.19</span><br><span class="line">%   mileph                                           30.12</span><br><span class="line">% Max extended relative velocity    kmph             144.56</span><br><span class="line">%   mileph                                           90.35</span><br><span class="line">% Frame time (total)    ms                           2.976</span><br><span class="line">% Frame time (active)   ms                           2.304</span><br><span class="line">% Range FFT size    -                                256</span><br><span class="line">% Doppler FFT size  -                                32</span><br><span class="line">% Radar data memory required    KB                   400</span><br><span class="line">% Velocity resolution   m&#x2F;s                          0.84</span><br><span class="line">% Velocity resolution (m&#x2F;s per 2D-FFT bin)  m&#x2F;s&#x2F;bin  0.84</span><br><span class="line">% Velocity Maximum  m&#x2F;s                              13.39</span><br><span class="line">% Extended Maximum Velocity m&#x2F;s                      40.16</span><br><span class="line">% Maximum sweep accorss range bins  range bin        0.85</span><br><span class="line">% </span><br><span class="line">sensorStop</span><br><span class="line">flushCfg</span><br><span class="line">dfeDataOutputMode 1</span><br><span class="line">channelCfg 15 7 0</span><br><span class="line">adcCfg 2 1</span><br><span class="line">adcbufCfg -1 0 1 1 1</span><br><span class="line">lowPower 0 0</span><br><span class="line">profileCfg 0 60.25 7 3 24 0 0 156 1 256 12500 0 0 30</span><br><span class="line">chirpCfg 0 0 0 0 0 0 0 1</span><br><span class="line">chirpCfg 1 1 0 0 0 0 0 4</span><br><span class="line">chirpCfg 2 2 0 0 0 0 0 2</span><br><span class="line">frameCfg 0 2 32 0 100 1 0</span><br><span class="line">guiMonitor -1 2 0 0 0 0 0</span><br><span class="line">cfarCfg -1 0 2 8 4 3 0 11.0 0</span><br><span class="line">cfarCfg -1 1 0 4 2 3 1 11.0 0</span><br><span class="line">multiObjBeamForming -1 1 0.5</span><br><span class="line">calibDcRangeSig -1 0 -5 8 256</span><br><span class="line">clutterRemoval -1 1</span><br><span class="line"></span><br><span class="line">compRangeBiasAndRxChanPhase 0.0 -1 0 1 0 1 0 -1 0 -1 0 1 0 1 0 -1 0 -1 0 1 0 1 0 -1 0</span><br><span class="line">measureRangeBiasAndRxChanPhase 0 1. 0.2</span><br><span class="line"></span><br><span class="line">aoaFovCfg -1 -90 90 -90 90</span><br><span class="line">cfarFovCfg -1 0 0.1 5</span><br><span class="line">cfarFovCfg -1 1 -13.39 13.39</span><br><span class="line">extendedMaxVelocity -1 0</span><br><span class="line"></span><br><span class="line">CQRxSatMonitor 0 3 4 63 0</span><br><span class="line">CQSigImgMonitor 0 127 4</span><br><span class="line">analogMonitor 0 0</span><br><span class="line">lvdsStreamCfg -1 0 0 0</span><br><span class="line">bpmCfg -1 0 0 0</span><br><span class="line">sensorStart</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="读取CLI-port配置数据"><a href="#读取CLI-port配置数据" class="headerlink" title="读取CLI port配置数据"></a>读取CLI port配置数据</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[configcmd]</span> = <span class="title">readCfgFile</span><span class="params">(configFile)</span></span></span><br><span class="line"></span><br><span class="line">configcmd = cell(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">fid = fopen(configFile, <span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> fid == <span class="number">-1</span></span><br><span class="line">    fprintf(<span class="string">&#x27;File %s not found!\n&#x27;</span>, configFile);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    fprintf(<span class="string">&#x27;Opening configuration file %s ...\n&#x27;</span>, configFile);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">tline = fgetl(fid);</span><br><span class="line">k=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ischar(tline)</span><br><span class="line">    <span class="keyword">if</span> ~<span class="built_in">isempty</span>(tline)</span><br><span class="line">        configcmd&#123;k&#125; = tline;</span><br><span class="line">        k = k + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line">    tline = fgetl(fid);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">configcmd = configcmd(<span class="number">1</span>:k<span class="number">-1</span>);</span><br><span class="line">fclose(fid);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="发送CLI-port的配置数据"><a href="#发送CLI-port的配置数据" class="headerlink" title="发送CLI port的配置数据"></a>发送CLI port的配置数据</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendCfg</span><span class="params">(UART_sphandle,configcmd)</span></span></span><br><span class="line">mmwDemoCliPrompt = char(<span class="string">&#x27;mmwDemo:/&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">%Send CLI configuration to IWR</span></span><br><span class="line">fprintf(<span class="string">&#x27;Sending configuration to IWR radar\n&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span> k=<span class="number">1</span>:<span class="built_in">length</span>(configcmd)</span><br><span class="line">    command = configcmd&#123;k&#125;;</span><br><span class="line">    fprintf(UART_sphandle, command);</span><br><span class="line">    fprintf(<span class="string">&#x27;%s\n&#x27;</span>, command);</span><br><span class="line">    echo = fgetl(UART_sphandle); <span class="comment">% Get an echo of a command</span></span><br><span class="line">    done = fgetl(UART_sphandle); <span class="comment">% Get &quot;Done&quot;</span></span><br><span class="line">    fprintf(<span class="string">&#x27;%s\n&#x27;</span>, done);</span><br><span class="line">    prompt = fread(UART_sphandle, <span class="built_in">size</span>(mmwDemoCliPrompt,<span class="number">2</span>)); <span class="comment">% Get the prompt back</span></span><br><span class="line">    fprintf(<span class="string">&#x27;%s\n&#x27;</span>, prompt);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="读取Data-port数据"><a href="#读取Data-port数据" class="headerlink" title="读取Data port数据"></a>读取Data port数据</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[dataOk, frameNumber, detObj]</span> = <span class="title">readAndParseData</span><span class="params">(DATA_sphandle)</span></span></span><br><span class="line">    OBJ_STRUCT_SIZE_BYTES = <span class="number">16</span>;</span><br><span class="line">    BYTE_VEC_ACC_MAX_SIZE = <span class="number">2</span>^<span class="number">16</span>;</span><br><span class="line">    MMWDEMO_UART_MSG_DETECTED_POINTS = <span class="number">1</span>;</span><br><span class="line">    MMWDEMO_UART_MSG_RANGE_PROFILE   = <span class="number">2</span>;</span><br><span class="line">    MMWDEMO_UART_MSG_DETECTED_POINTS_SIDE_INFO  = <span class="number">7</span>;</span><br><span class="line">    maxBufferSize = BYTE_VEC_ACC_MAX_SIZE;</span><br><span class="line">    </span><br><span class="line">    detObj = [];</span><br><span class="line">    frameNumber = <span class="number">0</span>;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">persistent</span> byteBuffer</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(byteBuffer)</span><br><span class="line">        byteBuffer = <span class="built_in">zeros</span>(maxBufferSize,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">persistent</span> byteBufferLength</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(byteBufferLength)</span><br><span class="line">        byteBufferLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">persistent</span> magiNotOkCounter</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isempty</span>(magiNotOkCounter)</span><br><span class="line">        magiNotOkCounter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    magicOk = <span class="number">0</span>;</span><br><span class="line">    dataOk = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    bytesToRead = get(DATA_sphandle,<span class="string">&#x27;BytesAvailable&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (bytesToRead ~= <span class="number">0</span>)</span><br><span class="line">        <span class="comment">% Read the Data Serial Port</span></span><br><span class="line">        [bytevec, byteCount] = fread(DATA_sphandle, bytesToRead, <span class="string">&#x27;uint8&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">         <span class="comment">% Check if the buffer is not full, and then add the data to the buffer:</span></span><br><span class="line">        <span class="keyword">if</span>(byteBufferLength + byteCount &lt; maxBufferSize)</span><br><span class="line">            byteBuffer(byteBufferLength+<span class="number">1</span>:byteBufferLength + byteCount) = bytevec(<span class="number">1</span>:byteCount);</span><br><span class="line">            byteBufferLength = byteBufferLength + byteCount;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">% Check that the buffer is not empty:</span></span><br><span class="line">    <span class="keyword">if</span> byteBufferLength &gt; <span class="number">16</span></span><br><span class="line">        byteBufferStr = char(byteBuffer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Search for the magic number inside the buffer and check that at least one magic number has been found:</span></span><br><span class="line">        startIdx = strfind(byteBufferStr&#x27;, char([<span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">3</span> <span class="number">6</span> <span class="number">5</span> <span class="number">8</span> <span class="number">7</span>]));</span><br><span class="line">        <span class="keyword">if</span> ~<span class="built_in">isempty</span>(startIdx)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">% Check the position of the first magic number and put it at</span></span><br><span class="line">            <span class="comment">% the beginning of the buffer</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">length</span>(startIdx) &gt;= <span class="number">2</span></span><br><span class="line">                <span class="keyword">if</span> startIdx(<span class="keyword">end</span><span class="number">-1</span>) &gt; <span class="number">1</span></span><br><span class="line">                    byteBuffer(<span class="number">1</span>:byteBufferLength-(startIdx(<span class="number">1</span>)<span class="number">-1</span>)) = byteBuffer(startIdx(<span class="number">1</span>):byteBufferLength);</span><br><span class="line">                    byteBufferLength = byteBufferLength - (startIdx(<span class="number">1</span>)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> startIdx(<span class="number">1</span>) &gt; <span class="number">1</span></span><br><span class="line">                    byteBuffer(<span class="number">1</span>:byteBufferLength-(startIdx(<span class="number">1</span>)<span class="number">-1</span>)) = byteBuffer(startIdx(<span class="number">1</span>):byteBufferLength);</span><br><span class="line">                    byteBufferLength = byteBufferLength - (startIdx(<span class="number">1</span>)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span></span><br><span class="line">                byteBufferLength = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            totalPacketLen = sum(byteBuffer(<span class="number">8</span>+<span class="number">4</span>+[<span class="number">1</span>:<span class="number">4</span>]) .* [<span class="number">1</span> <span class="number">256</span> <span class="number">65536</span> <span class="number">16777216</span>]&#x27;);</span><br><span class="line">            <span class="keyword">if</span> ((byteBufferLength &gt;= totalPacketLen) &amp;&amp; (byteBufferLength ~= <span class="number">0</span>)) </span><br><span class="line">                magicOk = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                magicOk = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (magicOk == <span class="number">1</span>)</span><br><span class="line">        <span class="comment">%%%%% HEADER</span></span><br><span class="line">        word = [<span class="number">1</span> <span class="number">256</span> <span class="number">65536</span> <span class="number">16777216</span>]&#x27;;</span><br><span class="line">        idx = <span class="number">0</span>;</span><br><span class="line">        magicNumber = byteBuffer(idx + <span class="number">1</span>:<span class="number">8</span>);</span><br><span class="line">        idx = idx + <span class="number">8</span>;</span><br><span class="line">        Header.version = dec2hex(sum(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>]) .* word));</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.totalPacketLen = typecast(uint8(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>])),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.platform = dec2hex(sum(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>]) .* word));</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.frameNumber = typecast(uint8(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>])),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        frameNumber = Header.frameNumber;</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.timeCpuCycles = typecast(uint8(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>])),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.numDetectedObj = typecast(uint8(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>])),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.numTLVs = typecast(uint8(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>])),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        Header.subFrameNumber = typecast(uint8(byteBuffer(idx+[<span class="number">1</span>:<span class="number">4</span>])),<span class="string">&#x27;uint32&#x27;</span>);</span><br><span class="line">        idx = idx + <span class="number">4</span>;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">%%%%% TLV</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Analyze each of TLV messages:</span></span><br><span class="line">        <span class="keyword">for</span> tlvIdx = <span class="number">1</span>:Header.numTLVs</span><br><span class="line">            word = [<span class="number">1</span> <span class="number">256</span> <span class="number">65536</span> <span class="number">16777216</span>]&#x27;;</span><br><span class="line">            <span class="comment">% First, analyze the TLV header (TLV type and length):</span></span><br><span class="line">            tlv.<span class="built_in">type</span> = sum(byteBuffer(idx+uint32(<span class="number">1</span>:<span class="number">4</span>)) .* word);</span><br><span class="line">            idx = idx + <span class="number">4</span>;</span><br><span class="line">            tlv.<span class="built_in">length</span> = sum(byteBuffer(idx+uint32(<span class="number">1</span>:<span class="number">4</span>)) .* word);</span><br><span class="line">            idx = idx + <span class="number">4</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">% Check that the TLV message is of the right type (Detected objects):</span></span><br><span class="line">            <span class="keyword">switch</span> tlv.<span class="built_in">type</span></span><br><span class="line">                <span class="keyword">case</span> MMWDEMO_UART_MSG_DETECTED_POINTS</span><br><span class="line">                    detObj =[];</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> tlv.<span class="built_in">length</span> &gt; <span class="number">0</span>                       </span><br><span class="line">                        <span class="comment">% Extract the raw data for all the detected points</span></span><br><span class="line">                        bytes = byteBuffer(idx+(<span class="number">1</span>:Header.numDetectedObj*OBJ_STRUCT_SIZE_BYTES));</span><br><span class="line">                        idx = idx + Header.numDetectedObj*OBJ_STRUCT_SIZE_BYTES;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">% Reshape the array to have the data for each point</span></span><br><span class="line">                        <span class="comment">% (X,Y,Z,doppler) in each column</span></span><br><span class="line">                        bytes = <span class="built_in">reshape</span>(bytes, OBJ_STRUCT_SIZE_BYTES, Header.numDetectedObj);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">% Convert the byte matrix to float data</span></span><br><span class="line">                        floatData = <span class="built_in">reshape</span>(typecast(<span class="built_in">reshape</span>(uint8(bytes), <span class="number">1</span>, []), <span class="string">&#x27;single&#x27;</span>),<span class="number">4</span>,Header.numDetectedObj);</span><br><span class="line">                      </span><br><span class="line">                        detObj.numObj = Header.numDetectedObj;</span><br><span class="line">                        detObj.x = floatData(<span class="number">1</span>,:);</span><br><span class="line">                        detObj.y = floatData(<span class="number">2</span>,:);</span><br><span class="line">                        detObj.z = floatData(<span class="number">3</span>,:);</span><br><span class="line">                        detObj.doppler = floatData(<span class="number">4</span>,:);</span><br><span class="line">                        </span><br><span class="line">                        dataOk = <span class="number">1</span>;</span><br><span class="line">                        </span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">case</span> MMWDEMO_UART_MSG_DETECTED_POINTS_SIDE_INFO</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> tlv.<span class="built_in">length</span> &gt; <span class="number">0</span>   </span><br><span class="line">                        bytes = byteBuffer(idx+(<span class="number">1</span>:Header.numDetectedObj*<span class="number">4</span>));</span><br><span class="line">                        idx = idx + Header.numDetectedObj*<span class="number">4</span>;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">% Reshape the array to have the data for each point</span></span><br><span class="line">                        <span class="comment">% (snr,noise) in each column</span></span><br><span class="line">                        bytes = <span class="built_in">reshape</span>(bytes, <span class="number">4</span>, Header.numDetectedObj);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">% Convert the byte matrix to float data</span></span><br><span class="line">                        floatData = <span class="built_in">reshape</span>(typecast(<span class="built_in">reshape</span>(uint8(bytes), <span class="number">1</span>, []), <span class="string">&#x27;int16&#x27;</span>),<span class="number">2</span>,Header.numDetectedObj);</span><br><span class="line">                        detObj.snr = floatData(<span class="number">1</span>,:);</span><br><span class="line">                        detObj.noise = floatData(<span class="number">2</span>,:);</span><br><span class="line">                        </span><br><span class="line">                        dataOk = <span class="number">1</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">case</span> MMWDEMO_UART_MSG_RANGE_PROFILE</span><br><span class="line">                    rp = byteBuffer(idx+uint32(<span class="number">1</span>:tlv.<span class="built_in">length</span>));</span><br><span class="line">                    idx = idx + tlv.<span class="built_in">length</span>;</span><br><span class="line">                    rp=rp(<span class="number">1</span>:<span class="number">2</span>:<span class="keyword">end</span>)+rp(<span class="number">2</span>:<span class="number">2</span>:<span class="keyword">end</span>)*<span class="number">256</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">%Remove processed data</span></span><br><span class="line">        <span class="keyword">if</span> idx &gt; <span class="number">0</span></span><br><span class="line">            shiftSize = Header.totalPacketLen;</span><br><span class="line">            byteBuffer(<span class="number">1</span>: byteBufferLength-shiftSize) = byteBuffer(shiftSize+<span class="number">1</span>:byteBufferLength);</span><br><span class="line">            byteBufferLength = byteBufferLength - shiftSize;</span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span></span><br><span class="line">                byteBufferLength = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        magiNotOkCounter = magiNotOkCounter + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="示例程序"><a href="#示例程序" class="headerlink" title="示例程序"></a>示例程序</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">clear all; close all</span><br><span class="line">delete(instrfind);</span><br><span class="line"></span><br><span class="line">N = <span class="number">10000</span>;</span><br><span class="line">limit = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">% Setup radar with the parameters from the configuration file</span></span><br><span class="line">configFile = <span class="string">&quot;profile_3d.cfg&quot;</span>;</span><br><span class="line">configcmd = readCfgFile(configFile);</span><br><span class="line">[CLI_sphandle,DATA_sphandle] = setupUART(<span class="string">&#x27;COM9&#x27;</span>,<span class="string">&#x27;COM10&#x27;</span>);</span><br><span class="line">sendCfg(CLI_sphandle,configcmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">%% Initialize the figure</span></span><br><span class="line"><span class="built_in">figure</span></span><br><span class="line"></span><br><span class="line">H1 = uicontrol(<span class="string">&#x27;Style&#x27;</span>, <span class="string">&#x27;PushButton&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;String&#x27;</span>, <span class="string">&#x27;Shutdown&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;Callback&#x27;</span>, <span class="string">&#x27;shutVal = 1&#x27;</span>,<span class="string">&#x27;InnerPosition&#x27;</span>,[<span class="number">7</span>,<span class="number">30</span>,<span class="number">60</span>,<span class="number">20</span>]);</span><br><span class="line">H2 = uicontrol(<span class="string">&#x27;Style&#x27;</span>, <span class="string">&#x27;PushButton&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;String&#x27;</span>, <span class="string">&#x27;Stop&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;Callback&#x27;</span>, <span class="string">&#x27;stopVal = 1&#x27;</span>,<span class="string">&#x27;InnerPosition&#x27;</span>,[<span class="number">7</span>,<span class="number">60</span>,<span class="number">60</span>,<span class="number">20</span>]);</span><br><span class="line">H3 = uicontrol(<span class="string">&#x27;Style&#x27;</span>, <span class="string">&#x27;PushButton&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;String&#x27;</span>, <span class="string">&#x27;Start&#x27;</span>, ...</span><br><span class="line">                    <span class="string">&#x27;Callback&#x27;</span>, <span class="string">&#x27;startVal = 1&#x27;</span>,<span class="string">&#x27;InnerPosition&#x27;</span>,[<span class="number">7</span>,<span class="number">90</span>,<span class="number">60</span>,<span class="number">20</span>]);                </span><br><span class="line">h = <span class="built_in">scatter3</span>([],[],[],<span class="string">&#x27;filled&#x27;</span>);</span><br><span class="line">axis([-limit,limit,<span class="number">0</span>,limit,-limit,limit]);</span><br><span class="line">xlabel(<span class="string">&#x27;X (m)&#x27;</span>); ylabel(<span class="string">&#x27;Y (m)&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">%% main loop</span></span><br><span class="line"></span><br><span class="line">myInd = <span class="number">1</span>;</span><br><span class="line">lastreadTime = <span class="number">0</span>;</span><br><span class="line">dataOk = <span class="number">0</span>;</span><br><span class="line">stopVal = <span class="number">0</span>;</span><br><span class="line">startVal = <span class="number">0</span>;</span><br><span class="line">shutVal = <span class="number">0</span>;</span><br><span class="line">mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">tic</span><br><span class="line"><span class="keyword">while</span> (myInd &lt;= N)</span><br><span class="line">    dataOk = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">% Read the data from the radar:</span></span><br><span class="line">    <span class="keyword">if</span> mask ==<span class="number">1</span></span><br><span class="line">        pause(<span class="number">0.1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        [dataOk, frameNumber, detObj] = readAndParseData(DATA_sphandle);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> stopVal == <span class="number">1</span></span><br><span class="line">        stopVal = <span class="number">0</span>;</span><br><span class="line">        mask = <span class="number">1</span>;</span><br><span class="line">        fprintf(CLI_sphandle, <span class="string">&#x27;sensorStop\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> startVal == <span class="number">1</span></span><br><span class="line">        startVal = <span class="number">0</span>;</span><br><span class="line">        mask = <span class="number">0</span>;</span><br><span class="line">        fprintf(CLI_sphandle, <span class="string">&#x27;sensorStart 0\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> shutVal == <span class="number">1</span></span><br><span class="line">        shutVal = <span class="number">0</span>;</span><br><span class="line">        fprintf(CLI_sphandle, <span class="string">&#x27;sensorStop\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> dataOk == <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">% Store all the data from the radar</span></span><br><span class="line">        frame&#123;myInd&#125; = detObj;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">%% do process here</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">%% above</span></span><br><span class="line">                </span><br><span class="line">        <span class="comment">% Plot the radar points</span></span><br><span class="line">        h.XData = detObj.x;</span><br><span class="line">        h.YData = detObj.y;</span><br><span class="line">        h.ZData = detObj.z;</span><br><span class="line">        drawnow limitrate;</span><br><span class="line">        pause(<span class="number">0.05</span>);</span><br><span class="line">               </span><br><span class="line">        myInd = myInd + <span class="number">1</span>;     </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">delete(instrfind);</span><br><span class="line">close all</span><br></pre></td></tr></table></figure>
<h1 id="相关代码-Python"><a href="#相关代码-Python" class="headerlink" title="相关代码(Python)"></a>相关代码(Python)</h1><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>在Python的代码中需要安装如下几个依赖:</p>
<ol>
<li>pyserial: 用于通过串口与设备进行通信  </li>
<li>numpy: 进行矩阵的操作和部分数学处理 </li>
<li>Pyqt, Pyqtgraph, OpenGL: 对数据进行可视化操作并显示</li>
<li>sklearn: 聚类等操作</li>
<li>pandas: 数据管理 <h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2>在这个代码中其实进行了DBscan聚类的处理, 感兴趣的读者可以多多尝试其他的信息处理方法 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># File:         读取IWR6843处理得到的点云数据（3维）进行目标跟踪，同时调用openGL对点云进行显示</span></span><br><span class="line"><span class="comment"># Author:       UESTC Yu Xuyao</span></span><br><span class="line"><span class="comment"># Email:        yxy19991102@163.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> serial</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pyqtgraph <span class="keyword">as</span> pg</span><br><span class="line"><span class="keyword">from</span> pyqtgraph.Qt <span class="keyword">import</span> QtGui</span><br><span class="line"><span class="keyword">import</span> pyqtgraph.opengl <span class="keyword">as</span> gl</span><br><span class="line"><span class="comment"># from IWR.MOT3D import *</span></span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">from</span> sklearn.cluster <span class="keyword">import</span> dbscan</span><br><span class="line"><span class="keyword">import</span> pandas</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change the configuration file named</span></span><br><span class="line">configFileName = <span class="string">&#x27;profile_iwr6843_ods_3d.cfg&#x27;</span></span><br><span class="line"><span class="comment"># configFileName = &#x27;profile_3d.cfg&#x27;</span></span><br><span class="line"></span><br><span class="line">CLIport = &#123;&#125;</span><br><span class="line">Dataport = &#123;&#125;</span><br><span class="line">byteBuffer = np.zeros(<span class="number">2</span> ** <span class="number">15</span>, dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">byteBufferLength = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">testroot = []</span><br><span class="line">confirmedroot = []</span><br><span class="line">Z_k_prev = numpy.mat([])</span><br><span class="line"></span><br><span class="line">cnt = <span class="number">1</span></span><br><span class="line">show = []</span><br><span class="line">changdu = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Function to configure the serial ports and send the data from</span></span><br><span class="line"><span class="comment"># the configuration file to the radar</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialConfig</span>(<span class="params">configFileName</span>):</span></span><br><span class="line">    <span class="keyword">global</span> CLIport</span><br><span class="line">    <span class="keyword">global</span> Dataport</span><br><span class="line">    <span class="comment"># Open the serial ports for the configuration and the data ports</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Raspberry pi</span></span><br><span class="line">    <span class="comment"># CLIport = serial.Serial(&#x27;/dev/ttyACM0&#x27;, 115200)</span></span><br><span class="line">    <span class="comment"># Dataport = serial.Serial(&#x27;/dev/ttyACM1&#x27;, 921600)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Windows</span></span><br><span class="line">    CLIport = serial.Serial(<span class="string">&#x27;COM3&#x27;</span>, <span class="number">115200</span>)</span><br><span class="line">    Dataport = serial.Serial(<span class="string">&#x27;COM4&#x27;</span>, <span class="number">921600</span>)</span><br><span class="line">    <span class="comment"># CLIport = serial.Serial(&#x27;COM22&#x27;, 115200)</span></span><br><span class="line">    <span class="comment"># Dataport = serial.Serial(&#x27;COM21&#x27;, 921600)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read the configuration file and send it to the board</span></span><br><span class="line">    config = [line.rstrip(<span class="string">&#x27;\r\n&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(configFileName)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> config:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(i)&gt;<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="number">0</span>] != <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">                CLIport.write((i + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">                time.sleep(<span class="number">0.1</span>)</span><br><span class="line">                reply = CLIport.read(CLIport.in_waiting).decode()</span><br><span class="line">                <span class="built_in">print</span>(reply)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CLIport, Dataport</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to parse the data inside2 the configuration file</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseConfigFile</span>(<span class="params">configFileName</span>):</span></span><br><span class="line">    configParameters = &#123;&#125;  <span class="comment"># Initialize an empty dictionary to store the configuration parameters</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read the configuration file and send it to the board</span></span><br><span class="line">    config = [line.rstrip(<span class="string">&#x27;\r\n&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(configFileName)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> config:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Split the line</span></span><br><span class="line">        splitWords = i.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Hard code the number of antennas, change if other configuration is used</span></span><br><span class="line">        numRxAnt = <span class="number">4</span></span><br><span class="line">        numTxAnt = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the information about the profile configuration</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;profileCfg&quot;</span> <span class="keyword">in</span> splitWords[<span class="number">0</span>]:</span><br><span class="line">            startFreq = <span class="built_in">int</span>(<span class="built_in">float</span>(splitWords[<span class="number">2</span>]))</span><br><span class="line">            idleTime = <span class="built_in">int</span>(splitWords[<span class="number">3</span>])</span><br><span class="line">            rampEndTime = <span class="built_in">float</span>(splitWords[<span class="number">5</span>])</span><br><span class="line">            freqSlopeConst = <span class="built_in">float</span>(splitWords[<span class="number">8</span>])</span><br><span class="line">            numAdcSamples = <span class="built_in">int</span>(splitWords[<span class="number">10</span>])</span><br><span class="line">            numAdcSamplesRoundTo2 = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> numAdcSamples &gt; numAdcSamplesRoundTo2:</span><br><span class="line">                numAdcSamplesRoundTo2 = numAdcSamplesRoundTo2 * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">            digOutSampleRate = <span class="built_in">int</span>(splitWords[<span class="number">11</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the information about the frame configuration</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;frameCfg&quot;</span> <span class="keyword">in</span> splitWords[<span class="number">0</span>]:</span><br><span class="line">            chirpStartIdx = <span class="built_in">int</span>(splitWords[<span class="number">1</span>])</span><br><span class="line">            chirpEndIdx = <span class="built_in">int</span>(splitWords[<span class="number">2</span>])</span><br><span class="line">            numLoops = <span class="built_in">int</span>(splitWords[<span class="number">3</span>])</span><br><span class="line">            numFrames = <span class="built_in">int</span>(splitWords[<span class="number">4</span>])</span><br><span class="line">            framePeriodicity = <span class="built_in">float</span>(splitWords[<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Combine the read data to obtain the configuration parameters</span></span><br><span class="line">    numChirpsPerFrame = (chirpEndIdx - chirpStartIdx + <span class="number">1</span>) * numLoops</span><br><span class="line">    configParameters[<span class="string">&quot;numDopplerBins&quot;</span>] = numChirpsPerFrame / numTxAnt</span><br><span class="line">    configParameters[<span class="string">&quot;numRangeBins&quot;</span>] = numAdcSamplesRoundTo2</span><br><span class="line">    configParameters[<span class="string">&quot;rangeResolutionMeters&quot;</span>] = (<span class="number">3e8</span> * digOutSampleRate * <span class="number">1e3</span>) / (</span><br><span class="line">            <span class="number">2</span> * freqSlopeConst * <span class="number">1e12</span> * numAdcSamples)</span><br><span class="line">    configParameters[<span class="string">&quot;rangeIdxToMeters&quot;</span>] = (<span class="number">3e8</span> * digOutSampleRate * <span class="number">1e3</span>) / (</span><br><span class="line">            <span class="number">2</span> * freqSlopeConst * <span class="number">1e12</span> * configParameters[<span class="string">&quot;numRangeBins&quot;</span>])</span><br><span class="line">    configParameters[<span class="string">&quot;dopplerResolutionMps&quot;</span>] = <span class="number">3e8</span> / (</span><br><span class="line">            <span class="number">2</span> * startFreq * <span class="number">1e9</span> * (idleTime + rampEndTime) * <span class="number">1e-6</span> * configParameters[<span class="string">&quot;numDopplerBins&quot;</span>] * numTxAnt)</span><br><span class="line">    configParameters[<span class="string">&quot;maxRange&quot;</span>] = (<span class="number">300</span> * <span class="number">0.9</span> * digOutSampleRate) / (<span class="number">2</span> * freqSlopeConst * <span class="number">1e3</span>)</span><br><span class="line">    configParameters[<span class="string">&quot;maxVelocity&quot;</span>] = <span class="number">3e8</span> / (<span class="number">4</span> * startFreq * <span class="number">1e9</span> * (idleTime + rampEndTime) * <span class="number">1e-6</span> * numTxAnt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> configParameters</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Funtion to read and parse the incoming data</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readAndParseData68xx</span>(<span class="params">Dataport, configParameters</span>):</span></span><br><span class="line">    <span class="keyword">global</span> byteBuffer, byteBufferLength</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Constants</span></span><br><span class="line">    OBJ_STRUCT_SIZE_BYTES = <span class="number">12</span></span><br><span class="line">    BYTE_VEC_ACC_MAX_SIZE = <span class="number">2</span> ** <span class="number">15</span></span><br><span class="line">    MMWDEMO_UART_MSG_DETECTED_POINTS = <span class="number">1</span></span><br><span class="line">    MMWDEMO_UART_MSG_RANGE_PROFILE = <span class="number">2</span></span><br><span class="line">    maxBufferSize = <span class="number">2</span> ** <span class="number">15</span></span><br><span class="line">    tlvHeaderLengthInBytes = <span class="number">8</span></span><br><span class="line">    pointLengthInBytes = <span class="number">16</span></span><br><span class="line">    magicWord = [<span class="number">2</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize variables</span></span><br><span class="line">    magicOK = <span class="number">0</span>  <span class="comment"># Checks if magic number has been read</span></span><br><span class="line">    dataOK = <span class="number">0</span>  <span class="comment"># Checks if the data has been read correctly</span></span><br><span class="line">    frameNumber = <span class="number">0</span></span><br><span class="line">    detObj = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    readBuffer = Dataport.read(Dataport.in_waiting)</span><br><span class="line">    byteVec = np.frombuffer(readBuffer, dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">    byteCount = <span class="built_in">len</span>(byteVec)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that the buffer is not full, and then add the data to the buffer</span></span><br><span class="line">    <span class="keyword">if</span> (byteBufferLength + byteCount) &lt; maxBufferSize:</span><br><span class="line">        byteBuffer[byteBufferLength:(byteBufferLength + byteCount)] = byteVec[<span class="number">0</span>:byteCount]</span><br><span class="line">        byteBufferLength = byteBufferLength + byteCount</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that the buffer has some data</span></span><br><span class="line">    <span class="keyword">if</span> byteBufferLength &gt; <span class="number">16</span>:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check for all possible locations of the magic word</span></span><br><span class="line">        possibleLocs = np.where(byteBuffer == magicWord[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Confirm that is the beginning of the magic word and store the index in startIdx</span></span><br><span class="line">        startIdx = []</span><br><span class="line">        <span class="keyword">for</span> loc <span class="keyword">in</span> possibleLocs:</span><br><span class="line">            check = byteBuffer[loc:loc + <span class="number">8</span>]</span><br><span class="line">            <span class="keyword">if</span> np.<span class="built_in">all</span>(check == magicWord):</span><br><span class="line">                startIdx.append(loc)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check that startIdx is not empty</span></span><br><span class="line">        <span class="keyword">if</span> startIdx:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Remove the data before the first start index</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt; startIdx[<span class="number">0</span>] &lt; byteBufferLength:</span><br><span class="line">                byteBuffer[:byteBufferLength - startIdx[<span class="number">0</span>]] = byteBuffer[startIdx[<span class="number">0</span>]:byteBufferLength]</span><br><span class="line">                byteBuffer[byteBufferLength - startIdx[<span class="number">0</span>]:] = np.zeros(<span class="built_in">len</span>(byteBuffer[byteBufferLength - startIdx[<span class="number">0</span>]:]),</span><br><span class="line">                                                                       dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">                byteBufferLength = byteBufferLength - startIdx[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check that there have no errors with the byte buffer length</span></span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span>:</span><br><span class="line">                byteBufferLength = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Read the total packet length</span></span><br><span class="line">            totalPacketLen = <span class="built_in">int</span>.from_bytes(byteBuffer[<span class="number">12</span>:<span class="number">12</span> + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check that all the packet has been read</span></span><br><span class="line">            <span class="keyword">if</span> (byteBufferLength &gt;= totalPacketLen) <span class="keyword">and</span> (byteBufferLength != <span class="number">0</span>):</span><br><span class="line">                magicOK = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If magicOK is equal to 1 then process the message</span></span><br><span class="line">    <span class="keyword">if</span> magicOK:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize the pointer index</span></span><br><span class="line">        idX = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read the header</span></span><br><span class="line">        magicNumber = byteBuffer[idX:idX + <span class="number">8</span>]</span><br><span class="line">        idX += <span class="number">8</span></span><br><span class="line">        version = <span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        totalPacketLen = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        platform = <span class="built_in">format</span>(<span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        frameNumber = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        timeCpuCycles = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        numDetectedObj = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        numTLVs = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line">        subFrameNumber = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        idX += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read the TLV messages</span></span><br><span class="line">        <span class="keyword">for</span> tlvIdx <span class="keyword">in</span> <span class="built_in">range</span>(numTLVs):</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check the header of the TLV message</span></span><br><span class="line">            tlv_type = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            idX += <span class="number">4</span></span><br><span class="line">            tlv_length = <span class="built_in">int</span>.from_bytes(byteBuffer[idX:idX + <span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            idX += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Read the data depending on the TLV message</span></span><br><span class="line">            <span class="keyword">if</span> tlv_type == MMWDEMO_UART_MSG_DETECTED_POINTS:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Initialize the arrays</span></span><br><span class="line">                x = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line">                y = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line">                z = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line">                velocity = np.zeros(numDetectedObj, dtype=np.float32)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> objectNum <span class="keyword">in</span> <span class="built_in">range</span>(numDetectedObj):</span><br><span class="line">                    <span class="comment"># Read the data for each object</span></span><br><span class="line">                    x[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line">                    y[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line">                    z[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line">                    velocity[objectNum] = byteBuffer[idX:idX + <span class="number">4</span>].view(dtype=np.float32)</span><br><span class="line">                    idX += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Store the data in the detObj dictionary</span></span><br><span class="line">                detObj = &#123;<span class="string">&quot;numObj&quot;</span>: numDetectedObj, <span class="string">&quot;x&quot;</span>: x, <span class="string">&quot;y&quot;</span>: y, <span class="string">&quot;z&quot;</span>: z, <span class="string">&quot;velocity&quot;</span>: velocity&#125;</span><br><span class="line">                dataOK = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove already processed data</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; idX &lt; byteBufferLength:</span><br><span class="line">            shiftSize = totalPacketLen</span><br><span class="line"></span><br><span class="line">            byteBuffer[:byteBufferLength - shiftSize] = byteBuffer[shiftSize:byteBufferLength]</span><br><span class="line">            byteBuffer[byteBufferLength - shiftSize:] = np.zeros(<span class="built_in">len</span>(byteBuffer[byteBufferLength - shiftSize:]),</span><br><span class="line">                                                                 dtype=<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">            byteBufferLength = byteBufferLength - shiftSize</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check that there are no errors with the buffer length</span></span><br><span class="line">            <span class="keyword">if</span> byteBufferLength &lt; <span class="number">0</span>:</span><br><span class="line">                byteBufferLength = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataOK, frameNumber, detObj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Funtion to update the data and display in the plot</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>():</span></span><br><span class="line">    dataOk = <span class="number">0</span></span><br><span class="line">    <span class="keyword">global</span> detObj, confirmedroot, testroot, Z_k_prev, GLScatterPlot</span><br><span class="line">    <span class="keyword">global</span> show, cnt</span><br><span class="line">    x = []</span><br><span class="line">    y = []</span><br><span class="line">    z = []</span><br><span class="line">    mask = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read and parse the received data</span></span><br><span class="line">    dataOk, frameNumber, detObj = readAndParseData68xx(Dataport, configParameters)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> dataOk:</span><br><span class="line">        x = detObj[<span class="string">&quot;x&quot;</span>]</span><br><span class="line">        y = detObj[<span class="string">&quot;y&quot;</span>]</span><br><span class="line">        z = detObj[<span class="string">&quot;z&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(x) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                core_samples, cluster_ids = dbscan(np.vstack((x, y, z)).T, eps=<span class="number">0.3</span>, min_samples=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="comment"># print(np.vstack((x, y, z)).T)</span></span><br><span class="line">                <span class="keyword">return</span> dataOk</span><br><span class="line">            df = pandas.DataFrame(np.c_[np.vstack((x, y, z)).T, cluster_ids],</span><br><span class="line">                                  columns=[<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;cluster_id&#x27;</span>])</span><br><span class="line">            df = df[df.cluster_id != -<span class="number">1</span>]</span><br><span class="line">            count = df[<span class="string">&#x27;cluster_id&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">            x = []</span><br><span class="line">            y = []</span><br><span class="line">            z = []</span><br><span class="line">            <span class="keyword">if</span> count.shape[<span class="number">0</span>] &gt;= <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, count.shape[<span class="number">0</span>]):</span><br><span class="line">                    df1 = df[df.cluster_id == i]</span><br><span class="line">                    <span class="comment"># mean = np.mean([df1[&#x27;x&#x27;], df1[&#x27;y&#x27;], df1[&#x27;z&#x27;]], 1)</span></span><br><span class="line">                    x = numpy.hstack((x, df1[<span class="string">&#x27;x&#x27;</span>].values))</span><br><span class="line">                    y = numpy.hstack((y, df1[<span class="string">&#x27;y&#x27;</span>].values))</span><br><span class="line">                    z = numpy.hstack((z, df1[<span class="string">&#x27;z&#x27;</span>].values))</span><br><span class="line">                <span class="comment"># Z_k = np.vstack((x, y, z)).T</span></span><br><span class="line">                <span class="comment"># if cnt==1:</span></span><br><span class="line">                <span class="comment">#     show = Z_k</span></span><br><span class="line">                <span class="comment">#     cnt += 1</span></span><br><span class="line">                <span class="comment"># elif cnt&lt;changdu:</span></span><br><span class="line">                <span class="comment">#     show = numpy.vstack((show,Z_k))</span></span><br><span class="line">                <span class="comment">#     cnt+=1</span></span><br><span class="line">                <span class="comment"># elif cnt==changdu:</span></span><br><span class="line">                <span class="comment">#     cnt = 1</span></span><br><span class="line">                <span class="comment">#     show = numpy.vstack((show, Z_k))</span></span><br><span class="line">                <span class="comment">#     GLScatterPlot.setData(pos=show)</span></span><br><span class="line"></span><br><span class="line">                Z_k = np.vstack((x, y, z)).T</span><br><span class="line">                GLScatterPlot.setData(pos=Z_k, color=(<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">.9</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># confirmedroot, testroot, Z_k_prev = MOT(Z_k, Z_k_prev, confirmedroot, testroot)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if len(confirmedroot) &gt; 0:</span></span><br><span class="line">        <span class="comment">#     tmppos = confirmedroot[0].est[0:3, :].T.A</span></span><br><span class="line">        <span class="comment">#     for i in range(1,len(confirmedroot)):</span></span><br><span class="line">        <span class="comment">#         tmppos = numpy.vstack((tmppos,confirmedroot[i].est[0:3, :].T.A))</span></span><br><span class="line">        <span class="comment">#     LinePlot.setData(pos=tmppos)</span></span><br><span class="line">        <span class="comment">#     QtGui.QApplication.processEvents()</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     LinePlot.setData(pos=np.array([100, 100, 100]))</span></span><br><span class="line">        <span class="comment">#     QtGui.QApplication.processEvents()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------    MAIN   -----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configurate the serial port</span></span><br><span class="line">CLIport, Dataport = serialConfig(configFileName)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the configuration parameters from the configuration file</span></span><br><span class="line">configParameters = parseConfigFile(configFileName)</span><br><span class="line"></span><br><span class="line"><span class="comment"># START QtAPPfor the plot</span></span><br><span class="line">app = QtGui.QApplication([])</span><br><span class="line"></span><br><span class="line">app = pg.mkQApp()</span><br><span class="line"></span><br><span class="line">view = gl.GLViewWidget()</span><br><span class="line"></span><br><span class="line">view.show()</span><br><span class="line"></span><br><span class="line">axis = gl.GLAxisItem()</span><br><span class="line">axis.scale(<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">view.addItem(axis)</span><br><span class="line"></span><br><span class="line">GLScatterPlot = gl.GLScatterPlotItem()</span><br><span class="line">view.addItem(GLScatterPlot)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Main loop</span></span><br><span class="line"></span><br><span class="line">timer = pg.QtCore.QTimer()</span><br><span class="line">timer.timeout.connect(update)  <span class="comment"># 定时调用plotData函数</span></span><br><span class="line">timer.start(<span class="number">50</span>)  <span class="comment"># 多少ms调用一次</span></span><br><span class="line"></span><br><span class="line">app.exec_()</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/05/08/%E9%9B%B7%E8%BE%BE%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/mmWaveSensing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/08/%E9%9B%B7%E8%BE%BE%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/mmWaveSensing/" class="post-title-link" itemprop="url">mmWaveSensing文献概要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-08 10:51:59" itemprop="dateCreated datePublished" datetime="2021-05-08T10:51:59+08:00">2021-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-09 15:27:08" itemprop="dateModified" datetime="2021-05-09T15:27:08+08:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Radar-Signal-Processing/" itemprop="url" rel="index"><span itemprop="name">Radar Signal Processing</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近一直在follow <em>Yingying Chen</em>和<em>Dina  Katabi</em>组的工作，那就先从19年Yingying Chen组里Jian Liu等人发的survey开始看起</p>
<p><strong>Wireless Sensing for Human Activity: A Survey</strong>(10.1109/COMST.2019.2934489)</p>
<p>目前典型的Wireless Sensing的workflow<br><img src="/2021/05/08/%E9%9B%B7%E8%BE%BE%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/mmWaveSensing/wirelesssensingworkflow.png" alt></p>
<p>对WIFI sensing的SOA大致分成了4类</p>
<ol>
<li>intrusion detection &amp; occupancy monitoring</li>
<li>activ-ity &amp; gesture recognition</li>
<li>vital signs monitoring</li>
<li>useridentification &amp; localization.</li>
</ol>
<p>对Wireless sensing中的关键技术也是4类</p>
<ol>
<li>Received signal strength indicator (RSSI)</li>
<li>channel stateinformation (CSI)</li>
<li>frequency shift for frequency modulatedcarrier wave (FMCW)</li>
<li>Doppler shift</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Clustering/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Clustering/" class="post-title-link" itemprop="url">Clustering</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-08 10:50:21" itemprop="dateCreated datePublished" datetime="2021-05-08T10:50:21+08:00">2021-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-09 15:52:41" itemprop="dateModified" datetime="2021-05-09T15:52:41+08:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2020/12/01/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/BPnetwork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/01/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/BPnetwork/" class="post-title-link" itemprop="url">BP-Network</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-01 21:56:47" itemprop="dateCreated datePublished" datetime="2020-12-01T21:56:47+08:00">2020-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-09 15:49:17" itemprop="dateModified" datetime="2021-05-09T15:49:17+08:00">2021-05-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Defination"><a href="#Defination" class="headerlink" title="Defination"></a>Defination</h3><p>desired output $\boldsymbol{d}\in \mathbb{R}^{1\times 1}$</p>
<p>1st laywer input  $\boldsymbol{x}^{(1)}\in \mathbb{R}^{n\times 1}$</p>
<p>1st laywer weight $\boldsymbol{W}^{(1)}\in \mathbb{R}^{m\times n}$</p>
<p>1st laywer bias $\boldsymbol{b}^{(1)}\in \mathbb{R}^{m\times 1}$</p>
<p>1st laywer output $\boldsymbol{z}^{(1)}\in \mathbb{R}^{m\times 1}$</p>
<p>2st laywer input  $\boldsymbol{x}^{(2)}\in \mathbb{R}^{m\times 1}$</p>
<p>2nd laywer weight $\boldsymbol{W}^{(2)}\in \mathbb{R}^{1\times m}$</p>
<p>2nd laywer bias $\boldsymbol{b}^{(2)}\in \mathbb{R}^{1\times 1}$</p>
<p>2st laywer output $\boldsymbol{z}^{(2)}\in \mathbb{R}^{1\times 1}$</p>
<p>output $\boldsymbol{y} \in \mathbb{R}^{1\times 1}$</p>
<h3 id="Activation-function"><a href="#Activation-function" class="headerlink" title="Activation function:"></a>Activation function:</h3><ol>
<li><p>sigmod</p>
<script type="math/tex; mode=display">
 f(x) = \frac{1}{1+e^{-x}}\\
 f'(x) = f(x)(1-f(x))</script></li>
<li><p>RELU</p>
<script type="math/tex; mode=display">
 f(x) =\left\{
 \begin{matrix}
 x \ x>0\\
 0 \ x\leq0
 \end{matrix}\right.\\
 f'(x)= \left\{
 \begin{matrix}
 1 \ x>0\\
 0 \ x\leq0
 \end{matrix}\right.</script></li>
</ol>
<h3 id="forward-propagation"><a href="#forward-propagation" class="headerlink" title="forward propagation"></a>forward propagation</h3><script type="math/tex; mode=display">
\left\{
\begin{aligned}
&\boldsymbol{z}^{(1)} = \boldsymbol{W}^{(1)}\boldsymbol{x}^{(1)}+\boldsymbol{b}^{(1)}\\
&\boldsymbol{x}^{(2)} = f(\boldsymbol{z}^{(1)})\\
&\boldsymbol{z}^{(2)} = \boldsymbol{W}^{(2)}\boldsymbol{x}^{(2)}+\boldsymbol{b}^{(2)}\\
&\boldsymbol{y}=f(\boldsymbol{z}^{(2)})
\end{aligned}
\right.</script><h3 id="Define-Loss-function-J-boldsymbol-cdot"><a href="#Define-Loss-function-J-boldsymbol-cdot" class="headerlink" title="Define Loss function$J(\boldsymbol{\cdot})$"></a>Define Loss function$J(\boldsymbol{\cdot})$</h3><script type="math/tex; mode=display">
J(\boldsymbol{W}^{(1)},\boldsymbol{W}^{(2)},\boldsymbol{b}^{(1)},\boldsymbol{b}^{(2)})
=\frac{1}{2}\boldsymbol{e}^2</script><script type="math/tex; mode=display">
\boldsymbol{e}^2=\Vert \boldsymbol{y}-\boldsymbol{d} \Vert_2^2=(\boldsymbol{y}-\boldsymbol{d})^T(\boldsymbol{y}-\boldsymbol{d})</script><p>Take the derivative of the loss function</p>
<script type="math/tex; mode=display">
\left\{
\begin{aligned}
\Delta J_{\boldsymbol{b}^{(2)}}&=-ey(1-y)\\
\Delta J_{\boldsymbol{W}^{(2)}}&=-ey(1-y){\boldsymbol{x}^{(2)}}^T\\
\Delta J_{\boldsymbol{b}^{(1)}}&=-ey(1-y){\boldsymbol{W}^{(2)}}^T\cdot\boldsymbol{x}^{(2)}\cdot(1-\boldsymbol{x}^{(2)})\\
\Delta J_{\boldsymbol{W}^{(1)}}&=-ey(1-y){\boldsymbol{W}^{(2)}}\boldsymbol{x}^{(2)}\cdot(1-\boldsymbol{x}^{(2)})\boldsymbol{x}^{(1)}\\
\end{aligned}
\right.</script><h3 id="Back-propagation"><a href="#Back-propagation" class="headerlink" title="Back propagation"></a>Back propagation</h3><p>Learning step $\mu$</p>
<script type="math/tex; mode=display">
\left\{
\begin{aligned}
\boldsymbol{b}^{(2)}_{new} &= \boldsymbol{b}^{(2)}_{old} + \mu\Delta J_{\boldsymbol{b}^{(2)}}\\
\boldsymbol{W}^{(2)}_{new} &= \boldsymbol{W}^{(2)}_{old} + \mu\Delta J_{\boldsymbol{W}^{(2)}}\\
\boldsymbol{b}^{(1)}_{new} &= \boldsymbol{b}^{(1)}_{old} + \mu\Delta J_{\boldsymbol{b}^{(1)}}\\
\boldsymbol{W}^{(1)}_{new} &= \boldsymbol{W}^{(1)}_{old} + \mu\Delta J_{\boldsymbol{W}^{(1)}}
\end{aligned}
\right.</script><h3 id="Simulation"><a href="#Simulation" class="headerlink" title="Simulation"></a>Simulation</h3><p><img src="/2020/12/01/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/BPnetwork/BPfit.png" alt></p>
<p><img src="/2020/12/01/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/BPnetwork/BPfiterror.png" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2020/07/17/%E7%9B%AE%E6%A0%87%E8%B7%9F%E8%B8%AA%E6%95%B0%E6%8D%AE%E5%85%B3%E8%81%94/%E8%81%94%E5%90%88%E6%A6%82%E7%8E%87%E6%95%B0%E6%8D%AE%E4%BA%92%E8%81%94%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="YXY">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bulijiojio Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/17/%E7%9B%AE%E6%A0%87%E8%B7%9F%E8%B8%AA%E6%95%B0%E6%8D%AE%E5%85%B3%E8%81%94/%E8%81%94%E5%90%88%E6%A6%82%E7%8E%87%E6%95%B0%E6%8D%AE%E4%BA%92%E8%81%94%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">联合概率数据互联算法（JPDA）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-17 15:01:30" itemprop="dateCreated datePublished" datetime="2020-07-17T15:01:30+08:00">2020-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-08 10:36:53" itemprop="dateModified" datetime="2021-05-08T10:36:53+08:00">2021-05-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tracking/" itemprop="url" rel="index"><span itemprop="name">Tracking</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- # 联合概率数据互联算法（JPDA） -->
<h2 id="JPDA的基本模型"><a href="#JPDA的基本模型" class="headerlink" title="JPDA的基本模型"></a>JPDA的基本模型</h2><h3 id="确认矩阵"><a href="#确认矩阵" class="headerlink" title="确认矩阵"></a>确认矩阵</h3><script type="math/tex; mode=display">
\left.\boldsymbol{\Omega}=\left[\omega_{j t}\right]=\overbrace{
\left[\begin{array}{ccc}
\omega_{10} & \cdots & \omega_{1 T} \\
\vdots & \cdots & \vdots \\
\omega_{m_{k} 0} & \cdots & \omega_{m_{k} T}
\end{array}\right]}^t\right\}j</script><p>比如有这样一个情况<br><img src="/2020/07/17/%E7%9B%AE%E6%A0%87%E8%B7%9F%E8%B8%AA%E6%95%B0%E6%8D%AE%E5%85%B3%E8%81%94/%E8%81%94%E5%90%88%E6%A6%82%E7%8E%87%E6%95%B0%E6%8D%AE%E4%BA%92%E8%81%94%E7%AE%97%E6%B3%95/fa2fa2ce95be726b453492865a474ed6.png" alt="fa2fa2ce95be726b453492865a474ed6.png"><br>那么根据规则可以建立确认矩阵</p>
<script type="math/tex; mode=display">
\left.\boldsymbol{\Omega}=\left[\omega_{j t}\right]=\left[\begin{array}{ccc}
1 & 1 & 0 \\
1 & 1 & 1 \\
1 & 0 & 1
\end{array}\right] \begin{array}{l}
1 \\
2 \\
3
\end{array}\right\}j</script><h3 id="互联矩阵（联合事件）"><a href="#互联矩阵（联合事件）" class="headerlink" title="互联矩阵（联合事件）"></a>互联矩阵（联合事件）</h3><p>联合事件与互联矩阵一一对应<br>所谓互联矩阵，用之前的例子举例就是将$\Omega$拆分成</p>
<script type="math/tex; mode=display">
\begin{array}{l}
\hat{\Omega}\left[\theta_{1}(k)\right]=\left[\begin{array}{lll}
1 & 0 & 0 \\
1 & 0 & 0 \\
1 & 0 & 0
\end{array}\right] 
\hat{\Omega}\left[\theta_{2}(k)\right]=\left[\begin{array}{lll}
0 & 1 & 0 \\
1 & 0 & 0 \\
1 & 0 & 0
\end{array}\right] \\
\hat{\Omega}\left[\theta_{3}(k)\right] =\left[\begin{array}{lll}
0 & 1 & 0 \\
0 & 0 & 1 \\
1 & 0 & 0
\end{array}\right] 
\hat{\Omega}\left[\theta_{4}(k)\right] =\left[\begin{array}{lll}
0 & 1 & 0 \\
1 & 0 & 0 \\
0 & 0 & 1
\end{array}\right] \\
\hat{\Omega}\left[\theta_{5}(k)\right] =\left[\begin{array}{lll}
1 & 0 & 0 \\
0 & 1 & 0 \\
1 & 0 & 0
\end{array}\right] 
\hat{\Omega}\left[\theta_{6}(k)\right] =\left[\begin{array}{lll}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1
\end{array}\right] \\
\hat{\Omega}\left[\theta_{7}(k)\right] =\left[\begin{array}{lll}
1 & 0 & 0 \\
0 & 0 & 1 \\
1 & 0 & 0
\end{array}\right] 
\hat{\Omega}\left[\theta_{8}(k)\right]= {\left[\begin{array}{lll}
1 & 0 & 0 \\
1 & 0 & 0 \\
0 & 0 & 1
\end{array}\right]}
\end{array}</script><h3 id="互联概率的计算"><a href="#互联概率的计算" class="headerlink" title="互联概率的计算"></a>互联概率的计算</h3><p><strong>符号定义：</strong></p>
<ol>
<li><p>$\theta_i(k)$:表示第 $i$ 个联合事件</p>
</li>
<li><p>$\hat{\Omega}\left[\theta_{i}(k)\right]$:表示与第 $i$ 个联合事件对应的互联矩阵</p>
<script type="math/tex; mode=display">
\left.\hat{\Omega}\left(\theta_{i}(k)\right)=\left[\hat{\omega}_{j t}^{i}\left(\theta_{i}(k)\right)\right]=\left[\begin{array}{ccc}
\hat{\omega}_{10}^{i} & \cdots & \hat{\omega}_{1 T}^{i} \\
\vdots & \cdots & \vdots \\
\hat{\omega}_{m_{k} 0}^{i} & \cdots & \hat{\omega}_{m_{k} T}^{i}
\end{array}\right]\right\} j \quad j=1,2, \cdots, m_{k} ; i=1,2, \cdots, n_{k} ; t=0,1, \cdots, T</script><p>根据上述两个基本假设容易推出互联矩阵满足：</p>
<script type="math/tex; mode=display">
\begin{array}{ll}
\sum_{t=0}^{T} \hat{\omega}_{j t}^{i}\left[\theta_{i}(k)\right]=1, & j=1,2, \cdots, m_{k} \\
\sum_{j=1}^{m_{k}} \hat{\omega}_{j t}^{i}\left[\theta_{i}(k)\right] \leqslant 1, & t=1,2, \cdots, T
\end{array}</script><p>用文字叙述就是：<br><em>每一个量测只来源于一个目标或者是杂波虚警</em><br><em>每一个目标只有一个或者没有量测</em></p>
</li>
<li><p>$\theta_{jt}(k)$:测量 $j$ 源于目标 $t(1\leq t \leq T)$ 的事件,$\theta_{0t}$ 表示目标是杂波或者虚警</p>
</li>
<li><p>$\beta_{jt}(k)$:表示第 $j$ 个测量与 $t$ 互联的概率,且</p>
<script type="math/tex; mode=display">
\sum_{j=0}^{m_{k}} \beta_{j t}(k)=1</script></li>
<li><p>$\theta_{j t}^{i}(k)$:量测 $j$ 在第 $i$ 个联合事件中源于目标 $t(0 \leqslant t \leqslant T)$ 的事件</p>
</li>
<li><p>$\hat{\omega}_{j t}^{i}\left(\theta_{i}(k)\right)$:表示在第 i 个联合事件中，量测 j 是否源于目标 $t,$ 在量测 j 源于目标 $t$ 时为 $1,$ 否则为 0</p>
<script type="math/tex; mode=display">
\hat{\omega}_{j t}^{i}\left(\theta_{i}(k)\right)=\left\{\begin{array}{ll}
1, & \text { 若 } \theta_{j t}^{i}(k) \subset \theta_{i}(k) \\
0, & \text { 其他 }
\end{array}\right.</script></li>
</ol>
<p><strong>状态估计计算</strong><br>则 $k$ 时刻目标 $t$ 的状态估计为</p>
<script type="math/tex; mode=display">
\hat{\boldsymbol{X}}^{t}(k \mid k)=\mathrm{E}\left[\boldsymbol{X}^{t}(k) \mid \boldsymbol{Z}^{k}\right]=\sum_{j=0}^{m_{k}} \mathrm{E}\left[\boldsymbol{X}^{t}(k) \mid \theta_{j t}(k), \boldsymbol{Z}^{k}\right] \operatorname{Pr}\left\{\theta_{j t}(k) \mid \boldsymbol{Z}^{k}\right\}=\sum_{j=0}^{m_{k}} \beta_{j t}(k) \hat{\boldsymbol{X}}_{j}^{t}(k \mid k)</script><p>式中</p>
<script type="math/tex; mode=display">
\hat{\boldsymbol{X}}_{j}^{t}(k \mid k)=\mathrm{E}\left[\boldsymbol{X}^{t}(k) \mid \theta_{j t}(k), \boldsymbol{Z}^{k}\right], \quad j=0,1, \cdots, m_{k}</script><p>表示在 $k$ 时刻用第 $j$ 个量测对目标 $t$ 进行卡尔曼滤波所得的状态估计。<br>$\hat{\boldsymbol{X}}_{0}^{t}(k \mid k)$ 表示 $k$时刻没有量测源于目标的情况，这时需要用预测值 $\hat{\boldsymbol{X}}^{t}(k \mid k-1)$ 来代替，即：</p>
<script type="math/tex; mode=display">
\hat{\boldsymbol{X}}_{0}^{t}(k \mid k) = \hat{\boldsymbol{X}}^{t}(k \mid k-1)</script><p><strong>概率计算</strong><br>第 $j$ 个量测与目标互联的概率可利用下式求取：</p>
<script type="math/tex; mode=display">
\beta_{j t}(k)=\operatorname{Pr}\left\{\theta_{j t}(k) \mid Z^{k}\right\}=\operatorname{Pr}\left\{\bigcup_{i=1}^{n_{k}} \theta_{j t}^{i}(k) \mid Z^{k}\right\}=\sum_{i=1}^{n_{k}} \hat{\omega}_{j t}^{i}\left[\theta_{i}(k)\right] \operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\}</script><p>可以看到求取状态估计 $\hat{\boldsymbol{X}}^{t}(k \mid k)$ 的关键就是计算联合事件概率(后验条件概率) $\operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\}$</p>
<h2 id="联合事件概率计算"><a href="#联合事件概率计算" class="headerlink" title="联合事件概率计算"></a>联合事件概率计算</h2><p>为了以后讨论问题的方便，这里引入两个二元指示变量:<br>(1) 量测互联指示，即</p>
<script type="math/tex; mode=display">
\tau_{j}\left[\theta_{i}(k)\right]=\sum_{t=1}^{T} \hat{\omega}_{j t}^{i}\left(\theta_{i}(k)\right)=\left\{\begin{array}{l}
1 \\
0
\end{array}\right.</script><p>表示量测 j 在联合事件 $\theta_{i}(k)$ 中是否跟一个真实目标互联:<br>(2) 目标检测指示，即</p>
<script type="math/tex; mode=display">
\delta_{t}\left[\theta_{i}(k)\right]=\sum_{j=1}^{m_{k}} \hat{\omega}_{j t}^{i}\left[\theta_{i}(k)\right]=\left\{\begin{array}{l}
1 \\
0
\end{array}\right.</script><p>表示任一量测在联合事件 $\theta_{i}(k)$ 中是否与目标 $t$ 互联，也即目标 $t$ 是否被检测。<br>设 $\phi\left[\theta_{i}(k)\right]$ 表示在联合事件 $\theta_{i}(k)$ 中假量测的数量，则</p>
<script type="math/tex; mode=display">
\phi\left[\theta_{i}(k)\right]=\sum_{j=1}^{m_{k}}\left\{1-\tau_{j}\left[\theta_{i}(k)\right]\right\}</script><p>核心问题：求解 $\operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\}$</p>
<p>一看这形式老朋友了，贝叶斯推论三步走起</p>
<script type="math/tex; mode=display">
\begin{aligned}
\operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\} &=\operatorname{Pr}\left\{\theta_{i}(k) \mid Z(k), Z^{k-1}\right\}=\frac{1}{c} p\left[Z(k) \mid \theta_{i}(k), Z^{k-1}\right] \operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k-1}\right\} \\
&=\frac{1}{c} p\left[Z(k) \mid \theta_{i}(k), Z^{k-1}\right] \operatorname{Pr}\left\{\theta_{i}(k)\right\}
\end{aligned}</script><p>式中，c 为归一化常数</p>
<script type="math/tex; mode=display">
c=\sum_{i=0}^{n_{k}} p\left[\boldsymbol{Z}(k) \mid \theta_{j}(k), \boldsymbol{Z}^{k-1}\right] \operatorname{Pr}\left\{\boldsymbol{\theta}_{j}(k)\right\}</script><p>似然函数：</p>
<script type="math/tex; mode=display">
p\left[\boldsymbol{Z}(k) \mid \theta_{i}(k), \boldsymbol{Z}^{k-1}\right]=\prod_{j=1}^{m_{k}} p\left[\boldsymbol{z}_{j}(k) \mid \theta_{j t}^{i}(k), \boldsymbol{Z}^{k-1}\right]=V^{-\phi\left[\theta_{i}(k)\right]} \prod_{j=1}^{m_{k}} \mathrm{N}_{t}\left[z_{j}(k)\right]^{\tau_{j}\left[\theta_{i}(k)\right]}</script><p>其中</p>
<script type="math/tex; mode=display">
p\left[\boldsymbol{z}_{j}(k) \mid \theta_{j t}^{i}(k), \boldsymbol{Z}^{k-1}\right]=\left\{\begin{array}{l}
\mathbf{N}_{t}\left[\boldsymbol{z}_{j}(k)\right], \text { 若 } \tau_{j}\left[\theta_{i}(k)\right]=1 \\
V^{-1}, \quad \text { 若 } \tau_{j}\left[\theta_{i}(k)\right]=0
\end{array}\right.</script><p>联合事件 $\theta_{i}(k)$ 的先验概率：</p>
<script type="math/tex; mode=display">
\operatorname{Pr}\left\{\theta_{i}(k)\right\}=\frac{\phi\left[\theta_{i}(k)\right] !}{m_{k} !} \mu_{F}\left\{\phi\left[\theta_{i}(k)\right]\right\} \prod_{t=1}^{T}\left(P_{\mathrm{D}}^{t}\right)^{\delta_{t}\left[\theta_{i}(k)\right]}\left(1-P_{\mathrm{D}}^{t}\right)^{1-\delta_{i}\left[\theta_{i}(k)\right]}</script><p>其中</p>
<script type="math/tex; mode=display">
\mu_{F}\left\{\varphi\left[\theta_{i}(k)\right]\right\}=\mathrm{e}^{-\lambda V} \frac{(\lambda V)^{\varphi\left[\theta_{i}(k)\right]}}{\varphi\left[\theta_{i}(k)\right] !}</script><p>最后得到</p>
<script type="math/tex; mode=display">
\operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\}=\frac{1}{c^{\prime \prime}} \frac{\phi\left[\theta_{i}(k)\right] !}{V^{\phi\left[\theta_{i}(k)\right]}} \prod_{j=1}^{m_{k}} N_{t_{j}}\left[\boldsymbol{Z}_{j}(k)\right]^{\tau_{j}\left[\theta_{i}(k)\right]} \prod_{t=1}^{T}\left(P_{\mathrm{D}}^{t}\right)^{\delta_{i}\left[\theta_{i}(k)\right]}\left(1-P_{\mathrm{D}}^{\prime}\right)^{1-\delta_{t}\left[\theta_{i}(k)\right]}</script><h2 id="状态估计协方差计算"><a href="#状态估计协方差计算" class="headerlink" title="状态估计协方差计算"></a>状态估计协方差计算</h2><h3 id="没有测量来自目标"><a href="#没有测量来自目标" class="headerlink" title="没有测量来自目标"></a>没有测量来自目标</h3><script type="math/tex; mode=display">
\boldsymbol{P}_{0}^{t}(k \mid k)=\mathrm{E}\left\{\left[\boldsymbol{X}^{t}(k)-\hat{\boldsymbol{X}}_{0}^{t}(k \mid k)\right]\left[\boldsymbol{X}^{t}(k)-\hat{\boldsymbol{X}}_{0}^{t}(k \mid k)\right]^{\prime} \mid \theta_{0 t}(k), \boldsymbol{Z}^{k}\right\}\\
=\mathrm{E}\left\{\left[\boldsymbol{X}^{t}(k)-\hat{\boldsymbol{X}}^{\prime}(k \mid k-1)\right]\left[\boldsymbol{X}^{t}(k)-\hat{\boldsymbol{X}}^{t}(k \mid k-1)\right]^{\prime} \mid \theta_{0 t}(k), \boldsymbol{Z}^{k}\right\}=\boldsymbol{P}^{t}(k \mid k-1)</script><h3 id="有测量来自目标"><a href="#有测量来自目标" class="headerlink" title="有测量来自目标"></a>有测量来自目标</h3><script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{P}^{t}(k \mid k) &=\boldsymbol{P}^{t}(k \mid k-1)-\left(1-\beta_{0 t}(k)\right) \boldsymbol{K}^{t}(k) \boldsymbol{S}^{t}(k) \boldsymbol{K}^{t^{\prime}}(k) \\
&+\sum_{j=0}^{m_{k}} \beta_{j t}(k) \hat{\boldsymbol{X}}_{j}^{t}(k \mid k) \hat{\boldsymbol{X}}_{j}^{t^{\prime}}(k \mid k)-\hat{\boldsymbol{X}}^{t}(k \mid k) \hat{\boldsymbol{X}}^{t^{\prime}}(k \mid k)
\end{aligned}</script><h2 id="算法仿真"><a href="#算法仿真" class="headerlink" title="算法仿真"></a>算法仿真</h2><p>在航迹起始的基础上进行仿真<br><figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">clc</span><br><span class="line">clear <span class="built_in">all</span></span><br><span class="line">close <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line">load(<span class="string">&#x27;Root.mat&#x27;</span>);</span><br><span class="line">load(<span class="string">&#x27;points.mat&#x27;</span>);</span><br><span class="line"></span><br><span class="line">points <span class="built_in">=</span> points(<span class="number">11</span>:end);</span><br><span class="line">n <span class="built_in">=</span> size(points,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">n_z <span class="built_in">=</span> <span class="number">2</span>;</span><br><span class="line">gamma <span class="built_in">=</span> chi2inv(<span class="number">0.99</span>,n_z);</span><br><span class="line">P_G <span class="built_in">=</span> PG(gamma,n_z);</span><br><span class="line"></span><br><span class="line">T <span class="built_in">=</span> <span class="number">1</span>;</span><br><span class="line">F <span class="built_in">=</span> [<span class="number">1</span> <span class="number">0</span> T <span class="number">0</span>;</span><br><span class="line">     <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> T;</span><br><span class="line">     <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span>;</span><br><span class="line">     <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>];</span><br><span class="line">H <span class="built_in">=</span> [<span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">     <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>];</span><br><span class="line">Gamma<span class="built_in">=</span>[T*T/<span class="number">2</span> <span class="number">0</span>;<span class="number">0</span> T*T/<span class="number">2</span>;T <span class="number">0</span>;<span class="number">0</span> T];</span><br><span class="line">Q <span class="built_in">=</span> <span class="number">0.01</span>*Gamma*Gamma<span class="string">&#x27;;%根据实际过程噪声的协方差更改</span></span><br><span class="line"><span class="string">R = 5*H*H&#x27;</span>;  <span class="comment">%根据实际测量误差的协方差更改</span></span><br><span class="line"></span><br><span class="line">for kk <span class="built_in">=</span><span class="number">1</span>:n</span><br><span class="line">    Z_k <span class="built_in">=</span> cell2mat(points(kk));</span><br><span class="line">    t <span class="built_in">=</span> size(Root,<span class="number">2</span>); <span class="comment">% 目标数 </span></span><br><span class="line">    mk <span class="built_in">=</span> size(Z_k,<span class="number">2</span>); <span class="comment">%有效测量数</span></span><br><span class="line">    </span><br><span class="line">    for i <span class="built_in">=</span> <span class="number">1</span>:t</span><br><span class="line">        P(:,:,i)<span class="built_in">=</span>F*Root(i).pkk*F<span class="string">&#x27;+Q;</span></span><br><span class="line"><span class="string">        S(:,:,i) = H*P(:,:,i)*H&#x27;</span> + R;</span><br><span class="line">        K(:,:,i)<span class="built_in">=</span> P(:,:,i)*H<span class="string">&#x27;*inv(S(:,:,i));</span></span><br><span class="line"><span class="string">        Z_predict(:,i) = H*Root(i).x_predict;</span></span><br><span class="line"><span class="string">        Volume(i)=ellipse_Volume(gamma,n_z,S(:,:,i));</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    %% 建立确认矩阵</span></span><br><span class="line"><span class="string">    Omega = zeros(mk,t+1);%确认矩阵</span></span><br><span class="line"><span class="string">    Z_set = [];</span></span><br><span class="line"><span class="string">    for j = 1:t</span></span><br><span class="line"><span class="string">        for k = 1:mk</span></span><br><span class="line"><span class="string">             V=(Z_k(:,k)-Z_predict(:,j))&#x27;</span>*inv(S(:,:,j))*(Z_k(:,k)-Z_predict(:,j));</span><br><span class="line">             <span class="built_in">if</span> (V<span class="built_in">&lt;=</span>gamma)</span><br><span class="line">                Omega(k,<span class="number">1</span>) <span class="built_in">=</span> <span class="number">1</span>;</span><br><span class="line">                Omega(k,j+<span class="number">1</span>) <span class="built_in">=</span> <span class="number">1</span>;</span><br><span class="line">                Z_set <span class="built_in">=</span> [Z_set k]; <span class="comment">% 记录确认矩阵对应的量测 索引</span></span><br><span class="line">             end</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    Z_set <span class="built_in">=</span> unique(Z_set,<span class="string">&#x27;stable&#x27;</span>);</span><br><span class="line">    Omega(<span class="built_in">all</span>(Omega<span class="built_in">=</span><span class="built_in">=</span><span class="number">0</span>,<span class="number">2</span>),:)<span class="built_in">=</span>[]; <span class="comment">%删除确认矩阵的零行</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">%% 建立互联矩阵</span></span><br><span class="line">    hat_omega<span class="built_in">=</span>zeros(size(Omega,<span class="number">1</span>),size(Omega,<span class="number">2</span>),<span class="number">10000</span>); </span><br><span class="line">    hat_omega(:,<span class="number">1</span>,<span class="number">1</span>:<span class="number">10000</span>)<span class="built_in">=</span><span class="number">1</span>; </span><br><span class="line">    num<span class="built_in">=</span><span class="number">1</span>; </span><br><span class="line">    for i<span class="built_in">=</span><span class="number">1</span>:size(Omega,<span class="number">1</span>) </span><br><span class="line">        <span class="built_in">if</span> Omega(i,<span class="number">2</span>)<span class="built_in">=</span><span class="built_in">=</span><span class="number">1</span> </span><br><span class="line">            hat_omega(i,<span class="number">2</span>,num)<span class="built_in">=</span><span class="number">1</span>;hat_omega(i,<span class="number">1</span>,num)<span class="built_in">=</span><span class="number">0</span>; </span><br><span class="line">            num<span class="built_in">=</span>num+<span class="number">1</span>; </span><br><span class="line">            for j<span class="built_in">=</span><span class="number">1</span>:size(Omega,<span class="number">1</span>) </span><br><span class="line">                <span class="built_in">if</span> (i~<span class="built_in">=</span>j)&amp;&amp;(Omega(j,<span class="number">3</span>)<span class="built_in">=</span><span class="built_in">=</span><span class="number">1</span>) </span><br><span class="line">                    hat_omega(i,<span class="number">2</span>,num)<span class="built_in">=</span><span class="number">1</span>;hat_omega(i,<span class="number">1</span>,num)<span class="built_in">=</span><span class="number">0</span>; </span><br><span class="line">                    hat_omega(j,<span class="number">3</span>,num)<span class="built_in">=</span><span class="number">1</span>;hat_omega(j,<span class="number">1</span>,num)<span class="built_in">=</span><span class="number">0</span>; </span><br><span class="line">                    num<span class="built_in">=</span>num+<span class="number">1</span>; </span><br><span class="line">                    for k<span class="built_in">=</span><span class="number">1</span>:size(Omega,<span class="number">1</span>)</span><br><span class="line">                         <span class="built_in">if</span> (k~<span class="built_in">=</span>i)&amp;&amp;(k~<span class="built_in">=</span>j)&amp;&amp;(Omega(k,<span class="number">4</span>)<span class="built_in">=</span><span class="built_in">=</span><span class="number">1</span>) </span><br><span class="line">                            hat_omega(i,<span class="number">2</span>,num)<span class="built_in">=</span><span class="number">1</span>;hat_omega(i,<span class="number">1</span>,num)<span class="built_in">=</span><span class="number">0</span>; </span><br><span class="line">                            hat_omega(j,<span class="number">3</span>,num)<span class="built_in">=</span><span class="number">1</span>;hat_omega(j,<span class="number">1</span>,num)<span class="built_in">=</span><span class="number">0</span>; </span><br><span class="line">                            hat_omega(k,<span class="number">4</span>,num)<span class="built_in">=</span><span class="number">1</span>;hat_omega(k,<span class="number">1</span>,num)<span class="built_in">=</span><span class="number">0</span>; </span><br><span class="line">                            num<span class="built_in">=</span>num+<span class="number">1</span>; </span><br><span class="line">                         end</span><br><span class="line">                     end</span><br><span class="line">                end </span><br><span class="line">            end </span><br><span class="line">        end </span><br><span class="line">    end</span><br><span class="line">    hat_omega<span class="built_in">=</span>hat_omega(:,:,<span class="number">1</span>:num); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 计算theta_i 条件概率</span></span><br><span class="line">    P_D <span class="built_in">=</span> <span class="number">0.5</span>;</span><br><span class="line">    Pr <span class="built_in">=</span> PrthetaZk(hat_omega,t,Z_k,Z_set,Z_predict,S,P_D,sum(Volume));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 计算互联概率 beta</span></span><br><span class="line">    beta <span class="built_in">=</span> zeros(length(Z_set)+<span class="number">1</span>,t);</span><br><span class="line">    for i<span class="built_in">=</span><span class="number">1</span>:t</span><br><span class="line">        for j<span class="built_in">=</span><span class="number">1</span>:length(Z_set)</span><br><span class="line">            for k<span class="built_in">=</span><span class="number">1</span>:num</span><br><span class="line">                beta(j+<span class="number">1</span>,i)<span class="built_in">=</span>beta(j+<span class="number">1</span>,i)+Pr(k)*hat_omega(j,i+<span class="number">1</span>,k);</span><br><span class="line">            end</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    <span class="comment">% 计算j = 0的特殊情况,同时满足归一化</span></span><br><span class="line">    beta(<span class="number">1</span>,:) <span class="built_in">=</span> <span class="number">1</span>-sum(beta(<span class="number">2</span>:end,:));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">%% 计算状态估计X_jt</span></span><br><span class="line">    X_jt <span class="built_in">=</span> cell(length(Z_set)+<span class="number">1</span>,t);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">% 计算j = 0的特殊情况</span></span><br><span class="line">    for i <span class="built_in">=</span> <span class="number">1</span>:t</span><br><span class="line">        X_jt(<span class="number">1</span>,i) <span class="built_in">=</span>  &#123;Root(i).x_predict&#125;;</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    for i <span class="built_in">=</span> <span class="number">1</span>:t</span><br><span class="line">        for j <span class="built_in">=</span> <span class="number">2</span>:length(Z_set)+<span class="number">1</span></span><br><span class="line">            X_jt(j,i) <span class="built_in">=</span> &#123;Root(i).x_predict + K(:,:,i)*(Z_k(:,Z_set(j-<span class="number">1</span>)) - Z_predict(:,i))&#125;;</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    X_t <span class="built_in">=</span> zeros(size(Root(<span class="number">1</span>).x_predict,<span class="number">1</span>),t);</span><br><span class="line">    temp <span class="built_in">=</span> zeros([size(Root(<span class="number">1</span>).pkk) t]);</span><br><span class="line">    for i <span class="built_in">=</span> <span class="number">1</span>:t</span><br><span class="line">    <span class="comment">%% 计算状态估计X_t</span></span><br><span class="line">        for j <span class="built_in">=</span> <span class="number">1</span>:length(Z_set)+<span class="number">1</span></span><br><span class="line">            X_t(:,i) <span class="built_in">=</span> X_t(:,i) + beta(j,i)*X_jt&#123;j,i&#125;;</span><br><span class="line">            temp(:,:,i) <span class="built_in">=</span> temp(:,:,i) +beta(j,i)*X_jt&#123;j,i&#125;*X_jt&#123;j,i&#125;<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">    %% 计算后验协方差</span></span><br><span class="line"><span class="string">        Root(i).pkk = P(:,:,i) - (1-beta(1,i))*K(:,:,i)*S(:,:,i)*K(:,:,i)&#x27;</span>+temp(:,:,i)-X_t(:,i)*X_t(:,i)<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">        Root(i).seq =[Root(i).seq X_t(1:2,i)];</span></span><br><span class="line"><span class="string">        Root(i).est =[Root(i).est X_t(:,i)];</span></span><br><span class="line"><span class="string">        Root(i).x_predict = F*X_t(:,i);</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">figure</span></span><br><span class="line"><span class="string">hold on</span></span><br><span class="line"><span class="string">for j = 1:n</span></span><br><span class="line"><span class="string">    Z = cell2mat(points(j));</span></span><br><span class="line"><span class="string">    plot(Z(1,:),Z(2,:),&#x27;</span>.r<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">for i = 1:t       </span></span><br><span class="line"><span class="string">    Root(i).show;</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">xlabel(&#x27;</span>x轴坐标(m)<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">ylabel(&#x27;</span>y轴坐标(m)<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">title(&#x27;</span>JPDA数据关联<span class="string">&#x27;);</span></span><br></pre></td></tr></table></figure><br>运行结果如下<br><img src="/2020/07/17/%E7%9B%AE%E6%A0%87%E8%B7%9F%E8%B8%AA%E6%95%B0%E6%8D%AE%E5%85%B3%E8%81%94/%E8%81%94%E5%90%88%E6%A6%82%E7%8E%87%E6%95%B0%E6%8D%AE%E4%BA%92%E8%81%94%E7%AE%97%E6%B3%95/JPDA.png" alt><br>JPDA的公式描述看似繁琐但是其实多是在进行二进制的判定,核心仍然是贝叶斯递推,接下来就带着大家进行公式向matlab代码的翻译过程:<br>首先先简单描述一下代码实现的流程,我尽量用白话和公式各描述一遍,在获得了某一量测的时间点:<br><strong>语言描述:</strong></p>
<ol>
<li>根据上一时刻状态估计协方差进行状态预测协方差以及新息协方差计算,以及测量值的预测值计算</li>
<li>根据有效的量测以及目标建立确认矩阵</li>
<li>根据规则对确认矩阵分解为联合事件对应的互联矩阵</li>
<li>计算每一种联合事件的发生概率</li>
<li>根据联合事件发生概率计算量测与目标互联的概率</li>
<li>计算当前时点的目标状态估计</li>
<li>计算目标状态估计的协方差<br><strong>公式描述：</strong>（这里使用线性的贝叶斯迭代也就是kalmanfilter）</li>
<li><script type="math/tex; mode=display">
\begin{array}{c}
\hat{\boldsymbol{X}}(k \mid k-1)=\boldsymbol{F} \hat{\boldsymbol{X}}(k-1 \mid k-1) \\
\boldsymbol{P}(k \mid k-1)=\boldsymbol{F} \boldsymbol{P}(k-1 \mid k-1) \boldsymbol{F}^{\mathrm{T}}+\boldsymbol{Q}_{k}\\
\hat{\boldsymbol{Z}}(k \mid k-1)=\boldsymbol{H} \hat{\boldsymbol{X}}(k \mid k-1)\\
\boldsymbol{S}(k)=\boldsymbol{H} \boldsymbol{P}_{k \mid k-1} \boldsymbol{H}^{\mathrm{T}}+\boldsymbol{R} \\
\boldsymbol{K}(k)=\boldsymbol{P}(k \mid k-1) \boldsymbol{H}^{\mathrm{T}} \boldsymbol{S}(k)^{-1}
\end{array}</script></li>
<li><script type="math/tex; mode=display">
\boldsymbol{\Omega}=\left[\omega_{j t}\right]=
\left[\begin{array}{ccc}
\omega_{10} & \cdots & \omega_{1 T} \\
\vdots & \cdots & \vdots \\
\omega_{m_{k} 0} & \cdots & \omega_{m_{k} T}
\end{array}\right]</script></li>
<li><script type="math/tex; mode=display">
\hat{\Omega}\left(\theta_{i}(k)\right)=\left[\hat{\omega}_{j t}^{i}\left(\theta_{i}(k)\right)\right]=\left[\begin{array}{ccc}
\hat{\omega}_{10}^{i} & \cdots & \hat{\omega}_{1 T}^{i} \\
\vdots & \cdots & \vdots \\
\hat{\omega}_{m_{k} 0}^{i} & \cdots & \hat{\omega}_{m_{k} T}^{i}
\end{array}\right]</script></li>
<li><script type="math/tex; mode=display">
\operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\}=\frac{1}{c^{\prime \prime}} \frac{\phi\left[\theta_{i}(k)\right] !}{V^{\phi\left[\theta_{i}(k)\right]}} \prod_{j=1}^{m_{k}} N_{t_{j}}\left[\boldsymbol{Z}_{j}(k)\right]^{\tau_{j}\left[\theta_{i}(k)\right]} \prod_{t=1}^{T}\left(P_{\mathrm{D}}^{t}\right)^{\delta_{i}\left[\theta_{i}(k)\right]}\left(1-P_{\mathrm{D}}^{\prime}\right)^{1-\delta_{t}\left[\theta_{i}(k)\right]}</script></li>
<li><script type="math/tex; mode=display">
\beta_{j t}(k)=\operatorname{Pr}\left\{\theta_{j t}(k) \mid Z^{k}\right\}=\operatorname{Pr}\left\{\bigcup_{i=1}^{n_{k}} \theta_{j t}^{i}(k) \mid Z^{k}\right\}=\sum_{i=1}^{n_{k}} \hat{\omega}_{j t}^{i}\left[\theta_{i}(k)\right] \operatorname{Pr}\left\{\theta_{i}(k) \mid Z^{k}\right\}</script></li>
<li><script type="math/tex; mode=display">
\hat{\boldsymbol{X}}^{t}(k \mid k)=\mathrm{E}\left[\boldsymbol{X}^{t}(k) \mid \boldsymbol{Z}^{k}\right]=\sum_{j=0}^{m_{k}} \mathrm{E}\left[\boldsymbol{X}^{t}(k) \mid \theta_{j t}(k), \boldsymbol{Z}^{k}\right] \operatorname{Pr}\left\{\theta_{j t}(k) \mid \boldsymbol{Z}^{k}\right\}=\sum_{j=0}^{m_{k}} \beta_{j t}(k) \hat{\boldsymbol{X}}_{j}^{t}(k \mid k)</script>式中<script type="math/tex; mode=display">
\hat{\boldsymbol{X}}_{j}^{t}(k \mid k)=\mathrm{E}\left[\boldsymbol{X}^{t}(k) \mid \theta_{j t}(k), \boldsymbol{Z}^{k}\right], \quad j=0,1, \cdots, m_{k}</script>即<script type="math/tex; mode=display">
\hat{\boldsymbol{X}}_j^t(k \mid k)=\hat{\boldsymbol{X}}^t(k \mid k-1)+\boldsymbol{K}(k)\left(\boldsymbol{Z}_j(k)-\hat{\boldsymbol{Z}}^t(k \mid k-1)\right)</script></li>
<li></li>
</ol>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{P}^{t}(k \mid k) &=\boldsymbol{P}^{t}(k \mid k-1)-\left(1-\beta_{0 t}(k)\right) \boldsymbol{K}^{t}(k) \boldsymbol{S}^{t}(k) \boldsymbol{K}^{t^{\prime}}(k) \\
&+\sum_{j=0}^{m_{k}} \beta_{j t}(k) \hat{\boldsymbol{X}}_{j}^{t}(k \mid k) \hat{\boldsymbol{X}}_{j}^{t^{\prime}}(k \mid k)-\hat{\boldsymbol{X}}^{t}(k \mid k) \hat{\boldsymbol{X}}^{t^{\prime}}(k \mid k)
\end{aligned}</script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">YXY</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Mr-Bulijiojio" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Mr-Bulijiojio" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/frompyrmaidinside@gmail.com" title="E-Mail → frompyrmaidinside@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YXY</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
